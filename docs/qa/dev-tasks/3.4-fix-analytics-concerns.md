# Dev Task: Fix Search Analytics Test Concerns

## Overview

**Story**: 3.4 - Search Analytics & Optimization  
**QA Gate**: CONCERNS (Quality Score: 80/100)  
**Priority**: Medium  
**Estimated Effort**: 6-8 hours

## Background

The search analytics implementation is functionally complete with all acceptance criteria met, but several test-related concerns were identified during QA review that need to be addressed to improve code quality and reliability.

## Critical Issues to Fix

### 1. Fix Test Mocking Issues (HIGH PRIORITY)

**Problem**: Test suite has complex mocking issues preventing reliable test execution
**Files**: `__tests__/analytics/useSearchAnalytics.test.ts`, `__tests__/analytics/search-analytics.test.ts`

**Current Issues**:

- Tests are calling real service methods instead of mocked ones
- Supabase client mocking is incomplete
- Fetch mocking needs proper response structure
- Hook tests expect mocked service calls but hook uses real service

**Tasks**:

- [ ] Refactor test mocking strategy to properly isolate service dependencies
- [ ] Fix Supabase client mocking to handle all database operations
- [ ] Ensure fetch mocking provides consistent response structure
- [ ] Update hook tests to test actual behavior rather than service calls
- [ ] Add proper error scenario testing
- [ ] Verify all tests pass without console errors

**Acceptance Criteria**:

- All analytics tests pass without errors
- No console errors during test execution
- Proper isolation between test and production code
- Test coverage ≥ 80% for analytics components

### 2. Add Integration Tests for API Endpoints (MEDIUM PRIORITY)

**Problem**: Missing integration tests for analytics API endpoints
**Files**: `app/api/analytics/` (all endpoints)

**Tasks**:

- [ ] Create integration tests for all 8 analytics API endpoints:
  - `GET /api/analytics/search/queries`
  - `GET /api/analytics/search/filters`
  - `GET /api/analytics/search/clickthrough`
  - `GET /api/analytics/search/trending`
  - `GET /api/analytics/search/behavior`
  - `GET /api/analytics/search/engagement`
  - `GET /api/analytics/performance/search`
  - `GET /api/analytics/performance/infinite-scroll`
- [ ] Test authentication and authorization flows
- [ ] Test error scenarios and edge cases
- [ ] Test data validation and parameter handling
- [ ] Test response format and status codes
- [ ] Test with different user roles (admin vs non-admin)

**Acceptance Criteria**:

- Integration tests for all 8 analytics API endpoints
- Tests cover success and error scenarios
- Tests verify proper authentication/authorization
- Tests validate response formats and status codes

### 3. Add Error Boundary Components (LOW PRIORITY)

**Problem**: Analytics UI components lack error boundaries
**Files**: `components/features/analytics/`

**Tasks**:

- [ ] Create error boundary component for analytics dashboard
- [ ] Add error boundaries to individual analytics components
- [ ] Implement retry mechanisms for failed data fetches
- [ ] Add user-friendly error messages
- [ ] Test error boundary behavior

**Acceptance Criteria**:

- Error boundaries prevent analytics UI crashes
- Users see helpful error messages instead of blank screens
- Retry mechanisms allow recovery from temporary failures

### 4. Implement Rate Limiting (LOW PRIORITY)

**Problem**: Analytics endpoints lack rate limiting
**Files**: `app/api/analytics/`

**Tasks**:

- [ ] Add rate limiting middleware for analytics endpoints
- [ ] Configure appropriate limits for different endpoint types
- [ ] Add rate limit headers to responses
- [ ] Test rate limiting behavior
- [ ] Document rate limiting in API documentation

**Acceptance Criteria**:

- Rate limiting prevents abuse of analytics endpoints
- Appropriate limits configured for different endpoint types
- Rate limit information provided in response headers

## Implementation Guidelines

### Test Mocking Strategy

1. **Service Layer Mocking**: Mock the `searchAnalyticsService` at the module level
2. **Database Mocking**: Use comprehensive Supabase client mocks
3. **API Mocking**: Mock fetch responses with proper structure
4. **Hook Testing**: Test hook behavior, not service implementation details

### Example Mock Structure

```typescript
// Mock Supabase client
jest.mock('@/lib/supabase/client', () => ({
  createClient: jest.fn(() => ({
    from: jest.fn(() => ({
      insert: jest.fn(() => ({
        select: jest.fn(() => ({
          single: jest.fn(() => ({
            data: { id: 'test-id' },
            error: null,
          })),
        })),
      })),
      // Add other methods as needed
    })),
  })),
}));

// Mock fetch responses
global.fetch = jest.fn(() =>
  Promise.resolve({
    json: () =>
      Promise.resolve({
        queries: [],
        filters: [],
        // ... other expected response structure
      }),
  })
);
```

### Integration Test Structure

```typescript
describe('Analytics API Integration', () => {
  beforeEach(() => {
    // Setup test database state
    // Mock authentication
  });

  describe('GET /api/analytics/search/queries', () => {
    it('should return query analytics for admin users', async () => {
      // Test implementation
    });

    it('should return 403 for non-admin users', async () => {
      // Test implementation
    });

    it('should handle invalid parameters', async () => {
      // Test implementation
    });
  });
});
```

## Testing Checklist

- [ ] All existing tests pass
- [ ] New integration tests pass
- [ ] Error boundary tests pass
- [ ] Rate limiting tests pass
- [ ] No console errors during test execution
- [ ] Test coverage meets 80% threshold
- [ ] All edge cases covered

## Files to Modify

### Test Files

- `__tests__/analytics/useSearchAnalytics.test.ts`
- `__tests__/analytics/search-analytics.test.ts`
- `__tests__/analytics/api-integration.test.ts` (new)

### Component Files

- `components/features/analytics/ErrorBoundary.tsx` (new)
- `components/features/analytics/SearchAnalyticsDashboard.tsx`

### API Files

- `app/api/analytics/` (add rate limiting middleware)

### Utility Files

- `lib/rate-limiting.ts` (new)

## Success Criteria

1. **Test Reliability**: All tests pass consistently without flaky behavior
2. **Test Coverage**: ≥80% coverage for analytics components and services
3. **Error Handling**: Robust error boundaries and user-friendly error messages
4. **Performance**: Rate limiting prevents abuse while maintaining functionality
5. **Documentation**: Clear test documentation and error handling guides

## Notes

- Focus on test reliability first - this is the highest priority
- Integration tests should use a test database or proper mocking
- Error boundaries should be user-friendly and provide recovery options
- Rate limiting should be configurable and not overly restrictive
- All changes should maintain backward compatibility

## Dependencies

- Jest testing framework
- React Testing Library
- Supabase test client
- Next.js API testing utilities

## Timeline

- **Day 1**: Fix test mocking issues
- **Day 2**: Add integration tests
- **Day 3**: Implement error boundaries and rate limiting
- **Day 4**: Testing and documentation

This task will bring the search analytics implementation to production-ready quality with comprehensive test coverage and robust error handling.
