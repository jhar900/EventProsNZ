# Dev Task: Fix Map Clustering API Test Failures

## Overview

**Story**: 4.2 - Map Clustering & Interaction  
**Priority**: High  
**Estimated Effort**: 2-4 hours  
**Assigned To**: Dev Agent  
**Due Date**: Next Sprint

## Problem Statement

The map clustering implementation is functionally complete and meets all acceptance criteria, but **3 out of 85 tests are failing** in the API test suite due to NextRequest mocking issues. This prevents full verification of the API endpoints and blocks the story from being marked as Done.

## Current Test Status

- ✅ **82 tests passing** (96.5% pass rate)
- ❌ **3 tests failing** in `__tests__/map/clustering/map-clustering-api.test.ts`
- ✅ All component and service tests passing
- ✅ Core clustering functionality verified

## Failing Tests

### 1. POST /api/map/interactions - should record interaction successfully

- **Error**: `TypeError: request.json is not a function`
- **Location**: `app/api/map/interactions/route.ts:12:32`
- **Test**: `__tests__/map/clustering/map-clustering-api.test.ts:334:45`

### 2. POST /api/map/interactions - should return 400 for missing required fields

- **Error**: `TypeError: request.json is not a function`
- **Location**: `app/api/map/interactions/route.ts:12:32`
- **Test**: `__tests__/map/clustering/map-clustering-api.test.ts:353:45`

### 3. POST /api/map/interactions - should handle anonymous interactions

- **Error**: `TypeError: request.json is not a function`
- **Location**: `app/api/map/interactions/route.ts:12:32`
- **Test**: `__tests__/map/clustering/map-clustering-api.test.ts:391:45`

## Root Cause Analysis

The issue is that the NextRequest mock in the test suite is not properly implementing the `json()` method. The API code calls `await request.json()` but the mock object doesn't have this method, causing the tests to fail.

## Required Fixes

### 1. Fix NextRequest Mock Implementation

The current mock in `jest.setup.js` and the test file needs to be updated to properly handle the `json()` method:

```javascript
// Current implementation (incomplete)
global.NextRequest = class NextRequest {
  constructor(input, init) {
    this.url = input;
    this.method = init?.method || 'GET';
    this.headers = new Headers(init?.headers);
    this.body = init?.body;
  }

  async json() {
    return JSON.parse(this.body);
  }
};
```

**Issue**: The mock is defined but not being used by the actual API code during testing.

### 2. Ensure Mock is Applied to API Code

The API code imports NextRequest from 'next/server', but the mock needs to be applied before the module is loaded. Consider:

- Moving the mock to the top of the test file
- Using `jest.doMock()` to ensure the mock is applied
- Or modifying the API code to be more testable

### 3. Verify Mock Behavior

The mock should:

- Properly parse JSON from the request body
- Handle both valid and invalid JSON
- Return the expected data structure for the tests

## Implementation Steps

### Step 1: Update Test File Mock

```javascript
// At the top of __tests__/map/clustering/map-clustering-api.test.ts
jest.mock('next/server', () => ({
  NextRequest: class NextRequest {
    constructor(input, init) {
      this.url = input;
      this.method = init?.method || 'GET';
      this.headers = new Headers(init?.headers);
      this.body = init?.body;
    }

    async json() {
      if (!this.body) {
        throw new Error('No body to parse');
      }
      return JSON.parse(this.body);
    }

    async text() {
      return this.body;
    }
  },
  NextResponse: {
    json: (data, init) => ({
      json: () => Promise.resolve(data),
      status: init?.status || 200,
    }),
  },
}));
```

### Step 2: Test the Fix

```bash
npm test -- --testPathPattern="map/clustering" --verbose
```

### Step 3: Verify All Tests Pass

- All 85 tests should pass
- No console errors related to NextRequest
- API endpoints should return expected responses

## Expected Outcome

After implementing the fix:

- ✅ All 85 tests passing (100% pass rate)
- ✅ API endpoints properly tested
- ✅ Story can be marked as Done
- ✅ Quality gate can be updated to PASS

## Testing Checklist

- [ ] Run the full test suite for map clustering
- [ ] Verify no console errors in test output
- [ ] Check that API responses match expected format
- [ ] Confirm all test assertions pass
- [ ] Run tests multiple times to ensure stability

## Files to Modify

1. `__tests__/map/clustering/map-clustering-api.test.ts` - Update NextRequest mock
2. `jest.setup.js` - May need updates to global mock (if used)

## Success Criteria

- [ ] All 3 failing tests now pass
- [ ] No new test failures introduced
- [ ] Test suite runs cleanly without errors
- [ ] API functionality verified through tests

## Notes

- The implementation itself is correct and functional
- This is purely a test infrastructure issue
- The API endpoints work correctly in the actual application
- Once fixed, this will be a high-quality, fully-tested feature

## Related Files

- `app/api/map/interactions/route.ts` - The API being tested
- `app/api/map/clusters/route.ts` - Working API (for reference)
- `app/api/map/contractors/[id]/preview/route.ts` - Working API (for reference)
- `__tests__/map/clustering/map-clustering-api.test.ts` - Test file to fix

---

**QA Review**: This task addresses the critical test failures identified in the quality gate review. Once completed, the story will be ready for final approval and can be marked as Done.
