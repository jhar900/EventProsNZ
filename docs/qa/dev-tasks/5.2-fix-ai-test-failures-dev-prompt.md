# Dev Agent Prompt: Fix AI Test Failures

## Context

The AI-powered service recommendations story (5.2) has been reviewed by the Test Architect and received a **CONCERNS** gate status due to critical test failures. The implementation is excellent, but 147 test failures prevent production readiness.

## Current Status

- **Gate Status:** CONCERNS
- **Quality Score:** 65/100
- **Test Failures:** 147 failures in AI components
- **Implementation Quality:** Excellent (all 10 ACs implemented)

## Root Cause Analysis

The test failures stem from components being stuck in loading states during tests. Key issues:

1. **Test mocks don't properly simulate API responses**
2. **Async operations in tests aren't being handled correctly**
3. **Component props interfaces have changed but tests weren't updated**

## Specific Issues to Fix

### 1. UserPreferencesPanel Test Failures

**File:** `__tests__/ai/components/UserPreferencesPanel.test.tsx`

**Problems:**

- Component shows loading spinner instead of expected content
- Tests expect specific UI elements that only appear after loading completes
- Mock props don't match actual component interface

**Expected Behavior:**

- Component should render preference forms after loading
- Tests should find elements like "Location", "Price Sensitivity", "Reset to Defaults"
- Component should show "User Preferences" title and preference sections

**Current Component Interface:**

```typescript
interface UserPreferencesPanelProps {
  onClose: () => void;
  className?: string;
}
```

**Test Mock Issues:**

- Tests pass props like `preferences`, `onUpdatePreferences`, `onResetPreferences`
- But component expects `onClose` callback
- Component loads preferences internally via API calls

### 2. ServiceTemplates Test Failures

**File:** `__tests__/ai/components/ServiceTemplates.test.tsx`

**Problems:**

- Component shows loading spinner instead of template content
- Tests expect "Service Templates" title and template cards
- Mock props don't match actual component interface

**Expected Behavior:**

- Component should render template cards after loading
- Tests should find "Wedding Package", "Corporate Event Package" templates
- Component should show template information and action buttons

**Current Component Interface:**

```typescript
interface ServiceTemplatesProps {
  eventType: string;
  onTemplateSelect?: (template: ServiceTemplate) => void;
  onTemplateCreate?: (template: ServiceTemplate) => void;
  className?: string;
}
```

## Required Fixes

### 1. Fix Test Mocks and Async Handling

**For UserPreferencesPanel:**

- Mock the `/api/ai/user-preferences` API endpoint
- Ensure component receives proper mock data to exit loading state
- Update test props to match actual component interface
- Add proper `waitFor` calls for async operations

**For ServiceTemplates:**

- Mock the `/api/ai/service-templates` API endpoint
- Provide mock template data to exit loading state
- Update test props to match actual component interface
- Handle async template loading properly

### 2. Update Test Data Setup

**Create proper mock data:**

```typescript
// Mock user preferences data
const mockUserPreferences = [
  {
    id: '1',
    user_id: 'user123',
    preference_type: 'service_preferences',
    preference_data: {
      budget_preferences: {
        min_budget: 1000,
        max_budget: 10000,
        budget_priority: 'medium',
      },
      quality_preferences: {
        min_rating: 3,
        verified_only: false,
        premium_preferred: false,
      },
    },
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-01-15T10:00:00Z',
  },
];

// Mock service templates data
const mockServiceTemplates = [
  {
    id: '1',
    name: 'Wedding Package',
    event_type: 'wedding',
    services: [
      {
        service_category: 'Photography',
        priority: 5,
        is_required: true,
        estimated_cost_percentage: 0.15,
      },
      {
        service_category: 'Catering',
        priority: 5,
        is_required: true,
        estimated_cost_percentage: 0.3,
      },
    ],
    is_public: true,
    created_at: '2024-01-15T10:00:00Z',
    updated_at: '2024-01-15T10:00:00Z',
  },
];
```

### 3. Fix API Mocking

**Add proper fetch mocks:**

```typescript
// Mock fetch for API calls
global.fetch = jest.fn();

// Mock successful API responses
(fetch as jest.Mock).mockImplementation((url: string) => {
  if (url.includes('/api/ai/user-preferences')) {
    return Promise.resolve({
      ok: true,
      json: () => Promise.resolve({ preferences: mockUserPreferences }),
    });
  }
  if (url.includes('/api/ai/service-templates')) {
    return Promise.resolve({
      ok: true,
      json: () => Promise.resolve({ templates: mockServiceTemplates }),
    });
  }
  return Promise.reject(new Error('Unmocked API call'));
});
```

### 4. Update Test Assertions

**Fix test expectations:**

- Wait for loading states to complete before assertions
- Use proper `waitFor` calls for async operations
- Update element selectors to match actual rendered content
- Test actual component behavior, not mock behavior

## Implementation Steps

1. **Update UserPreferencesPanel tests:**
   - Fix component props to match interface
   - Add proper API mocking
   - Update test assertions for async behavior
   - Ensure tests wait for loading completion

2. **Update ServiceTemplates tests:**
   - Fix component props to match interface
   - Add proper API mocking
   - Update test assertions for async behavior
   - Ensure tests wait for loading completion

3. **Run tests to verify fixes:**

   ```bash
   npm test -- --testPathPattern="ai" --verbose
   ```

4. **Ensure all 147 test failures are resolved**

## Success Criteria

- [ ] All AI component tests pass
- [ ] No test failures in `__tests__/ai/` directory
- [ ] Components render expected content in test environment
- [ ] Async operations handled properly in tests
- [ ] Test mocks match actual component interfaces

## Files to Modify

- `__tests__/ai/components/UserPreferencesPanel.test.tsx`
- `__tests__/ai/components/ServiceTemplates.test.tsx`
- Any other failing test files in `__tests__/ai/`

## Notes

- The component implementations are correct and well-written
- The issue is purely with test setup and mocking
- Focus on making tests match the actual component behavior
- Don't modify the component implementations unless absolutely necessary

## Expected Outcome

After fixing these test issues, the story should receive a **PASS** gate status and be ready for production deployment. The implementation quality is already excellent - we just need the tests to properly validate the functionality.
