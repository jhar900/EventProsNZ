# Dev Task: Fix AI Test Failures - Story 5.2

## Task Overview

**Story**: 5.2 - AI-Powered Service Recommendations  
**Priority**: HIGH - Blocking production deployment  
**Estimated Effort**: 4-6 hours  
**Assigned**: Dev Agent  
**Created**: 2025-01-12  
**Status**: Ready for Development

## Problem Statement

The AI service recommendations implementation is architecturally excellent with all 10 acceptance criteria met, but **21 test failures** are preventing production deployment. The test suite shows significant improvement (down from 35+ failures) but still has critical issues that need resolution.

## Current Test Status

```
Test Suites: 3 failed, 18 passed, 21 total
Tests:       21 failed, 228 passed, 249 total
```

## Critical Issues to Fix

### 1. EventTypeSuggestions Component Tests (High Priority)

**File**: `__tests__/ai/components/EventTypeSuggestions.test.tsx`

**Issues**:

- Missing suggestion cards in test output
- Component mocking issues with `EventTypeSuggestionEngine`
- Async operation handling failures
- Test selectors not finding expected elements

**Specific Failures**:

```typescript
// Lines 199-206: Missing suggestion cards
expect(screen.getAllByTestId('suggestion-card')).toHaveLength(2);
// Lines 261-370: Async operation handling
await waitFor(() => {
  expect(screen.getByText('wedding')).toBeInTheDocument();
});
```

**Required Fixes**:

1. Update mock implementation for `EventTypeSuggestionEngine`
2. Fix async operation handling in test environment
3. Ensure suggestion cards render with proper `data-testid` attributes
4. Add proper timeout handling for async operations

### 2. ServiceTemplates Component Tests (High Priority)

**File**: `__tests__/ai/components/ServiceTemplates.test.tsx`

**Issues**:

- Multiple elements with same text causing selector ambiguity
- "Catering" text appears multiple times
- "Use Template" buttons not uniquely identifiable
- Template stats display issues

**Specific Failures**:

```typescript
// Line 115: Multiple "Catering" elements
expect(screen.getByText('Catering')).toBeInTheDocument();
// Line 141: Multiple "Use Template" buttons
const useTemplateButton = screen.getByText('Use Template');
// Line 194: Multiple "3" elements
expect(screen.getByText('3')).toBeInTheDocument();
```

**Required Fixes**:

1. Add unique `data-testid` attributes to all interactive elements
2. Use more specific selectors (e.g., `getByTestId` instead of `getByText`)
3. Update component to include proper test identifiers
4. Fix template stats display to avoid duplicate values

### 3. AI Learning Engine Tests (Medium Priority)

**File**: `__tests__/ai/learning-engine.test.ts`

**Issues**:

- Learning statistics not properly tracked
- Insight filtering not working correctly
- Seasonal analysis returning undefined values
- Event pattern analysis failing

**Specific Failures**:

```typescript
// Line 298: Learning stats undefined
expect(stats.totalInteractions).toBe(2);
// Line 350: Seasonal insights undefined
expect(seasonalInsights.length).toBeGreaterThan(0);
// Line 405: Event pattern insights undefined
expect(eventPatternInsights.length).toBeGreaterThan(0);
```

**Required Fixes**:

1. Fix learning statistics tracking in `AILearningEngine`
2. Implement proper insight filtering methods
3. Add seasonal analysis functionality
4. Fix event pattern recognition

## Implementation Strategy

### Phase 1: Component Test Fixes (2-3 hours)

1. **Update EventTypeSuggestions Component**:

   ```typescript
   // Add data-testid attributes
   <div data-testid="suggestion-card" key={suggestion.id}>
     <h3>{suggestion.eventType}</h3>
   </div>
   ```

2. **Update ServiceTemplates Component**:

   ```typescript
   // Add unique test identifiers
   <button data-testid={`use-template-${template.id}`}>
     Use Template
   </button>
   <span data-testid={`service-${service.id}`}>
     {service.name}
   </span>
   ```

3. **Fix Test Selectors**:
   ```typescript
   // Replace generic selectors with specific ones
   const useTemplateButton = screen.getByTestId('use-template-1');
   const cateringService = screen.getByTestId('service-catering');
   ```

### Phase 2: Learning Engine Fixes (1-2 hours)

1. **Fix Learning Statistics**:

   ```typescript
   // Ensure proper tracking in AILearningEngine
   getLearningStats(): LearningStats {
     return {
       totalInteractions: this.interactions.length,
       totalInsights: this.insights.length,
       // ... other stats
     };
   }
   ```

2. **Implement Insight Filtering**:
   ```typescript
   getInsights(type?: string): Insight[] {
     let filtered = this.insights;
     if (type) {
       filtered = this.insights.filter(insight => insight.type === type);
     }
     return filtered;
   }
   ```

### Phase 3: Test Environment Fixes (1 hour)

1. **Fix Async Operations**:

   ```typescript
   // Add proper timeout handling
   await waitFor(
     () => {
       expect(screen.getByTestId('suggestion-card')).toBeInTheDocument();
     },
     { timeout: 5000 }
   );
   ```

2. **Update Mock Implementations**:
   ```typescript
   // Ensure mocks return proper data structures
   mockEventTypeSuggestionEngine.suggestEventType.mockResolvedValue([
     { id: '1', eventType: 'wedding', confidence: 0.9 },
     { id: '2', eventType: 'corporate', confidence: 0.8 },
   ]);
   ```

## Test Files to Update

### Primary Files:

- `__tests__/ai/components/EventTypeSuggestions.test.tsx`
- `__tests__/ai/components/ServiceTemplates.test.tsx`
- `__tests__/ai/learning-engine.test.ts`

### Component Files:

- `components/features/ai/EventTypeSuggestions.tsx`
- `components/features/ai/ServiceTemplates.tsx`
- `lib/ai/learning-service.ts`

## Success Criteria

1. **All 21 test failures resolved**
2. **Test suite passes completely** (249/249 tests passing)
3. **No regressions** in existing functionality
4. **Proper test coverage** maintained
5. **Component functionality** unchanged

## Testing Commands

```bash
# Run AI tests specifically
npm test -- --testPathPattern="ai" --verbose

# Run specific test files
npm test -- __tests__/ai/components/EventTypeSuggestions.test.tsx
npm test -- __tests__/ai/components/ServiceTemplates.test.tsx
npm test -- __tests__/ai/learning-engine.test.ts

# Run with coverage
npm test -- --testPathPattern="ai" --coverage
```

## Expected Outcomes

After completing this task:

1. **Quality Gate**: CONCERNS â†’ PASS
2. **Test Coverage**: 100% passing (249/249)
3. **Production Ready**: Yes
4. **Story Status**: Ready for Done

## Notes

- The implementation architecture is excellent - no code restructuring needed
- Focus on test fixes, not functionality changes
- Maintain all existing component behavior
- Ensure proper error handling in tests
- Add comprehensive test documentation

## Dependencies

- Story 5.2 implementation (already complete)
- AI components and services (already implemented)
- Test framework setup (already configured)

## Risk Assessment

**Low Risk**: Only test fixes required, no functional changes needed. The implementation is architecturally sound and all acceptance criteria are met.

---

**Next Steps**: Begin with Phase 1 component test fixes, then proceed to learning engine fixes. Test frequently to ensure no regressions are introduced.
