# Dev Task: Fix AI Recommendations Test Failures

## Overview

**Story**: 5.2 - AI-Powered Service Recommendations  
**Gate Status**: CONCERNS  
**Priority**: High  
**Estimated Effort**: 1-2 days

## Background

The AI service recommendations implementation has comprehensive feature coverage and excellent architecture, but 147 test failures prevent production readiness. The QA review identified that all acceptance criteria are met, but test failures indicate potential reliability issues that must be resolved.

## Critical Issues to Fix

### 1. Test Failures (High Priority)

- **Issue**: 147 test failures across AI components
- **Impact**: Components not rendering correctly in test environment, potential production issues
- **Root Cause**: Component mocking issues, async operation handling, and test data setup problems

**Action Required**:

```bash
# Run tests to see current failures
npm test -- __tests__/ai --passWithNoTests

# Focus on these critical test files:
npm test -- __tests__/ai/components/ServiceRecommendations.test.tsx
npm test -- __tests__/ai/components/AITestingPanel.test.tsx
npm test -- __tests__/ai/components/RecommendationAnalytics.test.tsx
npm test -- __tests__/ai/components/UserPreferencesManager.test.tsx
```

### 2. Component Mocking Issues (High Priority)

- **Issue**: Test mocks don't match actual component interfaces
- **Impact**: Tests fail to render components correctly
- **Files Affected**: All test files in `__tests__/ai/components/`

**Action Required**:

```typescript
// Example fix for ServiceRecommendations.test.tsx
// Update mocks to match actual component props and behavior
jest.mock('@/components/features/ai/ServiceCategorySuggestions', () => ({
  ServiceCategorySuggestions: ({ recommendations, onFeedback }: any) => (
    <div data-testid="service-category-suggestions">
      {recommendations?.map((rec: any) => (
        <div key={rec.id} data-testid={`recommendation-${rec.id}`}>
          <span>{rec.service_category}</span>
          <button
            onClick={() => onFeedback?.(rec.id, 'positive', 5)}
            data-testid={`feedback-${rec.id}`}
          >
            Give Feedback
          </button>
        </div>
      ))}
    </div>
  ),
}));
```

### 3. Async Operation Handling (Medium Priority)

- **Issue**: Tests don't properly handle async operations
- **Impact**: Tests timeout or fail to wait for component updates
- **Files Affected**: Components with async data loading

**Action Required**:

```typescript
// Example fix for async operations
it('should display recommendations after loading', async () => {
  render(<ServiceRecommendations />);

  // Wait for loading to complete
  await waitFor(() => {
    expect(screen.queryByText('Loading...')).not.toBeInTheDocument();
  });

  // Then check for recommendations
  await waitFor(() => {
    expect(screen.getByTestId('service-category-suggestions')).toBeInTheDocument();
  });
});
```

### 4. Test Data Setup (Medium Priority)

- **Issue**: Missing or incorrect test data setup
- **Impact**: Components don't render expected content
- **Files Affected**: All component tests

**Action Required**:

```typescript
// Ensure proper test data setup
const mockRecommendations = [
  {
    id: 'rec-1',
    service_category: 'Photography',
    priority: 5,
    confidence_score: 0.85,
    estimated_cost: 2000,
    reasoning: 'Essential for capturing memories',
  },
  // ... more test data
];

// Mock the hook with proper data
const mockUseAIRecommendations = {
  recommendations: mockRecommendations,
  isLoading: false,
  error: null,
  // ... other required properties
};
```

## Step-by-Step Fix Plan

### Phase 1: Fix Core Component Tests (Day 1)

1. **Fix ServiceRecommendations Component**

   ```bash
   npm test -- __tests__/ai/components/ServiceRecommendations.test.tsx
   ```

   - Update mocks to match actual component interfaces
   - Fix async operation handling
   - Ensure proper test data setup

2. **Fix AITestingPanel Component**

   ```bash
   npm test -- __tests__/ai/components/AITestingPanel.test.tsx
   ```

   - Fix component rendering issues
   - Update mock implementations
   - Handle async data loading

3. **Fix RecommendationAnalytics Component**

   ```bash
   npm test -- __tests__/ai/components/RecommendationAnalytics.test.tsx
   ```

   - Fix tab navigation tests
   - Update mock data structures
   - Handle async operations

### Phase 2: Fix Remaining Component Tests (Day 1-2)

4. **Fix UserPreferencesManager Component**

   ```bash
   npm test -- __tests__/ai/components/UserPreferencesManager.test.tsx
   ```

5. **Fix ServiceCustomization Component**

   ```bash
   npm test -- __tests__/ai/components/ServiceCustomization.test.tsx
   ```

6. **Fix ContractorRecommendations Component**
   ```bash
   npm test -- __tests__/ai/components/ContractorRecommendations.test.tsx
   ```

### Phase 3: Fix API and Hook Tests (Day 2)

7. **Fix API Tests**

   ```bash
   npm test -- __tests__/ai/api/
   ```

8. **Fix Hook Tests**
   ```bash
   npm test -- __tests__/ai/hooks/
   ```

## Common Test Issues and Solutions

### Issue 1: Component Not Rendering

**Problem**: `Unable to find an element with the text: "Expected Text"`

**Solution**:

```typescript
// Check if component is actually rendering
screen.debug(); // Add this to see what's rendered

// Wait for async operations
await waitFor(() => {
  expect(screen.getByText('Expected Text')).toBeInTheDocument();
});
```

### Issue 2: Mock Not Working

**Problem**: Mocked component not being used

**Solution**:

```typescript
// Ensure mock is defined before the test
jest.mock('@/components/features/ai/ComponentName', () => ({
  ComponentName: ({ prop1, prop2 }: any) => (
    <div data-testid="mocked-component">
      <span>{prop1}</span>
      <span>{prop2}</span>
    </div>
  ),
}));
```

### Issue 3: Async Operations Failing

**Problem**: Tests timing out on async operations

**Solution**:

```typescript
// Use proper async/await patterns
it('should handle async operations', async () => {
  render(<Component />);

  // Wait for loading to complete
  await waitFor(() => {
    expect(screen.queryByText('Loading...')).not.toBeInTheDocument();
  });

  // Then test the loaded state
  expect(screen.getByText('Loaded Content')).toBeInTheDocument();
});
```

## Testing Strategy

### Unit Tests

```bash
# Run individual test suites
npm test -- __tests__/ai/components/ServiceRecommendations.test.tsx
npm test -- __tests__/ai/hooks/useAIRecommendations.test.ts
```

### Integration Tests

```bash
# Test API endpoints
npm test -- __tests__/ai/api/
```

### Manual Testing

1. Test AI recommendations in browser
2. Verify user preferences are saved
3. Check A/B testing functionality
4. Validate learning data persistence

## Success Criteria

- [ ] All 147 test failures resolved
- [ ] Components render correctly in test environment
- [ ] All async operations handled properly
- [ ] Test mocks match actual component interfaces
- [ ] All AI features work end-to-end
- [ ] Test coverage maintained or improved

## Files to Modify

### High Priority

- `__tests__/ai/components/ServiceRecommendations.test.tsx`
- `__tests__/ai/components/AITestingPanel.test.tsx`
- `__tests__/ai/components/RecommendationAnalytics.test.tsx`
- `__tests__/ai/components/UserPreferencesManager.test.tsx`

### Medium Priority

- `__tests__/ai/components/ServiceCustomization.test.tsx`
- `__tests__/ai/components/ContractorRecommendations.test.tsx`
- `__tests__/ai/api/ab-testing.test.ts`
- `__tests__/ai/api/service-recommendations.test.ts`
- `__tests__/ai/hooks/useAIRecommendations.test.ts`

## Notes

- The implementation architecture is excellent - focus on fixing the test issues
- All acceptance criteria are met in terms of functionality
- Once tests are fixed, the system will be production-ready
- Consider adding error monitoring for AI operations in production

## Quality Gate Target

**Goal**: Move from CONCERNS to PASS status  
**Requirements**: All test failures resolved, components rendering correctly, async operations working

## Reference

- **QA Review**: `docs/stories/5.2.ai-powered-service-recommendations.md` (QA Results section)
- **Quality Gate**: `docs/qa/gates/5.2-ai-powered-service-recommendations.yml`
- **Original Dev Task**: `docs/qa/dev-tasks/5.2-fix-ai-recommendations-concerns.md`
