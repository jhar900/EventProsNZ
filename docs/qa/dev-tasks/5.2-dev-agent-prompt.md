# Dev Agent Prompt: Fix AI Recommendations Quality Concerns

## Overview

**Story**: 5.2 - AI-Powered Service Recommendations  
**Gate Status**: CONCERNS  
**Priority**: High  
**Estimated Effort**: 2-3 days

## Background

The AI service recommendations implementation has comprehensive feature coverage but contains critical issues preventing production readiness. The QA review identified 147 test failures and database schema mismatches that must be resolved.

## Critical Issues to Fix

### 1. Test Failures (High Priority)

- **Issue**: 147 test failures across AI components
- **Impact**: Components not rendering correctly, integration problems
- **Files Affected**: All test files in `__tests__/ai/`

**Action Required**:

```bash
# Run tests to see current failures
npm test -- __tests__/ai --passWithNoTests

# Fix component rendering issues
# Fix mock implementations
# Fix integration test failures
```

**Specific Test Issues to Address**:

1. **ServiceRecommendations.test.tsx**:
   - Missing `data-testid` attributes in components
   - Components not rendering expected elements
   - Mock implementations not matching actual component behavior

2. **AITestingPanel.test.tsx**:
   - Component rendering issues
   - Mock data not matching expected structure

3. **All AI component tests**:
   - Missing test data attributes
   - Incorrect mock implementations
   - Integration test failures

### 2. Database Schema Mismatches (High Priority)

- **Issue**: API endpoints reference non-existent database tables
- **Impact**: Runtime errors when accessing AI features
- **Files Affected**:
  - `app/api/ai/ab-testing/route.ts` (lines 148, 166, 306, 335)
  - `app/api/ai/analytics/route.ts` (line 415)

**Action Required**:

```typescript
// Change these table references:
// FROM: 'ab_tests' → TO: 'ai_ab_tests'
// FROM: 'ab_test_results' → TO: 'ai_ab_test_results'

// Check migration 012_ai_recommendations_tables.sql for correct table names
```

**Specific Changes Needed**:

1. **app/api/ai/ab-testing/route.ts**:
   - Line 148: `supabase.from('ai_ab_tests')` ✓ (already correct)
   - Line 166: `supabase.from('ai_ab_test_results')` ✓ (already correct)
   - Line 306: `supabase.from('ai_ab_tests')` ✓ (already correct)
   - Line 335: `supabase.from('ai_ab_test_results')` ✓ (already correct)

2. **app/api/ai/analytics/route.ts**:
   - Line 415: `supabase.from('ai_ab_test_results')` ✓ (already correct)

**Note**: The database schema appears to be correct. The issue may be that the tables don't exist in the database yet. Ensure migrations 012 and 013 have been run.

### 3. Learning Engine Storage (Medium Priority)

- **Issue**: Learning engine uses in-memory storage instead of database
- **Impact**: Learning data not persisted across sessions
- **Files Affected**: `lib/ai/learning-engine.ts`

**Action Required**:

```typescript
// Implement database integration for:
// - Learning data storage
// - Pattern recognition results
// - User behavior tracking
// - Recommendation improvements
```

**Current Status**: The learning engine has been updated to use database storage, but some methods may still use in-memory storage. Review and ensure all methods use database storage.

### 4. Missing Caching (Medium Priority)

- **Issue**: AI recommendations not using caching system
- **Impact**: Performance degradation
- **Files Affected**:
  - `app/api/ai/service-recommendations/route.ts`
  - `lib/ai/cache.ts` (exists but not used)

**Action Required**:

```typescript
// Implement caching in service recommendations endpoint
// Use existing aiCache from lib/ai/cache.ts
// Add cache invalidation when recommendations are updated
```

## Implementation Steps

### Step 1: Fix Database Issues

1. Ensure migrations 012 and 013 have been run
2. Verify all database tables exist
3. Test API endpoints to ensure they work

### Step 2: Fix Test Failures

1. Run tests to identify specific failures
2. Fix component rendering issues
3. Update mock implementations
4. Add missing test data attributes
5. Fix integration test failures

### Step 3: Implement Caching

1. Add caching to service recommendations endpoint
2. Implement cache invalidation
3. Test caching behavior

### Step 4: Verify Learning Engine

1. Ensure all learning engine methods use database storage
2. Test learning data persistence
3. Verify pattern recognition works

## Testing Requirements

After fixes, ensure:

- All tests pass: `npm test -- __tests__/ai`
- API endpoints work correctly
- Caching functions properly
- Learning engine persists data

## Success Criteria

- [ ] All 147 test failures resolved
- [ ] Database schema issues fixed
- [ ] Caching implemented for recommendations
- [ ] Learning engine fully uses database storage
- [ ] All tests pass
- [ ] API endpoints work correctly

## Files to Focus On

### High Priority

- `__tests__/ai/components/ServiceRecommendations.test.tsx`
- `__tests__/ai/components/AITestingPanel.test.tsx`
- `app/api/ai/ab-testing/route.ts`
- `app/api/ai/analytics/route.ts`

### Medium Priority

- `app/api/ai/service-recommendations/route.ts`
- `lib/ai/learning-engine.ts`
- `lib/ai/cache.ts`

## Notes

- The implementation has excellent architecture and comprehensive features
- The issues are primarily integration and testing problems
- Once fixed, this will be a production-ready feature
- Focus on the high-priority items first

## Quality Gate Status

Current: CONCERNS  
Target: PASS  
Required: Fix all high-priority issues before production deployment
