# Dev Task: Fix AI Recommendations Quality Concerns

## Overview

**Story**: 5.2 - AI-Powered Service Recommendations  
**Gate Status**: CONCERNS  
**Priority**: High  
**Estimated Effort**: 2-3 days

## Background

The AI service recommendations implementation has comprehensive feature coverage but contains critical issues preventing production readiness. The QA review identified 147 test failures and database schema mismatches that must be resolved.

## Critical Issues to Fix

### 1. Test Failures (High Priority)

- **Issue**: 147 test failures across AI components
- **Impact**: Components not rendering correctly, integration problems
- **Files Affected**: All test files in `__tests__/ai/`

**Action Required**:

```bash
# Run tests to see current failures
npm test -- __tests__/ai --passWithNoTests

# Fix component rendering issues
# Fix mock implementations
# Fix integration test failures
```

### 2. Database Schema Mismatches (High Priority)

- **Issue**: API endpoints reference non-existent database tables
- **Impact**: Runtime errors when accessing AI features
- **Files Affected**:
  - `app/api/ai/ab-testing/route.ts` (lines 261, 288)
  - `app/api/ai/analytics/route.ts` (line 339)

**Action Required**:

```typescript
// Change these table references:
// FROM: 'ab_tests' → TO: 'ai_ab_tests'
// FROM: 'ab_test_results' → TO: 'ai_ab_test_results' (if this table exists)

// Check migration 012_ai_recommendations_tables.sql for correct table names
```

### 3. Learning Engine Storage (Medium Priority)

- **Issue**: Learning engine uses in-memory storage instead of database
- **Impact**: Learning data not persisted across sessions
- **Files Affected**: `lib/ai/learning-engine.ts`

**Action Required**:

```typescript
// Implement database integration for:
// - Learning data storage
// - Pattern recognition results
// - User behavior tracking
// - Recommendation improvements
```

### 4. Missing Caching (Medium Priority)

- **Issue**: No caching implementation for AI recommendations
- **Impact**: Performance degradation, unnecessary API calls
- **Files Affected**: `app/api/ai/service-recommendations/route.ts`

**Action Required**:

```typescript
// Implement caching for:
// - Service recommendations by event type
// - User preferences
// - Learning patterns
// - A/B test results
```

## Step-by-Step Fix Plan

### Phase 1: Database Schema Fixes (Day 1)

1. **Audit Database Tables**

   ```sql
   -- Check what tables actually exist
   SELECT table_name FROM information_schema.tables
   WHERE table_schema = 'public' AND table_name LIKE '%ai%';
   ```

2. **Fix API Endpoint Table References**
   - Update `app/api/ai/ab-testing/route.ts`
   - Update `app/api/ai/analytics/route.ts`
   - Ensure all table names match migration 012

3. **Create Missing Tables (if needed)**
   ```sql
   -- If ab_test_results table is missing, create it
   CREATE TABLE ai_ab_test_results (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     test_id UUID REFERENCES ai_ab_tests(id),
     user_id UUID REFERENCES users(id),
     variant TEXT NOT NULL,
     result_data JSONB NOT NULL,
     timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
   );
   ```

### Phase 2: Test Fixes (Day 1-2)

1. **Fix Component Tests**

   ```bash
   # Start with the most critical components
   npm test -- __tests__/ai/components/ServiceRecommendations.test.tsx
   npm test -- __tests__/ai/components/UserPreferencesManager.test.tsx
   ```

2. **Common Test Issues to Fix**:
   - Mock implementations not matching actual component props
   - Missing test data setup
   - Async operations not properly handled
   - Component rendering issues

3. **Fix API Tests**
   ```bash
   # Fix API endpoint tests
   npm test -- __tests__/ai/api/service-recommendations.test.ts
   npm test -- __tests__/ai/api/ab-testing.test.ts
   ```

### Phase 3: Learning Engine Integration (Day 2)

1. **Update Learning Engine**

   ```typescript
   // In lib/ai/learning-engine.ts
   // Replace in-memory storage with database calls
   // Use Supabase client for data persistence
   ```

2. **Implement Database Operations**:
   - Store learning data in `ai_learning_data` table
   - Update service patterns in `service_patterns` table
   - Store insights in `learning_insights` table

### Phase 4: Caching Implementation (Day 3)

1. **Add Recommendation Caching**

   ```typescript
   // In app/api/ai/service-recommendations/route.ts
   // Implement Redis or in-memory caching
   // Cache by event_type + user_id combination
   ```

2. **Cache Strategy**:
   - Cache recommendations for 1 hour
   - Invalidate on user preference changes
   - Cache learning patterns for 24 hours

## Testing Strategy

### Unit Tests

```bash
# Run individual test suites
npm test -- __tests__/ai/components/ServiceRecommendations.test.tsx
npm test -- __tests__/ai/hooks/useAIRecommendations.test.ts
```

### Integration Tests

```bash
# Test API endpoints
npm test -- __tests__/ai/api/
```

### Manual Testing

1. Test AI recommendations in browser
2. Verify user preferences are saved
3. Check A/B testing functionality
4. Validate learning data persistence

## Success Criteria

- [ ] All 147 test failures resolved
- [ ] Database schema mismatches fixed
- [ ] Learning engine uses persistent storage
- [ ] Caching implemented for recommendations
- [ ] All AI features work end-to-end
- [ ] Performance improved with caching

## Files to Modify

### High Priority

- `app/api/ai/ab-testing/route.ts`
- `app/api/ai/analytics/route.ts`
- `__tests__/ai/components/UserPreferencesManager.test.tsx`
- `__tests__/ai/components/ServiceRecommendations.test.tsx`

### Medium Priority

- `lib/ai/learning-engine.ts`
- `app/api/ai/service-recommendations/route.ts`
- `__tests__/ai/api/ab-testing.test.ts`
- `__tests__/ai/api/service-recommendations.test.ts`

## Database Migration (if needed)

If additional tables are required:

```sql
-- Add to migration file or create new migration
-- Example: Create ab_test_results table if missing
CREATE TABLE ai_ab_test_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  test_id UUID REFERENCES ai_ab_tests(id),
  user_id UUID REFERENCES users(id),
  variant TEXT NOT NULL,
  result_data JSONB NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Add indexes
CREATE INDEX idx_ai_ab_test_results_test_id ON ai_ab_test_results(test_id);
CREATE INDEX idx_ai_ab_test_results_user_id ON ai_ab_test_results(user_id);

-- Add RLS policies
ALTER TABLE ai_ab_test_results ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own test results" ON ai_ab_test_results
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own test results" ON ai_ab_test_results
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

## Notes

- The implementation architecture is solid - focus on fixing the integration issues
- All acceptance criteria are met in terms of functionality
- Once these issues are resolved, the system will be production-ready
- Consider adding error monitoring for AI operations in production

## Quality Gate Target

**Goal**: Move from CONCERNS to PASS status  
**Requirements**: All critical issues resolved, tests passing, database integration working
