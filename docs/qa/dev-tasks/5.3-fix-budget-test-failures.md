# Dev Task: Fix Budget Planning Test Failures and Performance Issues

## Overview

**Story**: 5.3 - Budget Planning & Recommendations  
**QA Status**: CONCERNS  
**Priority**: HIGH  
**Estimated Effort**: 4-6 hours

## Background

The budget planning implementation is functionally complete with comprehensive business logic, UI components, and API routes. However, there are test failures and performance concerns that need to be addressed before production deployment.

## Current Status

- ✅ **Database Schema**: Complete with all required tables and relationships
- ✅ **Business Logic**: BudgetService and PricingService with actual calculation algorithms
- ✅ **UI Components**: Well-structured React components with TypeScript interfaces
- ✅ **API Routes**: All endpoints with proper authentication and validation
- ✅ **Test Coverage**: 75 out of 81 tests passing (92.6% pass rate)
- ❌ **Test Failures**: 6 out of 81 tests failing
- ❌ **Performance**: No caching implemented for budget calculations

## Issues to Fix

### 1. API Route Parameter Parsing Issues (HIGH PRIORITY)

**Problem**: 6 API route tests are failing due to NextRequest constructor and URL parameter parsing issues in the test environment.

**Files Affected**:

- `__tests__/budget/budget-api.test.ts`

**Root Cause**: The NextRequest constructor in the test environment is not properly handling URL parameters, causing validation failures in the API routes.

**Solution**:

1. **Fix NextRequest Mock**: Update the NextRequest mock to properly handle URL parameter parsing
2. **Improve URL Parameter Handling**: Ensure the API routes can properly parse query parameters in test environment
3. **Add Better Error Logging**: Include validation error details in test output for debugging

**Implementation Steps**:

```typescript
// Fix the NextRequest mock in __tests__/budget/budget-api.test.ts
const mockNextRequest = (url: string) => {
  const urlObj = new URL(url);
  return {
    url,
    method: 'GET',
    json: jest.fn(),
    headers: new Map(),
    // Ensure proper searchParams handling
    get searchParams() {
      return urlObj.searchParams;
    },
  };
};
```

### 2. Performance Optimization - Add Caching (MEDIUM PRIORITY)

**Problem**: No caching implemented for budget calculations, which will impact performance with large datasets.

**Files Affected**:

- `lib/budget/budget-service.ts`
- `lib/budget/pricing-service.ts`

**Solution**:

1. **Implement Redis Caching**: Add Redis caching for budget calculations
2. **Cache Key Strategy**: Use event type, location, attendee count, and duration as cache keys
3. **Cache TTL**: Set appropriate TTL for different types of data (5 minutes for budget calculations, 10 minutes for pricing data)
4. **Cache Invalidation**: Implement cache invalidation when pricing data updates

**Implementation Steps**:

```typescript
// Add to BudgetService
private async getCachedCalculation(cacheKey: string): Promise<BudgetCalculation | null> {
  try {
    const cached = await this.redis.get(cacheKey);
    return cached ? JSON.parse(cached) : null;
  } catch (error) {
    console.error('Cache retrieval error:', error);
    return null;
  }
}

private async setCachedCalculation(cacheKey: string, data: BudgetCalculation): Promise<void> {
  try {
    await this.redis.setex(cacheKey, 300, JSON.stringify(data)); // 5 minutes TTL
  } catch (error) {
    console.error('Cache storage error:', error);
  }
}
```

### 3. Add Comprehensive Integration Tests (MEDIUM PRIORITY)

**Problem**: Database operations need integration testing for reliability.

**Files to Create**:

- `__tests__/budget/budget-integration.test.ts` (already exists but needs enhancement)
- `__tests__/budget/database-operations.test.ts`

**Solution**:

1. **Database Integration Tests**: Test actual database operations with test database
2. **End-to-End Workflows**: Test complete budget calculation workflows
3. **Error Scenarios**: Test database connection failures and recovery
4. **Performance Tests**: Test with large datasets

### 4. Improve Error Handling for Edge Cases (LOW PRIORITY)

**Problem**: Some edge cases may not be handled gracefully.

**Files Affected**:

- `app/api/budget/`
- `lib/budget/`

**Solution**:

1. **Add Input Validation**: Enhanced validation for edge cases
2. **Graceful Degradation**: Handle partial failures gracefully
3. **Better Error Messages**: More descriptive error messages for debugging
4. **Logging**: Add structured logging for better debugging

## Testing Strategy

### 1. Fix Existing Tests

```bash
# Run budget tests to verify fixes
npm test -- __tests__/budget/ --verbose

# Target specific failing tests
npm test -- __tests__/budget/budget-api.test.ts --verbose
```

### 2. Add New Tests

```bash
# Add integration tests
npm test -- __tests__/budget/budget-integration.test.ts --verbose

# Add performance tests
npm test -- __tests__/budget/budget-performance.test.ts --verbose
```

### 3. Performance Testing

```bash
# Run performance tests
npm run test:performance -- __tests__/budget/budget-performance.test.ts
```

## Acceptance Criteria

### Must Fix (Before Production)

- [ ] All 81 budget tests passing (currently 75/81)
- [ ] API route parameter parsing working correctly
- [ ] No test failures in budget test suite

### Should Fix (Performance)

- [ ] Caching implemented for budget calculations
- [ ] Performance tests added and passing
- [ ] Cache invalidation working correctly

### Nice to Have (Quality)

- [ ] Comprehensive integration tests added
- [ ] Edge case error handling improved
- [ ] Performance monitoring added

## Implementation Order

1. **Fix API Route Tests** (1-2 hours)
   - Update NextRequest mock
   - Fix URL parameter parsing
   - Verify all API tests pass

2. **Add Caching** (2-3 hours)
   - Implement Redis caching
   - Add cache invalidation
   - Test cache performance

3. **Add Integration Tests** (1-2 hours)
   - Database operation tests
   - End-to-end workflow tests
   - Error scenario tests

4. **Improve Error Handling** (1 hour)
   - Enhanced validation
   - Better error messages
   - Structured logging

## Success Metrics

- **Test Coverage**: 100% of budget tests passing
- **Performance**: Budget calculations cached and < 100ms response time
- **Reliability**: Integration tests covering all database operations
- **Maintainability**: Clear error messages and logging

## Dependencies

- Redis server for caching (if not already available)
- Test database setup
- Performance testing tools

## Notes

- The implementation is functionally complete and well-architected
- Issues are primarily in test setup and performance optimization
- No security vulnerabilities identified
- All acceptance criteria for the story are met

## Related Files

- `docs/stories/5.3.budget-planning-recommendations.md` - Original story
- `docs/qa/gates/5.3-budget-planning-recommendations.yml` - QA gate decision
- `__tests__/budget/` - Test files to fix
- `lib/budget/` - Business logic to optimize
- `app/api/budget/` - API routes to test
