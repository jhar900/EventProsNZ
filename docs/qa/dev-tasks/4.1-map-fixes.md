# Dev Task: Fix Critical Map Implementation Issues

## Overview

Based on the QA review of Story 4.1: Interactive Map Implementation, there are critical issues that must be resolved before this feature can be deployed to production. The gate status is **CONCERNS** with 2 high-severity and 2 medium-severity issues.

## Priority: HIGH - Must Fix Before Production

### 1. Fix Supabase Query Chain Issues (High Severity)

**Problem**: Map API endpoints are failing tests due to incorrect Supabase query structure.

**Files to Fix**:

- `app/api/map/contractors/route.ts` (lines 33-68)
- `app/api/map/search/route.ts` (lines 29-50)

**Issues**:

- Query chain methods not properly chained
- Test failures: `query.eq is not a function`
- Search API: `supabase.from(...).select(...).eq(...).or is not a function`

**Expected Fix**:

```typescript
// Current problematic structure
let query = supabase
  .from('business_profiles')
  .select(`...`)
  .eq('users.role', 'contractor')
  .not('business_address', 'is', null);

// Apply filters
if (serviceType) {
  query = query.eq('services.service_type', serviceType); // This breaks the chain
}

// Should be:
let query = supabase
  .from('business_profiles')
  .select(`...`)
  .eq('users.role', 'contractor')
  .not('business_address', 'is', null);

// Apply filters by chaining properly
if (serviceType) {
  query = query.eq('services.service_type', serviceType);
}
```

### 2. Implement Proper Geocoding (High Severity)

**Problem**: All contractor locations default to Auckland coordinates (-36.8485, 174.7633) instead of using actual business addresses.

**Files to Fix**:

- `app/api/map/contractors/route.ts` (lines 85-88)
- `app/api/map/contractors/[id]/location/route.ts` (lines 52-55)

**Current Issue**:

```typescript
// Hardcoded Auckland coordinates
location: {
  lat: -36.8485, // Default to Auckland - in real implementation, geocode addresses
  lng: 174.7633,
},
```

**Required Implementation**:

1. Use the existing `mapService.geocodeAddress()` method
2. Geocode `business_address` field from database
3. Handle geocoding failures gracefully with fallback coordinates
4. Cache geocoded results to avoid repeated API calls

**Example Implementation**:

```typescript
// Transform data for map display with proper geocoding
const mapContractors = await Promise.all(
  contractors?.map(async contractor => {
    let location = { lat: -36.8485, lng: 174.7633 }; // Default fallback

    if (contractor.business_address) {
      const geocodedLocation = await mapService.geocodeAddress(
        contractor.business_address
      );
      if (geocodedLocation) {
        location = geocodedLocation;
      }
    }

    return {
      id: contractor.user_id,
      company_name: contractor.company_name,
      business_address: contractor.business_address,
      service_type: contractor.services?.[0]?.service_type || 'other',
      location,
      is_verified: contractor.is_verified,
      subscription_tier: contractor.subscription_tier,
    };
  }) || []
);
```

### 3. Fix Component Syntax Errors (Medium Severity)

**Problem**: InteractiveMap component has syntax errors in ContractorPin integration.

**Files to Fix**:

- `components/features/map/InteractiveMap.tsx` (line 25)
- `components/features/map/ContractorPin.tsx` (lines 45-50)

**Issues**:

- Missing `contractor` prop in ContractorPinProps interface
- Syntax errors in component destructuring
- Incomplete component structure

**Required Fixes**:

1. Add missing `contractor` prop to ContractorPinProps interface
2. Fix destructuring syntax in component parameters
3. Ensure proper prop passing in InteractiveMap component

### 4. Improve Test Reliability (Medium Severity)

**Problem**: 11 out of 52 map tests are failing due to mocking issues.

**Files to Fix**:

- `__tests__/map/map-api.test.ts`
- `__tests__/map/map-components.test.tsx`

**Issues**:

- Supabase mock structure doesn't match actual implementation
- Component mocking issues with Mapbox context
- Test assertions expecting different method chains

**Required Fixes**:

1. Update Supabase mock structure to match actual query chains
2. Fix component test mocking for Mapbox context
3. Align test expectations with actual implementation
4. Ensure all tests pass consistently

## Testing Requirements

After implementing fixes:

1. **Run Map Tests**: `npm test -- __tests__/map`
2. **Verify API Endpoints**: Test all map API endpoints manually
3. **Test Geocoding**: Verify addresses are properly geocoded
4. **Component Testing**: Ensure InteractiveMap renders without errors
5. **Integration Testing**: Test complete map functionality

## Success Criteria

- [ ] All 52 map tests pass
- [ ] API endpoints return proper contractor data with real coordinates
- [ ] Geocoding works for New Zealand addresses
- [ ] InteractiveMap component renders without syntax errors
- [ ] Contractor pins display with correct locations
- [ ] No console errors in browser

## Additional Notes

- The Mapbox Geocoding API is already configured in `mapService.geocodeAddress()`
- Caching system is implemented and working
- Mobile responsiveness and offline functionality are working correctly
- Security and performance optimizations are in place

## Timeline

This should be completed within 1-2 development days to resolve the blocking issues and allow the feature to proceed to production.

---

**QA Reference**: See `docs/qa/gates/4.1-interactive-map-implementation.yml` for complete review details.
