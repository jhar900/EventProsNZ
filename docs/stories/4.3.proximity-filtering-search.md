# Story 4.3: Proximity Filtering & Search

## Status

Draft

## Story

**As an** event manager,  
**I want** to filter contractors by proximity to my event location,  
**so that** I can find contractors who can service my specific area.

## Acceptance Criteria

1. Event location input with Mapbox address autocomplete
2. Proximity-based contractor filtering
3. Service area coverage visualization (only on contractor profile pages)
4. Coverage area mapping for contractors
5. Location-based search suggestions
6. Integration with directory search filters
7. Service area visualization only on contractor profile pages
8. No distance/travel time calculations (keeps it simple)

## Tasks / Subtasks

- [ ] Create proximity filtering API routes (AC: 1, 2, 5, 6)
  - [ ] Implement `/api/map/proximity/filter` endpoint for proximity filtering
  - [ ] Implement `/api/map/proximity/suggestions` endpoint for location suggestions
  - [ ] Implement `/api/map/proximity/coverage` endpoint for service area coverage
  - [ ] Implement `/api/map/proximity/search` endpoint for location-based search
  - [ ] Add proper geocoding and proximity calculation logic
  - [ ] Add proximity filtering performance optimization
- [ ] Build proximity filtering UI components (AC: 1, 2, 5, 6, 7, 8)
  - [ ] Create `ProximityFilter` component with location input
  - [ ] Create `LocationInput` component with Mapbox autocomplete
  - [ ] Create `ProximityResults` component for filtered results
  - [ ] Create `ServiceAreaVisualization` component for contractor profiles
  - [ ] Create `LocationSuggestions` component for search suggestions
  - [ ] Create `ProximityMap` component for map integration
  - [ ] Add proximity filtering state management
- [ ] Implement event location input (AC: 1, 5)
  - [ ] Create Mapbox address autocomplete integration
  - [ ] Add location validation and formatting
  - [ ] Implement location search suggestions
  - [ ] Add location history and favorites
  - [ ] Create location input error handling
  - [ ] Add location input accessibility features
- [ ] Set up proximity-based filtering (AC: 2, 6, 8)
  - [ ] Create proximity calculation algorithm
  - [ ] Implement contractor filtering by proximity
  - [ ] Add proximity radius selection
  - [ ] Create proximity filter integration with directory
  - [ ] Add proximity filter performance optimization
  - [ ] Implement proximity filter state management
- [ ] Create service area visualization (AC: 3, 4, 7)
  - [ ] Create service area mapping for contractors
  - [ ] Add service area visualization on profile pages
  - [ ] Implement service area coverage display
  - [ ] Add service area filtering and selection
  - [ ] Create service area performance optimization
  - [ ] Add service area accessibility features
- [ ] Implement location-based search (AC: 5, 6)
  - [ ] Create location search suggestions
  - [ ] Add location-based contractor search
  - [ ] Implement location search integration
  - [ ] Add location search performance optimization
  - [ ] Create location search analytics
  - [ ] Add location search error handling
- [ ] Create proximity filtering pages (AC: 1, 2, 5, 6, 7, 8)
  - [ ] Create `/contractors/map/proximity` page with proximity filtering
  - [ ] Add proximity filtering to existing map page
  - [ ] Create proximity filtering navigation and breadcrumbs
  - [ ] Implement proximity filtering routing and state
  - [ ] Add proximity filtering page metadata and SEO
  - [ ] Create proximity filtering sharing and URL state
- [ ] Set up proximity filtering integration (AC: 2, 6, 7, 8)
  - [ ] Integrate proximity filtering with directory search
  - [ ] Add proximity filtering to map clustering
  - [ ] Implement proximity filtering with contractor profiles
  - [ ] Add proximity filtering with search analytics
  - [ ] Create proximity filtering performance monitoring
  - [ ] Add proximity filtering user experience optimization

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for map foundation)
- **Story 4.2**: Map clustering & interaction (for map interactions)

The proximity filtering system will use the existing map implementation and contractor data to provide location-based contractor discovery.

### Data Models

[Source: architecture/data-models.md#user]
The proximity filtering system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE
- `subscription_tier` subscription_tier DEFAULT 'essential'

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**ProximitySearch Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `search_location` JSON
- `search_radius` INTEGER
- `results_count` INTEGER
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#map-endpoints]
The proximity filtering system will implement the following API endpoints:

**Proximity Filtering:**

- `GET /api/map/proximity/filter`

  - Query: `{ location, radius?, service_type? }`
  - Response: `{ contractors: ProximityContractor[], total: number }`

- `GET /api/map/proximity/suggestions`

  - Query: `{ q?, bounds? }`
  - Response: `{ suggestions: LocationSuggestion[] }`

- `GET /api/map/proximity/coverage`

  - Query: `{ contractor_id }`
  - Response: `{ coverage_areas: ServiceArea[] }`

- `GET /api/map/proximity/search`
  - Query: `{ q?, location?, radius? }`
  - Response: `{ results: ProximitySearchResult[] }`

**Location Services:**

- `POST /api/map/geocode`

  - Body: `{ address: string }`
  - Response: `{ location: MapLocation, formatted_address: string }`

- `POST /api/map/reverse-geocode`
  - Body: `{ lat: number, lng: number }`
  - Response: `{ address: string, location: MapLocation }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The proximity filtering system will use the following components:

**Proximity Components:**

- `ProximityFilter` - Main proximity filtering interface
- `LocationInput` - Location input with Mapbox autocomplete
- `ProximityResults` - Proximity-based contractor results
- `ServiceAreaVisualization` - Service area display on profiles
- `LocationSuggestions` - Location search suggestions
- `ProximityMap` - Map integration for proximity filtering
- `RadiusSelector` - Proximity radius selection
- `LocationHistory` - Location search history
- `ProximityAnalytics` - Proximity search analytics
- `CoverageMap` - Service area coverage mapping

**Filtering Features:**

- Mapbox address autocomplete integration
- Proximity-based contractor filtering
- Service area visualization
- Location-based search suggestions
- Integration with directory search filters
- Simple proximity calculation (no distance/travel time)

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/contractors/map/proximity/page.tsx` - Proximity filtering page
- `components/features/map/proximity/` - Proximity filtering components
- `components/features/map/proximity/ProximityFilter.tsx` - Main filter
- `components/features/map/proximity/LocationInput.tsx` - Location input
- `components/features/map/proximity/ProximityResults.tsx` - Results display
- `components/features/map/proximity/ServiceAreaVisualization.tsx` - Service areas
- `components/features/map/proximity/LocationSuggestions.tsx` - Suggestions
- `components/features/map/proximity/ProximityMap.tsx` - Map integration
- `components/features/map/proximity/RadiusSelector.tsx` - Radius selection
- `components/features/map/proximity/LocationHistory.tsx` - Search history
- `lib/map/proximity/` - Proximity utilities and services
- `lib/map/proximity/proximity-service.ts` - Proximity service
- `lib/map/proximity/geocoding-service.ts` - Geocoding service
- `lib/map/proximity/coverage-service.ts` - Coverage service
- `hooks/useProximityFilter.ts` - Proximity hook
- `stores/proximity-filter.ts` - Proximity state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Map Library**: Mapbox GL JS with geocoding integration
- **Performance**: Optimized proximity calculations and filtering
- **Security**: Secure location data handling and privacy
- **Validation**: Input validation for location data
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Privacy**: GDPR-compliant location data handling
- **Simplicity**: No complex distance/travel time calculations

### Proximity Calculation

**Proximity Features:**

- Simple radius-based proximity filtering
- Service area coverage visualization
- Location-based search suggestions
- No distance or travel time calculations
- Performance-optimized proximity queries

**Proximity Implementation:**

```typescript
// Example proximity calculation
interface ProximityFilter {
  location: MapLocation;
  radius: number; // in kilometers
  serviceType?: string;
  verifiedOnly?: boolean;
}
```

### Service Area Visualization

**Coverage Features:**

- Service area mapping for contractors
- Coverage area visualization on profile pages
- Service area filtering and selection
- Coverage area performance optimization
- Mobile-optimized coverage display

**Coverage Implementation:**

- Mapbox polygon rendering for service areas
- Service area data from contractor profiles
- Coverage area filtering and selection
- Performance optimization for large areas
- Mobile-responsive coverage display

### Location Services

**Geocoding Features:**

- Mapbox address autocomplete
- Location validation and formatting
- Reverse geocoding for coordinates
- Location search suggestions
- Location history and favorites

**Geocoding Implementation:**

- Mapbox Geocoding API integration
- Address validation and formatting
- Location search with suggestions
- Location data caching
- Error handling and fallbacks

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for proximity components
- **API Testing**: Jest + Supertest for proximity endpoints
- **E2E Testing**: Playwright for complete proximity filtering flows
- **Performance Testing**: Test proximity calculation performance
- **Location Testing**: Test geocoding and location services
- **Test File Location**: `__tests__/map/proximity/` directory
- **Test Scenarios**: Proximity filtering, location input, service area visualization, geocoding
- **Coverage Requirements**: 80% coverage for proximity logic and components

### Performance Considerations

**Proximity Performance:**

- Efficient proximity calculation algorithms
- Location data caching
- Proximity query optimization
- Service area rendering optimization
- Mobile performance optimization

**Location Performance:**

- Geocoding API rate limiting
- Location data caching
- Address autocomplete optimization
- Location search performance
- Mobile location services optimization

### Privacy and Security

**Location Privacy:**

- GDPR-compliant location data handling
- Location data anonymization
- User consent for location tracking
- Location data retention policies
- Privacy impact assessments

**Location Security:**

- Secure location data transmission
- Location data access control
- Location data encryption
- Location data validation
- Secure geocoding API usage

### State Management

[Source: architecture/components.md#state-management-architecture]
**Proximity Filtering State Management:**

```typescript
interface ProximityFilterStore {
  searchLocation: MapLocation | null;
  searchRadius: number;
  filteredContractors: ProximityContractor[];
  serviceAreas: ServiceArea[];
  locationSuggestions: LocationSuggestion[];
  searchHistory: ProximitySearch[];
  isLoading: boolean;
  setSearchLocation: (location: MapLocation) => void;
  setSearchRadius: (radius: number) => void;
  filterContractors: (location: MapLocation, radius: number) => Promise<void>;
  getLocationSuggestions: (query: string) => Promise<void>;
  addToHistory: (search: ProximitySearch) => void;
  clearHistory: () => void;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
