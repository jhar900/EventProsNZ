# Story 4.1: Interactive Map Implementation

## Status

Draft

## Story

**As an** event manager,  
**I want** to view contractors on an interactive map,  
**so that** I can see their locations and service coverage areas.

## Acceptance Criteria

1. Mapbox integration with New Zealand coverage
2. Contractor location pins with business addresses
3. Color-coded pins based on service type
4. Map zoom and pan functionality
5. Map controls and layer options
6. Mobile-responsive map design
7. Map loading and performance optimization
8. Offline map functionality for basic viewing
9. Lazy loading for contractor data
10. Cache map tiles for offline viewing

## Tasks / Subtasks

- [ ] Set up Mapbox integration and configuration (AC: 1, 7, 8, 10)
  - [ ] Install and configure Mapbox GL JS
  - [ ] Set up Mapbox API keys and authentication
  - [ ] Configure New Zealand map coverage and bounds
  - [ ] Implement map tile caching for offline viewing
  - [ ] Add map loading and performance optimization
  - [ ] Set up map error handling and fallbacks
- [ ] Build interactive map UI components (AC: 1, 4, 5, 6, 7)
  - [ ] Create `InteractiveMap` component with Mapbox integration
  - [ ] Create `MapControls` component for zoom and pan controls
  - [ ] Create `MapLayers` component for layer options
  - [ ] Create `MapLegend` component for service type indicators
  - [ ] Create `MapLoading` component for loading states
  - [ ] Add mobile-responsive map design
- [ ] Implement contractor location pins (AC: 2, 3, 9)
  - [ ] Create contractor pin rendering system
  - [ ] Add business address geocoding and pin placement
  - [ ] Implement color-coded pins based on service type
  - [ ] Add pin data lazy loading for performance
  - [ ] Create pin clustering for large datasets
  - [ ] Add pin hover effects and tooltips
- [ ] Set up map controls and interactions (AC: 4, 5)
  - [ ] Implement zoom and pan controls
  - [ ] Add map layer toggle functionality
  - [ ] Create map bounds and viewport management
  - [ ] Add map search and location finding
  - [ ] Implement map reset and home functionality
- [ ] Create map pages and navigation (AC: 1, 6, 7)
  - [ ] Create `/contractors/map` page with interactive map
  - [ ] Add map page navigation and breadcrumbs
  - [ ] Implement map page routing and state management
  - [ ] Add map page metadata and SEO optimization
  - [ ] Create map sharing and URL state management
- [ ] Implement mobile optimization (AC: 6, 7, 8)
  - [ ] Create mobile-responsive map layout
  - [ ] Add touch-friendly map controls
  - [ ] Implement mobile map performance optimization
  - [ ] Add mobile map caching and offline support
  - [ ] Create mobile map gesture handling
- [ ] Set up map performance optimization (AC: 7, 9, 10)
  - [ ] Implement map tile caching system
  - [ ] Add lazy loading for contractor data
  - [ ] Create map performance monitoring
  - [ ] Add map loading optimization
  - [ ] Implement map data pagination
- [ ] Implement offline map functionality (AC: 8, 10)
  - [ ] Create offline map tile storage
  - [ ] Add offline contractor data caching
  - [ ] Implement offline map fallbacks
  - [ ] Add offline map synchronization
  - [ ] Create offline map indicators

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)

The interactive map will use the existing contractor data and search systems to provide location-based contractor discovery.

### Data Models

[Source: architecture/data-models.md#user]
The interactive map system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE
- `subscription_tier` subscription_tier DEFAULT 'essential'

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**MapCache Table (to be created):**

- `id` UUID PRIMARY KEY
- `tile_key` TEXT UNIQUE NOT NULL
- `tile_data` BYTEA
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `expires_at` TIMESTAMP WITH TIME ZONE

### API Specifications

[Source: architecture/api-specification.md#map-endpoints]
The interactive map system will implement the following API endpoints:

**Map Data:**

- `GET /api/map/contractors`

  - Query: `{ bounds?, service_type?, verified_only? }`
  - Response: `{ contractors: MapContractor[], bounds: MapBounds }`

- `GET /api/map/contractors/{id}/location`

  - Response: `{ location: MapLocation, address: string }`

- `GET /api/map/search`
  - Query: `{ q?, bounds? }`
  - Response: `{ results: MapSearchResult[] }`

**Map Caching:**

- `GET /api/map/tiles/{z}/{x}/{y}`

  - Response: `{ tile_data: Blob }`

- `POST /api/map/cache/clear`
  - Response: `{ success: boolean }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The interactive map system will use the following components:

**Map Components:**

- `InteractiveMap` - Main map component with Mapbox integration
- `MapControls` - Zoom, pan, and navigation controls
- `MapLayers` - Layer toggle and options
- `MapLegend` - Service type legend and indicators
- `MapLoading` - Loading states and spinners
- `ContractorPin` - Individual contractor location pins
- `PinCluster` - Clustered pin groups
- `MapTooltip` - Pin hover tooltips
- `MapSearch` - Map-based search functionality
- `OfflineIndicator` - Offline mode indicator

**Map Features:**

- New Zealand map coverage with proper bounds
- Color-coded pins based on service type
- Smooth zoom and pan animations
- Mobile-responsive design
- Offline map tile caching
- Performance optimization

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/contractors/map/page.tsx` - Interactive map page
- `components/features/map/` - Map components
- `components/features/map/InteractiveMap.tsx` - Main map component
- `components/features/map/MapControls.tsx` - Map controls
- `components/features/map/MapLayers.tsx` - Layer controls
- `components/features/map/MapLegend.tsx` - Service legend
- `components/features/map/ContractorPin.tsx` - Contractor pins
- `components/features/map/PinCluster.tsx` - Pin clustering
- `components/features/map/MapTooltip.tsx` - Pin tooltips
- `components/features/map/MapSearch.tsx` - Map search
- `lib/map/` - Map utilities and services
- `lib/map/mapbox-config.ts` - Mapbox configuration
- `lib/map/map-service.ts` - Map data service
- `lib/map/cache-service.ts` - Map caching service
- `lib/map/geocoding-service.ts` - Geocoding service
- `hooks/useMap.ts` - Map data hook
- `stores/map.ts` - Map state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Map Library**: Mapbox GL JS with New Zealand coverage
- **Performance**: Optimized map rendering and tile caching
- **Security**: Secure API key management and access control
- **Validation**: Input validation for map interactions
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Offline**: Offline map tile caching and data synchronization
- **Mobile**: Mobile-optimized map interactions and performance

### Mapbox Integration

[Source: architecture/maps/mapbox-config.ts]
**Mapbox Features:**

- New Zealand map coverage with proper bounds
- Custom map styles and themes
- Map tile caching for offline viewing
- Geocoding and reverse geocoding
- Map clustering and performance optimization
- Mobile-responsive map interactions

**Implementation:**

```typescript
// Example Mapbox configuration
interface MapboxConfig {
  accessToken: string;
  style: string;
  center: [number, number];
  zoom: number;
  bounds: [[number, number], [number, number]];
  maxBounds: [[number, number], [number, number]];
}
```

### Map Performance Optimization

**Tile Caching:**

- Map tile storage and retrieval
- Offline tile caching system
- Tile expiration and refresh
- Cache size management
- Performance monitoring

**Data Optimization:**

- Lazy loading for contractor data
- Pin clustering for large datasets
- Viewport-based data loading
- Efficient data structures
- Memory management

### Mobile Optimization

**Mobile Features:**

- Touch-friendly map controls
- Mobile-responsive map layout
- Gesture handling and recognition
- Mobile performance optimization
- Offline mobile support

**Responsive Design:**

- Mobile-first map design
- Adaptive map controls
- Mobile map interactions
- Touch gesture support
- Mobile map caching

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for map components
- **API Testing**: Jest + Supertest for map endpoints
- **E2E Testing**: Playwright for complete map interactions
- **Performance Testing**: Test map loading and rendering performance
- **Mobile Testing**: Test mobile map interactions and responsiveness
- **Test File Location**: `__tests__/map/` directory
- **Test Scenarios**: Map rendering, pin display, interactions, mobile responsiveness, offline functionality
- **Coverage Requirements**: 80% coverage for map logic and components

### Offline Functionality

**Offline Features:**

- Map tile caching for offline viewing
- Contractor data caching
- Offline map synchronization
- Offline indicators and status
- Graceful degradation

**Cache Management:**

- Tile cache size limits
- Cache expiration policies
- Cache cleanup and maintenance
- Cache performance monitoring
- Cache synchronization

### State Management

[Source: architecture/components.md#state-management-architecture]
**Map State Management:**

```typescript
interface MapStore {
  mapInstance: MapboxMap | null;
  contractors: MapContractor[];
  bounds: MapBounds;
  zoom: number;
  center: [number, number];
  selectedPin: string | null;
  filters: MapFilters;
  isOffline: boolean;
  isLoading: boolean;
  initializeMap: (container: HTMLElement) => Promise<void>;
  loadContractors: (bounds: MapBounds) => Promise<void>;
  setFilters: (filters: MapFilters) => void;
  selectPin: (contractorId: string) => void;
  clearSelection: () => void;
  setOfflineMode: (offline: boolean) => void;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
