# Story 7.1: Structured Inquiry System

## Status

Draft

## Story

**As an** event manager,  
**I want** to send structured inquiries to contractors with event details,  
**so that** contractors have all the information they need to provide accurate quotes.

## Acceptance Criteria

1. Event manager must be signed in to send enquiry on contractor profile page
2. "Get in touch" form that captures essential event details
3. Event information pre-population from event creation (optional)
4. If event details has not been created, data can be inputted manually (optional)
5. Message is required for submission
6. Contractor selection and inquiry sending
7. Inquiry status tracking (sent, viewed, responded, quoted)
8. Email notifications for new inquiries
9. Inquiry history and management
10. Template responses for common inquiries
11. Inquiry validation and error handling

## Tasks / Subtasks

- [ ] Create structured inquiry API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Implement `/api/inquiries` endpoint for inquiry CRUD operations
  - [ ] Implement `/api/inquiries/send` endpoint for inquiry sending
  - [ ] Implement `/api/inquiries/status` endpoint for status tracking
  - [ ] Implement `/api/inquiries/notifications` endpoint for email notifications
  - [ ] Implement `/api/inquiries/history` endpoint for inquiry history
  - [ ] Implement `/api/inquiries/templates` endpoint for template responses
  - [ ] Implement `/api/inquiries/validation` endpoint for inquiry validation
  - [ ] Implement `/api/inquiries/contractor` endpoint for contractor-specific inquiries
  - [ ] Add proper inquiry validation and error handling
  - [ ] Add inquiry security and access control
- [ ] Build structured inquiry UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `StructuredInquiry` component for main inquiry interface
  - [ ] Create `InquiryForm` component for inquiry form
  - [ ] Create `EventDetailsInput` component for event details input
  - [ ] Create `ContractorSelection` component for contractor selection
  - [ ] Create `InquiryStatus` component for status tracking
  - [ ] Create `InquiryNotifications` component for email notifications
  - [ ] Create `InquiryHistory` component for inquiry history
  - [ ] Create `TemplateResponses` component for template responses
  - [ ] Create `InquiryValidation` component for validation and error handling
  - [ ] Add inquiry loading states and error handling
- [ ] Implement inquiry form system (AC: 1, 2, 3, 4, 5, 6, 11)
  - [ ] Create "Get in touch" form that captures essential event details
  - [ ] Add event information pre-population from event creation (optional)
  - [ ] Add manual event details input if not created
  - [ ] Implement message requirement for submission
  - [ ] Add contractor selection and inquiry sending
  - [ ] Create inquiry form validation and error handling
  - [ ] Add inquiry form security and access control
  - [ ] Implement inquiry form performance optimization
- [ ] Set up inquiry status tracking (AC: 7, 8, 9)
  - [ ] Create inquiry status tracking (sent, viewed, responded, quoted)
  - [ ] Add email notifications for new inquiries
  - [ ] Implement inquiry history and management
  - [ ] Add inquiry status analytics and insights
  - [ ] Create inquiry status validation and error handling
  - [ ] Add inquiry status security and access control
  - [ ] Implement inquiry status performance optimization
  - [ ] Add inquiry status user experience optimization
- [ ] Create inquiry notification system (AC: 8, 9, 10)
  - [ ] Create email notifications for new inquiries
  - [ ] Add inquiry notification templates and customization
  - [ ] Implement inquiry notification scheduling and automation
  - [ ] Add inquiry notification analytics and tracking
  - [ ] Create inquiry notification performance optimization
  - [ ] Add inquiry notification security and access control
  - [ ] Implement inquiry notification error handling and recovery
  - [ ] Add inquiry notification user experience optimization
- [ ] Implement inquiry history management (AC: 9, 10, 11)
  - [ ] Create inquiry history and management
  - [ ] Add template responses for common inquiries
  - [ ] Implement inquiry history search and filtering
  - [ ] Add inquiry history analytics and insights
  - [ ] Create inquiry history validation and error handling
  - [ ] Add inquiry history security and access control
  - [ ] Implement inquiry history performance optimization
  - [ ] Add inquiry history user experience optimization
- [ ] Set up template response system (AC: 10, 11)
  - [ ] Create template responses for common inquiries
  - [ ] Add template response customization and management
  - [ ] Implement template response validation and testing
  - [ ] Add template response analytics and insights
  - [ ] Create template response performance optimization
  - [ ] Add template response security and access control
  - [ ] Implement template response error handling and recovery
  - [ ] Add template response user experience optimization
- [ ] Create inquiry validation system (AC: 11)
  - [ ] Create inquiry validation and error handling
  - [ ] Add inquiry data validation and sanitization
  - [ ] Implement inquiry security validation and access control
  - [ ] Add inquiry validation analytics and insights
  - [ ] Create inquiry validation performance optimization
  - [ ] Add inquiry validation security and access control
  - [ ] Implement inquiry validation error handling and recovery
  - [ ] Add inquiry validation user experience optimization
- [ ] Create inquiry management pages (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `/inquiries` page for inquiry management
  - [ ] Create `/inquiries/send` page for inquiry sending
  - [ ] Create `/inquiries/history` page for inquiry history
  - [ ] Create `/inquiries/templates` page for template management
  - [ ] Create `/inquiries/status` page for status tracking
  - [ ] Add inquiry navigation and breadcrumbs
  - [ ] Implement inquiry routing and state management
  - [ ] Add inquiry page metadata and SEO

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)
- **Story 5.1**: Event creation wizard (for event creation integration)
- **Story 5.2**: AI-powered service recommendations (for service recommendations)
- **Story 5.3**: Budget planning & recommendations (for budget integration)
- **Story 5.4**: Intelligent contractor matching (for contractor matching)
- **Story 5.5**: Event management & status tracking (for event management)
- **Story 6.1**: Subscription management system (for subscription integration)
- **Story 6.2**: Payment processing integration (for payment integration)
- **Story 6.3**: Premium feature access (for feature access integration)
- **Story 6.4**: Trial conversion & communication (for trial integration)

The structured inquiry system will use the existing event creation, contractor matching, and communication systems to provide comprehensive inquiry functionality.

### Data Models

[Source: architecture/data-models.md#user]
The structured inquiry system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**Event Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `event_type` TEXT NOT NULL
- `title` TEXT NOT NULL
- `description` TEXT
- `event_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `duration_hours` INTEGER
- `attendee_count` INTEGER
- `location` JSON
- `budget_total` DECIMAL(10,2)
- `status` event_status DEFAULT 'draft'
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Inquiry Table (to be created):**

- `id` UUID PRIMARY KEY
- `event_manager_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `contractor_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `event_id` UUID REFERENCES events(id) ON DELETE CASCADE
- `inquiry_type` inquiry_type NOT NULL
- `subject` TEXT NOT NULL
- `message` TEXT NOT NULL
- `event_details` JSON
- `status` inquiry_status DEFAULT 'sent'
- `priority` inquiry_priority DEFAULT 'medium'
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**InquiryResponse Table (to be created):**

- `id` UUID PRIMARY KEY
- `inquiry_id` UUID REFERENCES inquiries(id) ON DELETE CASCADE
- `responder_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `response_type` response_type NOT NULL
- `message` TEXT NOT NULL
- `attachments` JSON
- `is_template` BOOLEAN DEFAULT FALSE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**InquiryTemplate Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `template_name` TEXT NOT NULL
- `template_content` TEXT NOT NULL
- `template_type` template_type NOT NULL
- `is_public` BOOLEAN DEFAULT FALSE
- `usage_count` INTEGER DEFAULT 0
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#inquiry-endpoints]
The structured inquiry system will implement the following API endpoints:

**Inquiry Management:**

- `POST /api/inquiries`

  - Body: `{ contractor_id, event_id?, inquiry_type, subject, message, event_details?, priority? }`
  - Response: `{ inquiry: Inquiry, success: boolean }`

- `GET /api/inquiries`

  - Query: `{ user_id?, status?, inquiry_type?, page?, limit? }`
  - Response: `{ inquiries: Inquiry[], total: number, page: number, limit: number }`

- `GET /api/inquiries/{id}`

  - Response: `{ inquiry: Inquiry, responses: InquiryResponse[] }`

- `PUT /api/inquiries/{id}`
  - Body: `{ status?, priority?, subject?, message? }`
  - Response: `{ inquiry: Inquiry, success: boolean }`

**Inquiry Sending:**

- `POST /api/inquiries/send`

  - Body: `{ contractor_id, event_id?, inquiry_type, subject, message, event_details?, priority? }`
  - Response: `{ inquiry: Inquiry, success: boolean }`

- `POST /api/inquiries/bulk-send`
  - Body: `{ contractor_ids: string[], inquiry_data: InquiryData }`
  - Response: `{ inquiries: Inquiry[], success: boolean }`

**Inquiry Status:**

- `GET /api/inquiries/status`

  - Query: `{ user_id, status? }`
  - Response: `{ inquiries: Inquiry[], status_counts: StatusCounts }`

- `PUT /api/inquiries/{id}/status`
  - Body: `{ status, reason? }`
  - Response: `{ inquiry: Inquiry, success: boolean }`

**Inquiry Notifications:**

- `POST /api/inquiries/notifications/send`

  - Body: `{ inquiry_id, notification_type }`
  - Response: `{ notification: InquiryNotification, success: boolean }`

- `GET /api/inquiries/notifications`
  - Query: `{ user_id, inquiry_id? }`
  - Response: `{ notifications: InquiryNotification[] }`

**Inquiry History:**

- `GET /api/inquiries/history`

  - Query: `{ user_id, date_from?, date_to?, status? }`
  - Response: `{ inquiries: Inquiry[], analytics: InquiryAnalytics }`

- `GET /api/inquiries/history/export`
  - Query: `{ user_id, format?, date_from?, date_to? }`
  - Response: `{ export_data: Blob }`

**Inquiry Templates:**

- `GET /api/inquiries/templates`

  - Query: `{ user_id?, template_type?, is_public? }`
  - Response: `{ templates: InquiryTemplate[] }`

- `POST /api/inquiries/templates`

  - Body: `{ template_name, template_content, template_type, is_public? }`
  - Response: `{ template: InquiryTemplate, success: boolean }`

- `PUT /api/inquiries/templates/{id}`
  - Body: `{ template_name?, template_content?, is_public? }`
  - Response: `{ template: InquiryTemplate, success: boolean }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The structured inquiry system will use the following components:

**Inquiry Components:**

- `StructuredInquiry` - Main inquiry interface
- `InquiryForm` - Inquiry form with validation
- `EventDetailsInput` - Event details input and pre-population
- `ContractorSelection` - Contractor selection interface
- `InquiryStatus` - Inquiry status tracking and display
- `InquiryNotifications` - Inquiry notification management
- `InquiryHistory` - Inquiry history and management
- `TemplateResponses` - Template response management
- `InquiryValidation` - Inquiry validation and error handling
- `InquiryList` - Inquiry list display
- `InquiryCard` - Individual inquiry display
- `InquiryFilters` - Inquiry filtering and search
- `InquiryAnalytics` - Inquiry analytics and insights
- `InquiryExport` - Inquiry export functionality
- `InquirySearch` - Inquiry search functionality

**Inquiry Features:**

- Event manager must be signed in to send enquiry
- "Get in touch" form that captures essential event details
- Event information pre-population from event creation
- Manual event details input if not created
- Message requirement for submission
- Contractor selection and inquiry sending
- Inquiry status tracking (sent, viewed, responded, quoted)
- Email notifications for new inquiries
- Inquiry history and management
- Template responses for common inquiries
- Inquiry validation and error handling

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/inquiries/page.tsx` - Inquiry management page
- `app/inquiries/send/page.tsx` - Inquiry sending page
- `app/inquiries/history/page.tsx` - Inquiry history page
- `app/inquiries/templates/page.tsx` - Template management page
- `app/inquiries/status/page.tsx` - Status tracking page
- `components/features/inquiries/` - Inquiry components
- `components/features/inquiries/StructuredInquiry.tsx` - Main inquiry interface
- `components/features/inquiries/InquiryForm.tsx` - Inquiry form
- `components/features/inquiries/EventDetailsInput.tsx` - Event details input
- `components/features/inquiries/ContractorSelection.tsx` - Contractor selection
- `components/features/inquiries/InquiryStatus.tsx` - Inquiry status
- `components/features/inquiries/InquiryNotifications.tsx` - Notifications
- `components/features/inquiries/InquiryHistory.tsx` - Inquiry history
- `components/features/inquiries/TemplateResponses.tsx` - Template responses
- `components/features/inquiries/InquiryValidation.tsx` - Validation
- `components/features/inquiries/InquiryList.tsx` - Inquiry list
- `components/features/inquiries/InquiryCard.tsx` - Inquiry card
- `components/features/inquiries/InquiryFilters.tsx` - Inquiry filters
- `components/features/inquiries/InquiryAnalytics.tsx` - Inquiry analytics
- `components/features/inquiries/InquiryExport.tsx` - Inquiry export
- `components/features/inquiries/InquirySearch.tsx` - Inquiry search
- `lib/inquiries/` - Inquiry utilities and services
- `lib/inquiries/inquiry-service.ts` - Inquiry service
- `lib/inquiries/notification-service.ts` - Notification service
- `lib/inquiries/template-service.ts` - Template service
- `lib/inquiries/validation-service.ts` - Validation service
- `lib/inquiries/analytics-service.ts` - Analytics service
- `hooks/useInquiry.ts` - Inquiry hook
- `stores/inquiry.ts` - Inquiry state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Form Library**: React Hook Form with Zod validation
- **UI Library**: shadcn/ui with Tailwind CSS
- **State Management**: Zustand for inquiry state
- **Validation**: Zod schemas for inquiry data validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Security**: Secure inquiry data handling and validation
- **Performance**: Optimized inquiry processing and caching
- **Accessibility**: WCAG 2.1 AA compliance for inquiry interfaces

### Inquiry Form System

**Form Features:**

- "Get in touch" form that captures essential event details
- Event information pre-population from event creation
- Manual event details input if not created
- Message requirement for submission
- Contractor selection and inquiry sending
- Inquiry form validation and error handling

**Form Implementation:**

```typescript
// Example inquiry form service
interface InquiryFormService {
  createInquiry(inquiryData: InquiryData): Promise<Inquiry>;
  prePopulateEventDetails(eventId: string): Promise<EventDetails>;
  validateInquiryForm(formData: InquiryFormData): Promise<ValidationResult>;
  sendInquiry(inquiryId: string): Promise<void>;
  getInquiryTemplates(userId: string): Promise<InquiryTemplate[]>;
  applyTemplate(
    templateId: string,
    inquiryData: InquiryData
  ): Promise<InquiryData>;
}
```

### Inquiry Status Tracking

**Status Features:**

- Inquiry status tracking (sent, viewed, responded, quoted)
- Email notifications for new inquiries
- Inquiry history and management
- Status analytics and insights
- Status validation and error handling

**Status Implementation:**

- Status transition management
- Email notification system
- History tracking and analytics
- Status validation and security
- Performance optimization

### Template Response System

**Template Features:**

- Template responses for common inquiries
- Template customization and management
- Template validation and testing
- Template analytics and insights
- Template performance optimization

**Template Implementation:**

- Template creation and management
- Template validation and testing
- Template analytics and insights
- Template performance optimization
- Template security and access control

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for inquiry components
- **API Testing**: Jest + Supertest for inquiry endpoints
- **E2E Testing**: Playwright for complete inquiry flows
- **Form Testing**: Test inquiry form validation and submission
- **Notification Testing**: Test inquiry notification delivery
- **Test File Location**: `__tests__/inquiries/` directory
- **Test Scenarios**: Inquiry creation, sending, status tracking, notifications, templates, history
- **Coverage Requirements**: 80% coverage for inquiry logic and components

### Performance Considerations

**Inquiry Performance:**

- Optimized inquiry processing and caching
- Efficient inquiry form rendering
- Inquiry notification optimization
- Inquiry history performance optimization
- Template response optimization
- Mobile inquiry interface optimization

**Data Management:**

- Inquiry data caching and persistence
- Event details data management
- Notification data optimization
- Template data management
- History data optimization
- Analytics data processing

### State Management

[Source: architecture/components.md#state-management-architecture]
**Inquiry State Management:**

```typescript
interface InquiryStore {
  inquiries: Inquiry[];
  currentInquiry: Inquiry | null;
  templates: InquiryTemplate[];
  notifications: InquiryNotification[];
  filters: InquiryFilters;
  isLoading: boolean;
  createInquiry: (inquiryData: InquiryData) => Promise<void>;
  sendInquiry: (inquiryId: string) => Promise<void>;
  updateInquiryStatus: (
    inquiryId: string,
    status: InquiryStatus
  ) => Promise<void>;
  loadInquiries: (filters?: InquiryFilters) => Promise<void>;
  loadTemplates: (userId: string) => Promise<void>;
  createTemplate: (templateData: TemplateData) => Promise<void>;
  applyTemplate: (
    templateId: string,
    inquiryData: InquiryData
  ) => Promise<void>;
  sendNotification: (
    inquiryId: string,
    notificationType: string
  ) => Promise<void>;
  exportInquiries: (format: string, filters?: InquiryFilters) => Promise<Blob>;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
