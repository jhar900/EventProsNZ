# Story 2.1: Event Manager Onboarding

## Status

Draft

## Story

**As an** event manager,  
**I want** to complete my profile setup with relevant information,  
**so that** I can access platform features and connect with contractors.

## Acceptance Criteria

1. Step 1: Personal information collection (name, email, phone, address with Mapbox autocomplete)
2. Step 2: Are you an event manager for personal events or for a business?
3. Step 3: Business details (if event management role is for a business, skip if for personal event) (company name, business address with Mapbox autocomplete, business registration (NZBN), description, service areas, social media links)
4. Step 4: Optional event creation to get started immediately
5. Profile completion with business information
6. Verification workflow for account approval
7. Dashboard access with role-specific features
8. Onboarding tutorial and platform introduction
9. Profile photo upload and management
10. Contact information validation and verification
11. Automatic approval once required details completed

## Tasks / Subtasks

- [ ] Create onboarding API routes (AC: 1, 2, 3, 5, 6, 10, 11)
  - [ ] Implement `/api/onboarding/event-manager/step1` endpoint for personal information
  - [ ] Implement `/api/onboarding/event-manager/step2` endpoint for role selection
  - [ ] Implement `/api/onboarding/event-manager/step3` endpoint for business details
  - [ ] Implement `/api/onboarding/event-manager/complete` endpoint for profile completion
  - [ ] Implement `/api/onboarding/event-manager/verify` endpoint for verification
  - [ ] Add proper validation and error handling for each step
- [ ] Build onboarding UI components (AC: 1, 2, 3, 4, 8, 9)
  - [ ] Create `OnboardingWizard` component with step navigation
  - [ ] Create `PersonalInfoForm` component for Step 1
  - [ ] Create `RoleSelectionForm` component for Step 2
  - [ ] Create `BusinessDetailsForm` component for Step 3
  - [ ] Create `ProfilePhotoUpload` component for photo management
  - [ ] Create `OnboardingTutorial` component for platform introduction
  - [ ] Add form validation and progress tracking
- [ ] Integrate Mapbox for address autocomplete (AC: 1, 3)
  - [ ] Set up Mapbox client configuration
  - [ ] Create `AddressAutocomplete` component for address input
  - [ ] Implement address validation and formatting
  - [ ] Add location search and selection functionality
  - [ ] Handle address geocoding and reverse geocoding
- [ ] Implement profile completion tracking (AC: 5, 6, 11)
  - [ ] Create profile completion status tracking
  - [ ] Implement automatic approval logic for event managers
  - [ ] Add profile completion progress indicators
  - [ ] Create verification status management
  - [ ] Add completion notification system
- [ ] Set up file upload for profile photos (AC: 9)
  - [ ] Implement profile photo upload API endpoint
  - [ ] Create image upload and preview components
  - [ ] Add image cropping and resizing functionality
  - [ ] Implement file validation and size limits
  - [ ] Add photo management and deletion capabilities
- [ ] Create onboarding pages and navigation (AC: 4, 7, 8)
  - [ ] Create `/onboarding/event-manager` page with wizard
  - [ ] Create `/onboarding/complete` success page
  - [ ] Create `/onboarding/tutorial` tutorial page
  - [ ] Add onboarding navigation and progress indicators
  - [ ] Implement onboarding flow routing and guards
- [ ] Implement contact information validation (AC: 10)
  - [ ] Add email validation and verification
  - [ ] Implement phone number validation and formatting
  - [ ] Create address validation with Mapbox integration
  - [ ] Add contact information verification workflow
  - [ ] Implement validation error handling and user feedback
- [ ] Set up dashboard access and role features (AC: 7)
  - [ ] Create event manager dashboard layout
  - [ ] Add role-specific navigation and features
  - [ ] Implement dashboard access control
  - [ ] Add quick actions for event managers
  - [ ] Create dashboard welcome and getting started content

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation

The event manager onboarding will use the existing authentication system and database schema to create comprehensive user profiles with business information.

### Data Models

[Source: architecture/data-models.md#user]
The onboarding system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table (optional for event managers):**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE

### API Specifications

[Source: architecture/api-specification.md#user-management]
The onboarding system will implement the following API endpoints:

**Onboarding Steps:**

- `POST /api/onboarding/event-manager/step1`

  - Body: `{ first_name, last_name, phone, address }`
  - Response: `{ success: boolean, profile: Profile }`

- `POST /api/onboarding/event-manager/step2`

  - Body: `{ role_type: 'personal' | 'business' }`
  - Response: `{ success: boolean, next_step: string }`

- `POST /api/onboarding/event-manager/step3`

  - Body: `{ company_name, business_address, nzbn, description, service_areas, social_links }`
  - Response: `{ success: boolean, business_profile: BusinessProfile }`

- `POST /api/onboarding/event-manager/complete`
  - Response: `{ success: boolean, user: User, profile: Profile }`

**Profile Management:**

- `POST /api/upload/profile-photo`

  - Body: `{ file: File }`
  - Response: `{ url: string, filename: string }`

- `PUT /api/users/me/profile`
  - Body: `{ first_name, last_name, phone, address, bio }`
  - Response: `{ profile: Profile }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The onboarding system will use the following components:

**Onboarding Components:**

- `OnboardingWizard` - Multi-step onboarding flow
- `PersonalInfoForm` - Personal information collection form
- `RoleSelectionForm` - Role type selection (personal/business)
- `BusinessDetailsForm` - Business information form
- `ProfilePhotoUpload` - Photo upload and management
- `OnboardingTutorial` - Platform introduction and tutorial
- `AddressAutocomplete` - Mapbox-integrated address input
- `ProgressIndicator` - Onboarding progress tracking

**Form Features:**

- React Hook Form integration with Zod validation
- Real-time validation and error display
- Step-by-step navigation with progress saving
- Responsive design with Tailwind CSS
- Accessibility features (ARIA labels, keyboard navigation)

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/onboarding/event-manager/page.tsx` - Event manager onboarding page
- `app/onboarding/complete/page.tsx` - Onboarding completion page
- `app/onboarding/tutorial/page.tsx` - Platform tutorial page
- `components/features/onboarding/` - Onboarding-specific components
- `components/features/onboarding/OnboardingWizard.tsx` - Main wizard component
- `components/features/onboarding/PersonalInfoForm.tsx` - Personal info form
- `components/features/onboarding/RoleSelectionForm.tsx` - Role selection form
- `components/features/onboarding/BusinessDetailsForm.tsx` - Business details form
- `components/features/onboarding/ProfilePhotoUpload.tsx` - Photo upload component
- `components/features/onboarding/AddressAutocomplete.tsx` - Address input component
- `lib/onboarding/` - Onboarding utilities and services
- `lib/onboarding/event-manager.ts` - Event manager onboarding service
- `lib/onboarding/validation.ts` - Onboarding validation schemas
- `hooks/useOnboarding.ts` - Onboarding state management hook
- `stores/onboarding.ts` - Onboarding state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Authentication**: Supabase Auth with JWT tokens
- **File Upload**: Supabase Storage for profile photos
- **Address Integration**: Mapbox API for address autocomplete
- **Validation**: Client-side with React Hook Form + Zod, server-side validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Performance**: Optimized file uploads with image compression
- **Security**: Secure file uploads with validation and sanitization

### Mapbox Integration

[Source: architecture/maps/mapbox-config.ts]
**Mapbox Features:**

- Address autocomplete for personal and business addresses
- Location search and selection
- Address validation and formatting
- Geocoding and reverse geocoding
- Service area mapping for business profiles

**Implementation:**

```typescript
// Example Mapbox integration
interface AddressAutocompleteProps {
  value: string;
  onChange: (address: string) => void;
  placeholder?: string;
  validation?: ValidationSchema;
}
```

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for onboarding components
- **API Testing**: Jest + Supertest for onboarding endpoints
- **E2E Testing**: Playwright for complete onboarding flows
- **File Upload Testing**: Test profile photo upload and validation
- **Test File Location**: `__tests__/onboarding/` directory
- **Test Scenarios**: Step-by-step onboarding, form validation, file uploads, address autocomplete
- **Coverage Requirements**: 80% coverage for onboarding logic and components

### Onboarding Flow

**Step-by-Step Process:**

1. **Personal Information**: Name, email, phone, address with Mapbox autocomplete
2. **Role Selection**: Personal events vs business event management
3. **Business Details**: Company information (if business role selected)
4. **Profile Photo**: Optional photo upload and management
5. **Verification**: Automatic approval for event managers
6. **Tutorial**: Platform introduction and getting started guide
7. **Dashboard Access**: Role-specific dashboard with features

**Business Logic:**

- Event managers get automatic approval after profile completion
- Business information is optional for personal event managers
- Address validation using Mapbox geocoding
- Profile completion tracking with progress indicators
- File upload with image optimization and validation

### State Management

[Source: architecture/components.md#state-management-architecture]
**Onboarding State Management:**

```typescript
interface OnboardingStore {
  currentStep: number;
  totalSteps: number;
  profileData: Partial<Profile>;
  businessProfileData: Partial<BusinessProfile>;
  isCompleted: boolean;
  setCurrentStep: (step: number) => void;
  updateProfileData: (data: Partial<Profile>) => void;
  updateBusinessProfileData: (data: Partial<BusinessProfile>) => void;
  completeOnboarding: () => Promise<void>;
  resetOnboarding: () => void;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
