# Story 6.1: Subscription Management System

## Status

Draft

## Story

**As a** contractor,  
**I want** to manage my subscription and access premium features,  
**so that** I can maximize my visibility and business opportunities.

## Acceptance Criteria

1. Three-tier system (Essential-Free, Showcase-$29/month, Spotlight-$69/month)
2. Annual pricing with discounts (Showcase-$299/year, Spotlight-$699/year)
3. 2-year plans with additional discounts
4. 2-week free trial for all new contractors
5. Upgrade/downgrade functionality with billing cycle management
6. Feature comparison table with clear benefits
7. Price management system for admin
8. Promotional codes and temporary discounts

## Tasks / Subtasks

- [ ] Create subscription management API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Implement `/api/subscriptions` endpoint for subscription CRUD operations
  - [ ] Implement `/api/subscriptions/tiers` endpoint for subscription tiers
  - [ ] Implement `/api/subscriptions/pricing` endpoint for pricing management
  - [ ] Implement `/api/subscriptions/trial` endpoint for trial management
  - [ ] Implement `/api/subscriptions/upgrade` endpoint for upgrade functionality
  - [ ] Implement `/api/subscriptions/downgrade` endpoint for downgrade functionality
  - [ ] Implement `/api/subscriptions/promotional` endpoint for promotional codes
  - [ ] Implement `/api/subscriptions/features` endpoint for feature access
  - [ ] Add proper subscription validation and error handling
  - [ ] Add subscription billing cycle management
- [ ] Build subscription management UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `SubscriptionManagement` component for main subscription interface
  - [ ] Create `SubscriptionTiers` component for tier selection
  - [ ] Create `PricingDisplay` component for pricing information
  - [ ] Create `TrialManagement` component for trial functionality
  - [ ] Create `UpgradeDowngrade` component for subscription changes
  - [ ] Create `FeatureComparison` component for feature comparison table
  - [ ] Create `PromotionalCodes` component for promotional code management
  - [ ] Create `BillingCycle` component for billing cycle management
  - [ ] Create `SubscriptionAnalytics` component for subscription analytics
  - [ ] Add subscription loading states and error handling
- [ ] Implement three-tier subscription system (AC: 1, 2, 3, 6)
  - [ ] Create Essential-Free tier with basic features
  - [ ] Create Showcase-$29/month tier with enhanced features
  - [ ] Create Spotlight-$69/month tier with premium features
  - [ ] Add annual pricing with discounts (Showcase-$299/year, Spotlight-$699/year)
  - [ ] Add 2-year plans with additional discounts
  - [ ] Create feature comparison table with clear benefits
  - [ ] Add tier-specific feature access control
  - [ ] Implement tier validation and error handling
- [ ] Set up free trial system (AC: 4, 5, 6)
  - [ ] Create 2-week free trial for all new contractors
  - [ ] Add trial period tracking and management
  - [ ] Implement trial expiration handling
  - [ ] Add trial conversion tracking and analytics
  - [ ] Create trial notification system
  - [ ] Add trial extension functionality
  - [ ] Implement trial validation and error handling
  - [ ] Add trial performance monitoring
- [ ] Create upgrade/downgrade functionality (AC: 5, 6, 7)
  - [ ] Create subscription upgrade process
  - [ ] Add subscription downgrade process
  - [ ] Implement billing cycle management
  - [ ] Add proration calculations for mid-cycle changes
  - [ ] Create upgrade/downgrade validation
  - [ ] Add upgrade/downgrade notifications
  - [ ] Implement upgrade/downgrade analytics
  - [ ] Add upgrade/downgrade error handling
- [ ] Implement feature comparison system (AC: 6, 7)
  - [ ] Create feature comparison table
  - [ ] Add tier-specific feature descriptions
  - [ ] Implement feature access validation
  - [ ] Add feature comparison analytics
  - [ ] Create feature comparison customization
  - [ ] Add feature comparison performance optimization
  - [ ] Implement feature comparison accessibility
  - [ ] Add feature comparison mobile optimization
- [ ] Set up price management system (AC: 7, 8)
  - [ ] Create admin price management interface
  - [ ] Add pricing update functionality
  - [ ] Implement pricing validation and rules
  - [ ] Add pricing history and audit trail
  - [ ] Create pricing analytics and insights
  - [ ] Add pricing performance monitoring
  - [ ] Implement pricing security and access control
  - [ ] Add pricing error handling and recovery
- [ ] Create promotional codes system (AC: 8)
  - [ ] Create promotional code generation and management
  - [ ] Add promotional code validation and application
  - [ ] Implement promotional code analytics and tracking
  - [ ] Add promotional code expiration and limits
  - [ ] Create promotional code security and fraud prevention
  - [ ] Add promotional code performance optimization
  - [ ] Implement promotional code error handling
  - [ ] Add promotional code user experience optimization
- [ ] Create subscription management pages (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `/subscriptions` page for subscription management
  - [ ] Create `/subscriptions/tiers` page for tier selection
  - [ ] Create `/subscriptions/pricing` page for pricing information
  - [ ] Create `/subscriptions/trial` page for trial management
  - [ ] Create `/admin/subscriptions` page for admin management
  - [ ] Add subscription navigation and breadcrumbs
  - [ ] Implement subscription routing and state management
  - [ ] Add subscription page metadata and SEO

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)
- **Story 5.1**: Event creation wizard (for event creation integration)
- **Story 5.2**: AI-powered service recommendations (for service recommendations)
- **Story 5.3**: Budget planning & recommendations (for budget integration)
- **Story 5.4**: Intelligent contractor matching (for contractor matching)
- **Story 5.5**: Event management & status tracking (for event management)

The subscription management system will use the existing user management and admin systems to provide comprehensive subscription functionality.

### Data Models

[Source: architecture/data-models.md#user]
The subscription management system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE
- `subscription_tier` subscription_tier DEFAULT 'essential'

**Subscription Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `tier` subscription_tier NOT NULL
- `status` subscription_status NOT NULL
- `billing_cycle` billing_cycle NOT NULL
- `price` DECIMAL(10,2) NOT NULL
- `start_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `end_date` TIMESTAMP WITH TIME ZONE
- `trial_end_date` TIMESTAMP WITH TIME ZONE
- `promotional_code` TEXT
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**PromotionalCode Table (to be created):**

- `id` UUID PRIMARY KEY
- `code` TEXT UNIQUE NOT NULL
- `discount_type` discount_type NOT NULL
- `discount_value` DECIMAL(10,2) NOT NULL
- `tier_applicable` subscription_tier[]
- `usage_limit` INTEGER
- `usage_count` INTEGER DEFAULT 0
- `expires_at` TIMESTAMP WITH TIME ZONE
- `is_active` BOOLEAN DEFAULT TRUE
- `created_by` UUID REFERENCES users(id)
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**SubscriptionFeature Table (to be created):**

- `id` UUID PRIMARY KEY
- `tier` subscription_tier NOT NULL
- `feature_name` TEXT NOT NULL
- `feature_description` TEXT
- `is_included` BOOLEAN DEFAULT TRUE
- `limit_value` INTEGER
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#subscription-endpoints]
The subscription management system will implement the following API endpoints:

**Subscription Management:**

- `GET /api/subscriptions`

  - Query: `{ user_id?, tier?, status? }`
  - Response: `{ subscriptions: Subscription[], total: number }`

- `POST /api/subscriptions`

  - Body: `{ tier, billing_cycle, promotional_code? }`
  - Response: `{ subscription: Subscription, success: boolean }`

- `PUT /api/subscriptions/{id}`
  - Body: `{ tier?, billing_cycle?, status? }`
  - Response: `{ subscription: Subscription, success: boolean }`

**Subscription Tiers:**

- `GET /api/subscriptions/tiers`

  - Response: `{ tiers: SubscriptionTier[], features: SubscriptionFeature[] }`

- `GET /api/subscriptions/tiers/{tier}/features`
  - Response: `{ features: SubscriptionFeature[] }`

**Pricing Management:**

- `GET /api/subscriptions/pricing`

  - Query: `{ tier, billing_cycle? }`
  - Response: `{ pricing: PricingInfo, discounts: DiscountInfo[] }`

- `POST /api/subscriptions/pricing/calculate`
  - Body: `{ tier, billing_cycle, promotional_code? }`
  - Response: `{ total_price: number, discount_applied: number, final_price: number }`

**Trial Management:**

- `POST /api/subscriptions/trial/start`

  - Body: `{ tier }`
  - Response: `{ trial: TrialInfo, success: boolean }`

- `GET /api/subscriptions/trial/status`
  - Query: `{ user_id }`
  - Response: `{ trial: TrialInfo, days_remaining: number }`

**Upgrade/Downgrade:**

- `POST /api/subscriptions/{id}/upgrade`

  - Body: `{ new_tier, effective_date? }`
  - Response: `{ subscription: Subscription, proration: ProrationInfo }`

- `POST /api/subscriptions/{id}/downgrade`
  - Body: `{ new_tier, effective_date? }`
  - Response: `{ subscription: Subscription, proration: ProrationInfo }`

**Promotional Codes:**

- `GET /api/subscriptions/promotional`

  - Query: `{ code?, tier? }`
  - Response: `{ codes: PromotionalCode[] }`

- `POST /api/subscriptions/promotional/validate`
  - Body: `{ code, tier }`
  - Response: `{ valid: boolean, discount: DiscountInfo }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The subscription management system will use the following components:

**Subscription Components:**

- `SubscriptionManagement` - Main subscription management interface
- `SubscriptionTiers` - Subscription tier selection and display
- `PricingDisplay` - Pricing information and calculations
- `TrialManagement` - Trial period management and tracking
- `UpgradeDowngrade` - Subscription upgrade/downgrade functionality
- `FeatureComparison` - Feature comparison table
- `PromotionalCodes` - Promotional code management
- `BillingCycle` - Billing cycle management
- `SubscriptionAnalytics` - Subscription analytics and insights
- `TierSelector` - Tier selection interface
- `PricingCalculator` - Pricing calculation and display
- `TrialTracker` - Trial period tracking
- `FeatureAccess` - Feature access control and validation
- `PromotionalCodeInput` - Promotional code input and validation
- `BillingHistory` - Billing history and invoices

**Subscription Features:**

- Three-tier system (Essential-Free, Showcase-$29/month, Spotlight-$69/month)
- Annual pricing with discounts (Showcase-$299/year, Spotlight-$699/year)
- 2-year plans with additional discounts
- 2-week free trial for all new contractors
- Upgrade/downgrade functionality with billing cycle management
- Feature comparison table with clear benefits
- Price management system for admin
- Promotional codes and temporary discounts

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/subscriptions/page.tsx` - Subscription management page
- `app/subscriptions/tiers/page.tsx` - Tier selection page
- `app/subscriptions/pricing/page.tsx` - Pricing information page
- `app/subscriptions/trial/page.tsx` - Trial management page
- `app/admin/subscriptions/page.tsx` - Admin subscription management
- `components/features/subscriptions/` - Subscription components
- `components/features/subscriptions/SubscriptionManagement.tsx` - Main management
- `components/features/subscriptions/SubscriptionTiers.tsx` - Tier selection
- `components/features/subscriptions/PricingDisplay.tsx` - Pricing display
- `components/features/subscriptions/TrialManagement.tsx` - Trial management
- `components/features/subscriptions/UpgradeDowngrade.tsx` - Upgrade/downgrade
- `components/features/subscriptions/FeatureComparison.tsx` - Feature comparison
- `components/features/subscriptions/PromotionalCodes.tsx` - Promotional codes
- `components/features/subscriptions/BillingCycle.tsx` - Billing cycle
- `components/features/subscriptions/SubscriptionAnalytics.tsx` - Analytics
- `components/features/subscriptions/TierSelector.tsx` - Tier selector
- `components/features/subscriptions/PricingCalculator.tsx` - Pricing calculator
- `components/features/subscriptions/TrialTracker.tsx` - Trial tracker
- `components/features/subscriptions/FeatureAccess.tsx` - Feature access
- `components/features/subscriptions/PromotionalCodeInput.tsx` - Promotional input
- `components/features/subscriptions/BillingHistory.tsx` - Billing history
- `lib/subscriptions/` - Subscription utilities and services
- `lib/subscriptions/subscription-service.ts` - Subscription service
- `lib/subscriptions/pricing-service.ts` - Pricing service
- `lib/subscriptions/trial-service.ts` - Trial service
- `lib/subscriptions/promotional-service.ts` - Promotional service
- `lib/subscriptions/billing-service.ts` - Billing service
- `hooks/useSubscription.ts` - Subscription hook
- `stores/subscription.ts` - Subscription state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Payment Integration**: Stripe payment processing integration
- **Security**: Secure subscription data handling and validation
- **Validation**: Input validation for subscription operations
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Performance**: Optimized subscription calculations and caching
- **Accessibility**: WCAG 2.1 AA compliance for subscription interfaces
- **Compliance**: PCI compliance for payment processing

### Subscription Tiers

**Tier Features:**

- Essential-Free: Basic features, limited functionality
- Showcase-$29/month: Enhanced features, increased visibility
- Spotlight-$69/month: Premium features, maximum visibility
- Annual pricing with discounts (Showcase-$299/year, Spotlight-$699/year)
- 2-year plans with additional discounts

**Tier Implementation:**

```typescript
// Example subscription tier configuration
interface SubscriptionTier {
  id: string;
  name: string;
  price: number;
  billing_cycle: "monthly" | "yearly" | "2year";
  features: SubscriptionFeature[];
  limits: SubscriptionLimits;
  is_trial_eligible: boolean;
}
```

### Trial Management

**Trial Features:**

- 2-week free trial for all new contractors
- Trial period tracking and management
- Trial expiration handling
- Trial conversion tracking and analytics
- Trial notification system
- Trial extension functionality

**Trial Implementation:**

- Trial period calculation and tracking
- Trial expiration notifications
- Trial conversion analytics
- Trial extension management
- Trial performance monitoring

### Promotional Codes

**Promotional Features:**

- Promotional code generation and management
- Promotional code validation and application
- Promotional code analytics and tracking
- Promotional code expiration and limits
- Promotional code security and fraud prevention

**Promotional Implementation:**

- Code generation algorithms
- Code validation and application
- Usage tracking and limits
- Expiration management
- Security and fraud prevention

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for subscription components
- **API Testing**: Jest + Supertest for subscription endpoints
- **E2E Testing**: Playwright for complete subscription flows
- **Payment Testing**: Test Stripe integration and payment processing
- **Trial Testing**: Test trial management and conversion
- **Test File Location**: `__tests__/subscriptions/` directory
- **Test Scenarios**: Subscription management, tier selection, pricing, trial, upgrade/downgrade, promotional codes
- **Coverage Requirements**: 80% coverage for subscription logic and components

### Performance Considerations

**Subscription Performance:**

- Optimized subscription calculations and caching
- Efficient pricing calculations
- Trial management optimization
- Promotional code validation optimization
- Billing cycle management optimization
- Mobile subscription interface optimization

**Data Management:**

- Subscription data caching and persistence
- Pricing data management and updates
- Trial data optimization
- Promotional code data management
- Billing data optimization
- Analytics data processing

### State Management

[Source: architecture/components.md#state-management-architecture]
**Subscription State Management:**

```typescript
interface SubscriptionStore {
  currentSubscription: Subscription | null;
  availableTiers: SubscriptionTier[];
  features: SubscriptionFeature[];
  pricing: PricingInfo;
  trial: TrialInfo | null;
  promotionalCodes: PromotionalCode[];
  isLoading: boolean;
  loadSubscription: (userId: string) => Promise<void>;
  loadTiers: () => Promise<void>;
  loadFeatures: (tier: string) => Promise<void>;
  calculatePricing: (
    tier: string,
    billing_cycle: string,
    promotional_code?: string
  ) => Promise<void>;
  startTrial: (tier: string) => Promise<void>;
  upgradeSubscription: (newTier: string, effectiveDate?: Date) => Promise<void>;
  downgradeSubscription: (
    newTier: string,
    effectiveDate?: Date
  ) => Promise<void>;
  applyPromotionalCode: (code: string) => Promise<void>;
  validateFeatureAccess: (feature: string) => boolean;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
