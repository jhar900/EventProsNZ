# Story 5.3: Budget Planning & Recommendations

## Status

Draft

## Story

**As an** event manager,  
**I want** to receive realistic budget recommendations,  
**so that** I can plan my event finances effectively.

## Acceptance Criteria

1. Overall event budget recommendations
2. Service-specific budget breakdowns
3. Budget adjustment and customization
4. Historical pricing data and industry averages integration
5. Real-time pricing from contractor data
6. Seasonal adjustments for pricing
7. Location-based cost variations
8. Package deals and discounts
9. Budget tracking with actual vs. estimated costs for learning
10. Cost-saving suggestions and alternatives
11. Budget validation and warnings

## Tasks / Subtasks

- [ ] Create budget planning API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Implement `/api/budget/recommendations` endpoint for budget recommendations
  - [ ] Implement `/api/budget/breakdown` endpoint for service-specific breakdowns
  - [ ] Implement `/api/budget/pricing` endpoint for real-time pricing
  - [ ] Implement `/api/budget/historical` endpoint for historical pricing data
  - [ ] Implement `/api/budget/seasonal` endpoint for seasonal adjustments
  - [ ] Implement `/api/budget/location` endpoint for location-based variations
  - [ ] Implement `/api/budget/packages` endpoint for package deals
  - [ ] Implement `/api/budget/tracking` endpoint for budget tracking
  - [ ] Add proper budget validation and error handling
  - [ ] Add budget calculation caching and performance optimization
- [ ] Build budget planning UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `BudgetPlanning` component for main budget interface
  - [ ] Create `BudgetRecommendations` component for overall recommendations
  - [ ] Create `ServiceBudgetBreakdown` component for service-specific breakdowns
  - [ ] Create `BudgetAdjustment` component for budget customization
  - [ ] Create `PricingDataDisplay` component for pricing information
  - [ ] Create `SeasonalAdjustments` component for seasonal pricing
  - [ ] Create `LocationVariations` component for location-based costs
  - [ ] Create `PackageDeals` component for package deals and discounts
  - [ ] Create `BudgetTracking` component for actual vs. estimated tracking
  - [ ] Create `CostSavingSuggestions` component for cost-saving alternatives
  - [ ] Create `BudgetValidation` component for budget validation and warnings
  - [ ] Add budget planning loading states and error handling
- [ ] Implement overall budget recommendations (AC: 1, 4, 5, 6, 7)
  - [ ] Create overall event budget calculation algorithm
  - [ ] Add historical pricing data integration
  - [ ] Implement real-time pricing from contractor data
  - [ ] Add seasonal adjustments for pricing
  - [ ] Create location-based cost variations
  - [ ] Add budget recommendation validation
  - [ ] Implement budget recommendation caching
  - [ ] Add budget recommendation performance optimization
- [ ] Set up service-specific budget breakdowns (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create service-specific budget calculation
  - [ ] Add service pricing data integration
  - [ ] Implement service budget adjustment and customization
  - [ ] Add service package deals and discounts
  - [ ] Create service cost variation calculations
  - [ ] Add service budget validation
  - [ ] Implement service budget tracking
  - [ ] Add service budget analytics and insights
- [ ] Create budget adjustment and customization (AC: 3, 8, 10, 11)
  - [ ] Create budget adjustment interface
  - [ ] Add budget customization options
  - [ ] Implement package deals and discounts
  - [ ] Add cost-saving suggestions and alternatives
  - [ ] Create budget validation and warnings
  - [ ] Add budget adjustment analytics
  - [ ] Implement budget adjustment tracking
  - [ ] Add budget adjustment performance optimization
- [ ] Implement historical pricing data integration (AC: 4, 5, 6, 7, 9)
  - [ ] Create historical pricing data collection
  - [ ] Add industry averages integration
  - [ ] Implement pricing trend analysis
  - [ ] Add pricing data validation and cleaning
  - [ ] Create pricing data caching and optimization
  - [ ] Add pricing data analytics and insights
  - [ ] Implement pricing data updates and synchronization
  - [ ] Add pricing data performance monitoring
- [ ] Set up real-time pricing integration (AC: 5, 6, 7, 8, 9)
  - [ ] Create real-time pricing data collection
  - [ ] Add contractor pricing data integration
  - [ ] Implement pricing data updates and synchronization
  - [ ] Add pricing data validation and error handling
  - [ ] Create pricing data caching and optimization
  - [ ] Add pricing data analytics and insights
  - [ ] Implement pricing data performance monitoring
  - [ ] Add pricing data security and privacy
- [ ] Create seasonal and location adjustments (AC: 6, 7, 9)
  - [ ] Create seasonal pricing adjustment algorithm
  - [ ] Add location-based cost variation calculations
  - [ ] Implement seasonal and location data integration
  - [ ] Add seasonal and location adjustment validation
  - [ ] Create seasonal and location adjustment caching
  - [ ] Add seasonal and location adjustment analytics
  - [ ] Implement seasonal and location adjustment updates
  - [ ] Add seasonal and location adjustment performance optimization
- [ ] Implement budget tracking and learning (AC: 9, 10, 11)
  - [ ] Create budget tracking system for actual vs. estimated costs
  - [ ] Add budget learning algorithm for improvement
  - [ ] Implement cost-saving suggestions and alternatives
  - [ ] Add budget validation and warnings
  - [ ] Create budget tracking analytics and insights
  - [ ] Add budget tracking performance monitoring
  - [ ] Implement budget tracking data management
  - [ ] Add budget tracking security and privacy
- [ ] Create budget planning pages (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `/events/create/budget` page for budget planning
  - [ ] Create `/budget/recommendations` page for budget recommendations
  - [ ] Create `/budget/tracking` page for budget tracking
  - [ ] Create `/budget/analytics` page for budget analytics
  - [ ] Add budget planning navigation and breadcrumbs
  - [ ] Implement budget planning routing and state management
  - [ ] Add budget planning page metadata and SEO
  - [ ] Create budget planning sharing and collaboration

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)
- **Story 5.1**: Event creation wizard (for event creation integration)
- **Story 5.2**: AI-powered service recommendations (for service recommendations)

The budget planning system will use the existing contractor data, pricing information, and event creation system to provide intelligent budget recommendations.

### Data Models

[Source: architecture/data-models.md#user]
The budget planning system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**Event Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `event_type` TEXT NOT NULL
- `title` TEXT NOT NULL
- `description` TEXT
- `event_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `duration_hours` INTEGER
- `attendee_count` INTEGER
- `location` JSON
- `budget_total` DECIMAL(10,2)
- `status` event_status DEFAULT 'draft'
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**BudgetRecommendation Table (to be created):**

- `id` UUID PRIMARY KEY
- `event_type` TEXT NOT NULL
- `service_category` TEXT NOT NULL
- `recommended_amount` DECIMAL(10,2) NOT NULL
- `confidence_score` DECIMAL(3,2)
- `pricing_source` TEXT NOT NULL
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**PricingData Table (to be created):**

- `id` UUID PRIMARY KEY
- `service_type` TEXT NOT NULL
- `location` JSON
- `price_min` DECIMAL(10,2) NOT NULL
- `price_max` DECIMAL(10,2) NOT NULL
- `price_average` DECIMAL(10,2) NOT NULL
- `seasonal_multiplier` DECIMAL(3,2) DEFAULT 1.0
- `location_multiplier` DECIMAL(3,2) DEFAULT 1.0
- `data_source` TEXT NOT NULL
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**BudgetTracking Table (to be created):**

- `id` UUID PRIMARY KEY
- `event_id` UUID REFERENCES events(id) ON DELETE CASCADE
- `service_category` TEXT NOT NULL
- `estimated_cost` DECIMAL(10,2) NOT NULL
- `actual_cost` DECIMAL(10,2)
- `variance` DECIMAL(10,2)
- `tracking_date` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#budget-endpoints]
The budget planning system will implement the following API endpoints:

**Budget Recommendations:**

- `GET /api/budget/recommendations`
  - Query: `{ event_type, location?, attendee_count?, duration? }`
  - Response: `{ recommendations: BudgetRecommendation[], total_budget: number }`

- `POST /api/budget/recommendations/feedback`
  - Body: `{ recommendation_id, feedback_type, rating, comments? }`
  - Response: `{ success: boolean, updated_recommendation: BudgetRecommendation }`

**Service Budget Breakdown:**

- `GET /api/budget/breakdown`
  - Query: `{ event_id, service_categories? }`
  - Response: `{ breakdown: ServiceBudgetBreakdown[], total: number }`

- `PUT /api/budget/breakdown`
  - Body: `{ event_id, service_categories, adjustments }`
  - Response: `{ breakdown: ServiceBudgetBreakdown[], success: boolean }`

**Pricing Data:**

- `GET /api/budget/pricing`
  - Query: `{ service_type, location?, seasonal? }`
  - Response: `{ pricing: PricingData, real_time: boolean }`

- `GET /api/budget/historical`
  - Query: `{ service_type, location?, time_period? }`
  - Response: `{ historical_pricing: HistoricalPricing[], trends: PricingTrend[] }`

**Budget Tracking:**

- `GET /api/budget/tracking`
  - Query: `{ event_id }`
  - Response: `{ tracking: BudgetTracking[], insights: BudgetInsights }`

- `POST /api/budget/tracking`
  - Body: `{ event_id, service_category, actual_cost }`
  - Response: `{ tracking: BudgetTracking, success: boolean }`

**Package Deals:**

- `GET /api/budget/packages`
  - Query: `{ event_type, location?, service_categories? }`
  - Response: `{ packages: PackageDeal[], savings: number }`

- `POST /api/budget/packages/apply`
  - Body: `{ event_id, package_id }`
  - Response: `{ applied_package: PackageDeal, success: boolean }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The budget planning system will use the following components:

**Budget Planning Components:**

- `BudgetPlanning` - Main budget planning interface
- `BudgetRecommendations` - Overall budget recommendations
- `ServiceBudgetBreakdown` - Service-specific budget breakdowns
- `BudgetAdjustment` - Budget adjustment and customization
- `PricingDataDisplay` - Pricing information display
- `SeasonalAdjustments` - Seasonal pricing adjustments
- `LocationVariations` - Location-based cost variations
- `PackageDeals` - Package deals and discounts
- `BudgetTracking` - Actual vs. estimated cost tracking
- `CostSavingSuggestions` - Cost-saving alternatives
- `BudgetValidation` - Budget validation and warnings
- `BudgetAnalytics` - Budget analytics and insights
- `PricingTrends` - Pricing trend visualization
- `BudgetComparison` - Budget comparison tools
- `BudgetExport` - Budget export functionality

**Budget Features:**

- Overall event budget recommendations
- Service-specific budget breakdowns
- Budget adjustment and customization
- Historical pricing data integration
- Real-time pricing from contractor data
- Seasonal and location-based adjustments
- Package deals and discounts
- Budget tracking and learning
- Cost-saving suggestions and alternatives
- Budget validation and warnings

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/events/create/budget/page.tsx` - Budget planning page
- `app/budget/recommendations/page.tsx` - Budget recommendations page
- `app/budget/tracking/page.tsx` - Budget tracking page
- `app/budget/analytics/page.tsx` - Budget analytics page
- `components/features/budget/` - Budget planning components
- `components/features/budget/BudgetPlanning.tsx` - Main budget interface
- `components/features/budget/BudgetRecommendations.tsx` - Budget recommendations
- `components/features/budget/ServiceBudgetBreakdown.tsx` - Service breakdowns
- `components/features/budget/BudgetAdjustment.tsx` - Budget adjustment
- `components/features/budget/PricingDataDisplay.tsx` - Pricing display
- `components/features/budget/SeasonalAdjustments.tsx` - Seasonal adjustments
- `components/features/budget/LocationVariations.tsx` - Location variations
- `components/features/budget/PackageDeals.tsx` - Package deals
- `components/features/budget/BudgetTracking.tsx` - Budget tracking
- `components/features/budget/CostSavingSuggestions.tsx` - Cost savings
- `components/features/budget/BudgetValidation.tsx` - Budget validation
- `components/features/budget/BudgetAnalytics.tsx` - Budget analytics
- `components/features/budget/PricingTrends.tsx` - Pricing trends
- `components/features/budget/BudgetComparison.tsx` - Budget comparison
- `components/features/budget/BudgetExport.tsx` - Budget export
- `lib/budget/` - Budget utilities and services
- `lib/budget/budget-service.ts` - Budget service
- `lib/budget/pricing-service.ts` - Pricing service
- `lib/budget/tracking-service.ts` - Tracking service
- `lib/budget/package-service.ts` - Package service
- `hooks/useBudgetPlanning.ts` - Budget planning hook
- `stores/budget-planning.ts` - Budget planning state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Form Library**: React Hook Form with Zod validation
- **UI Library**: shadcn/ui with Tailwind CSS
- **State Management**: Zustand for budget planning state
- **Validation**: Zod schemas for budget data validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Security**: Secure budget data handling and validation
- **Performance**: Optimized budget calculations and caching
- **Accessibility**: WCAG 2.1 AA compliance for budget interfaces

### Budget Calculation Engine

**Budget Features:**

- Overall event budget recommendations
- Service-specific budget breakdowns
- Historical pricing data integration
- Real-time pricing from contractor data
- Seasonal adjustments for pricing
- Location-based cost variations
- Package deals and discounts
- Budget tracking and learning

**Budget Implementation:**

```typescript
// Example budget calculation service
interface BudgetCalculationService {
  calculateOverallBudget(
    eventType: string,
    location: Location,
    attendeeCount: number
  ): Promise<BudgetRecommendation>;
  calculateServiceBreakdown(
    eventId: string,
    services: string[]
  ): Promise<ServiceBudgetBreakdown[]>;
  getPricingData(
    serviceType: string,
    location?: Location
  ): Promise<PricingData>;
  applySeasonalAdjustments(
    pricing: PricingData,
    eventDate: Date
  ): Promise<PricingData>;
  applyLocationVariations(
    pricing: PricingData,
    location: Location
  ): Promise<PricingData>;
  findPackageDeals(
    eventType: string,
    services: string[]
  ): Promise<PackageDeal[]>;
  trackBudgetVariance(
    eventId: string,
    actualCosts: Record<string, number>
  ): Promise<BudgetTracking>;
}
```

### Pricing Data Integration

**Pricing Features:**

- Historical pricing data collection and analysis
- Real-time pricing from contractor data
- Industry averages integration
- Pricing trend analysis and visualization
- Seasonal pricing adjustments
- Location-based cost variations
- Pricing data validation and cleaning
- Pricing data caching and optimization

**Pricing Implementation:**

- Contractor pricing data integration
- Historical pricing data collection
- Pricing trend analysis
- Seasonal adjustment algorithms
- Location-based cost calculations
- Pricing data validation and cleaning
- Pricing data caching and optimization

### Budget Tracking and Learning

**Tracking Features:**

- Actual vs. estimated cost tracking
- Budget variance analysis
- Cost-saving suggestions and alternatives
- Budget learning algorithm for improvement
- Budget validation and warnings
- Budget analytics and insights
- Budget performance monitoring

**Tracking Implementation:**

- Budget tracking data collection
- Variance analysis and reporting
- Cost-saving suggestion algorithms
- Budget learning and improvement
- Budget validation and warnings
- Budget analytics and insights

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for budget components
- **API Testing**: Jest + Supertest for budget endpoints
- **E2E Testing**: Playwright for complete budget planning flows
- **Budget Testing**: Test budget calculations and recommendations
- **Pricing Testing**: Test pricing data integration and accuracy
- **Test File Location**: `__tests__/budget/` directory
- **Test Scenarios**: Budget planning, recommendations, tracking, pricing, packages
- **Coverage Requirements**: 80% coverage for budget logic and components

### Performance Considerations

**Budget Performance:**

- Optimized budget calculations and caching
- Efficient pricing data processing
- Budget tracking performance optimization
- Package deal calculation optimization
- Mobile budget planning optimization
- Budget analytics performance optimization

**Data Management:**

- Budget data caching and persistence
- Pricing data management and updates
- Budget tracking data optimization
- Package deal data caching
- Budget analytics data processing
- Real-time budget updates optimization

### State Management

[Source: architecture/components.md#state-management-architecture]
**Budget Planning State Management:**

```typescript
interface BudgetPlanningStore {
  recommendations: BudgetRecommendation[];
  breakdown: ServiceBudgetBreakdown[];
  pricingData: PricingData[];
  tracking: BudgetTracking[];
  packages: PackageDeal[];
  adjustments: BudgetAdjustment[];
  isLoading: boolean;
  getRecommendations: (eventType: string, location: Location) => Promise<void>;
  getBreakdown: (eventId: string) => Promise<void>;
  getPricingData: (serviceType: string, location?: Location) => Promise<void>;
  applyAdjustments: (adjustments: BudgetAdjustment[]) => Promise<void>;
  trackBudget: (
    eventId: string,
    actualCosts: Record<string, number>
  ) => Promise<void>;
  findPackages: (eventType: string, services: string[]) => Promise<void>;
  exportBudget: (format: string) => Promise<Blob>;
  validateBudget: (budget: BudgetPlan) => boolean;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results
