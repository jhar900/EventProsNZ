# Story 6.2: Payment Processing Integration

## Status

Draft

## Story

**As a** contractor,  
**I want** to make secure payments for my subscription,  
**so that** I can access premium platform features.

## Acceptance Criteria

1. Stripe payment processing integration
2. Secure payment form with validation
3. Multiple payment method support (credit cards primary)
4. Bank transfer fallback via admin
5. Payment confirmation and receipts
6. Failed payment handling with 7-day grace period
7. Email notifications on days 3, 6, and 7 for payment failures
8. Payment security and compliance

## Tasks / Subtasks

- [ ] Create payment processing API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Implement `/api/payments/stripe` endpoint for Stripe integration
  - [ ] Implement `/api/payments/methods` endpoint for payment methods
  - [ ] Implement `/api/payments/process` endpoint for payment processing
  - [ ] Implement `/api/payments/confirm` endpoint for payment confirmation
  - [ ] Implement `/api/payments/receipts` endpoint for receipt generation
  - [ ] Implement `/api/payments/failed` endpoint for failed payment handling
  - [ ] Implement `/api/payments/notifications` endpoint for payment notifications
  - [ ] Implement `/api/payments/bank-transfer` endpoint for bank transfer fallback
  - [ ] Add proper payment validation and error handling
  - [ ] Add payment security and compliance measures
- [ ] Build payment processing UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `PaymentForm` component for secure payment form
  - [ ] Create `PaymentMethods` component for payment method selection
  - [ ] Create `StripeIntegration` component for Stripe payment processing
  - [ ] Create `PaymentConfirmation` component for payment confirmation
  - [ ] Create `PaymentReceipts` component for receipt display
  - [ ] Create `FailedPaymentHandler` component for failed payment handling
  - [ ] Create `PaymentNotifications` component for payment notifications
  - [ ] Create `BankTransferFallback` component for bank transfer option
  - [ ] Create `PaymentSecurity` component for security indicators
  - [ ] Add payment loading states and error handling
- [ ] Implement Stripe payment processing (AC: 1, 2, 3, 5, 8)
  - [ ] Create Stripe payment intent creation
  - [ ] Add Stripe payment method attachment
  - [ ] Implement Stripe payment confirmation
  - [ ] Add Stripe webhook handling
  - [ ] Create Stripe payment validation
  - [ ] Add Stripe payment security measures
  - [ ] Implement Stripe payment error handling
  - [ ] Add Stripe payment analytics and tracking
- [ ] Set up secure payment form (AC: 2, 3, 8)
  - [ ] Create secure payment form with validation
  - [ ] Add multiple payment method support (credit cards primary)
  - [ ] Implement payment form security measures
  - [ ] Add payment form validation and error handling
  - [ ] Create payment form accessibility features
  - [ ] Add payment form mobile optimization
  - [ ] Implement payment form performance optimization
  - [ ] Add payment form user experience enhancements
- [ ] Create payment confirmation system (AC: 5, 6, 7)
  - [ ] Create payment confirmation display
  - [ ] Add payment receipt generation and display
  - [ ] Implement payment confirmation notifications
  - [ ] Add payment confirmation validation
  - [ ] Create payment confirmation analytics
  - [ ] Add payment confirmation error handling
  - [ ] Implement payment confirmation performance optimization
  - [ ] Add payment confirmation accessibility features
- [ ] Implement failed payment handling (AC: 6, 7)
  - [ ] Create failed payment detection and handling
  - [ ] Add 7-day grace period for failed payments
  - [ ] Implement email notifications on days 3, 6, and 7
  - [ ] Add failed payment retry functionality
  - [ ] Create failed payment analytics and tracking
  - [ ] Add failed payment user notifications
  - [ ] Implement failed payment recovery options
  - [ ] Add failed payment performance monitoring
- [ ] Set up bank transfer fallback (AC: 4, 5, 6, 7)
  - [ ] Create bank transfer fallback option
  - [ ] Add admin bank transfer processing
  - [ ] Implement bank transfer confirmation
  - [ ] Add bank transfer receipt generation
  - [ ] Create bank transfer validation
  - [ ] Add bank transfer notifications
  - [ ] Implement bank transfer analytics
  - [ ] Add bank transfer error handling
- [ ] Create payment security and compliance (AC: 8)
  - [ ] Implement PCI compliance measures
  - [ ] Add payment data encryption
  - [ ] Create payment security monitoring
  - [ ] Add payment fraud detection
  - [ ] Implement payment audit logging
  - [ ] Add payment security headers
  - [ ] Create payment compliance reporting
  - [ ] Add payment security testing
- [ ] Create payment processing pages (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `/payments` page for payment processing
  - [ ] Create `/payments/methods` page for payment methods
  - [ ] Create `/payments/confirm` page for payment confirmation
  - [ ] Create `/payments/receipts` page for payment receipts
  - [ ] Create `/payments/failed` page for failed payment handling
  - [ ] Add payment navigation and breadcrumbs
  - [ ] Implement payment routing and state management
  - [ ] Add payment page metadata and SEO

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)
- **Story 5.1**: Event creation wizard (for event creation integration)
- **Story 5.2**: AI-powered service recommendations (for service recommendations)
- **Story 5.3**: Budget planning & recommendations (for budget integration)
- **Story 5.4**: Intelligent contractor matching (for contractor matching)
- **Story 5.5**: Event management & status tracking (for event management)
- **Story 6.1**: Subscription management system (for subscription integration)

The payment processing system will use the existing subscription management system to provide secure payment processing for contractor subscriptions.

### Data Models

[Source: architecture/data-models.md#user]
The payment processing system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**Subscription Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `tier` subscription_tier NOT NULL
- `status` subscription_status NOT NULL
- `billing_cycle` billing_cycle NOT NULL
- `price` DECIMAL(10,2) NOT NULL
- `start_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `end_date` TIMESTAMP WITH TIME ZONE
- `trial_end_date` TIMESTAMP WITH TIME ZONE
- `promotional_code` TEXT
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Payment Table (to be created):**

- `id` UUID PRIMARY KEY
- `subscription_id` UUID REFERENCES subscriptions(id) ON DELETE CASCADE
- `stripe_payment_intent_id` TEXT
- `amount` DECIMAL(10,2) NOT NULL
- `currency` TEXT DEFAULT 'NZD'
- `status` payment_status NOT NULL
- `payment_method` TEXT NOT NULL
- `failure_reason` TEXT
- `receipt_url` TEXT
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**PaymentMethod Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `stripe_payment_method_id` TEXT UNIQUE NOT NULL
- `type` payment_method_type NOT NULL
- `last_four` TEXT NOT NULL
- `brand` TEXT
- `exp_month` INTEGER
- `exp_year` INTEGER
- `is_default` BOOLEAN DEFAULT FALSE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**FailedPayment Table (to be created):**

- `id` UUID PRIMARY KEY
- `payment_id` UUID REFERENCES payments(id) ON DELETE CASCADE
- `failure_count` INTEGER DEFAULT 1
- `grace_period_end` TIMESTAMP WITH TIME ZONE NOT NULL
- `notification_sent_days` INTEGER[] DEFAULT '{}'
- `retry_attempts` INTEGER DEFAULT 0
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#payment-endpoints]
The payment processing system will implement the following API endpoints:

**Payment Processing:**

- `POST /api/payments/stripe/create-intent`

  - Body: `{ subscription_id, amount, currency? }`
  - Response: `{ client_secret: string, payment_intent_id: string }`

- `POST /api/payments/stripe/confirm`
  - Body: `{ payment_intent_id, payment_method_id }`
  - Response: `{ payment: Payment, success: boolean }`

**Payment Methods:**

- `GET /api/payments/methods`

  - Query: `{ user_id }`
  - Response: `{ payment_methods: PaymentMethod[] }`

- `POST /api/payments/methods`

  - Body: `{ stripe_payment_method_id, type, is_default? }`
  - Response: `{ payment_method: PaymentMethod, success: boolean }`

- `DELETE /api/payments/methods/{id}`
  - Response: `{ success: boolean }`

**Payment Confirmation:**

- `GET /api/payments/confirm/{payment_intent_id}`

  - Response: `{ payment: Payment, receipt: ReceiptInfo }`

- `POST /api/payments/confirm/send-receipt`
  - Body: `{ payment_id, email? }`
  - Response: `{ receipt_url: string, success: boolean }`

**Failed Payment Handling:**

- `GET /api/payments/failed`

  - Query: `{ user_id?, status? }`
  - Response: `{ failed_payments: FailedPayment[] }`

- `POST /api/payments/failed/retry`
  - Body: `{ payment_id, payment_method_id? }`
  - Response: `{ payment: Payment, success: boolean }`

**Bank Transfer Fallback:**

- `POST /api/payments/bank-transfer`

  - Body: `{ subscription_id, amount, reference }`
  - Response: `{ bank_transfer: BankTransferInfo, success: boolean }`

- `GET /api/payments/bank-transfer/status/{id}`
  - Response: `{ status: string, payment: Payment }`

**Payment Notifications:**

- `POST /api/payments/notifications/send`

  - Body: `{ payment_id, notification_type }`
  - Response: `{ notification: PaymentNotification, success: boolean }`

- `GET /api/payments/notifications/history`
  - Query: `{ user_id, payment_id? }`
  - Response: `{ notifications: PaymentNotification[] }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The payment processing system will use the following components:

**Payment Components:**

- `PaymentForm` - Secure payment form with validation
- `PaymentMethods` - Payment method selection and management
- `StripeIntegration` - Stripe payment processing integration
- `PaymentConfirmation` - Payment confirmation and success display
- `PaymentReceipts` - Payment receipt generation and display
- `FailedPaymentHandler` - Failed payment handling and retry
- `PaymentNotifications` - Payment notification management
- `BankTransferFallback` - Bank transfer fallback option
- `PaymentSecurity` - Payment security indicators and compliance
- `PaymentValidation` - Payment form validation and error handling
- `PaymentLoading` - Payment processing loading states
- `PaymentError` - Payment error display and handling
- `PaymentSuccess` - Payment success confirmation
- `PaymentHistory` - Payment history and transaction display
- `PaymentAnalytics` - Payment analytics and insights

**Payment Features:**

- Stripe payment processing integration
- Secure payment form with validation
- Multiple payment method support (credit cards primary)
- Bank transfer fallback via admin
- Payment confirmation and receipts
- Failed payment handling with 7-day grace period
- Email notifications on days 3, 6, and 7 for payment failures
- Payment security and compliance

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/payments/page.tsx` - Payment processing page
- `app/payments/methods/page.tsx` - Payment methods page
- `app/payments/confirm/page.tsx` - Payment confirmation page
- `app/payments/receipts/page.tsx` - Payment receipts page
- `app/payments/failed/page.tsx` - Failed payment handling page
- `components/features/payments/` - Payment processing components
- `components/features/payments/PaymentForm.tsx` - Payment form
- `components/features/payments/PaymentMethods.tsx` - Payment methods
- `components/features/payments/StripeIntegration.tsx` - Stripe integration
- `components/features/payments/PaymentConfirmation.tsx` - Payment confirmation
- `components/features/payments/PaymentReceipts.tsx` - Payment receipts
- `components/features/payments/FailedPaymentHandler.tsx` - Failed payment handler
- `components/features/payments/PaymentNotifications.tsx` - Payment notifications
- `components/features/payments/BankTransferFallback.tsx` - Bank transfer fallback
- `components/features/payments/PaymentSecurity.tsx` - Payment security
- `components/features/payments/PaymentValidation.tsx` - Payment validation
- `components/features/payments/PaymentLoading.tsx` - Payment loading
- `components/features/payments/PaymentError.tsx` - Payment error
- `components/features/payments/PaymentSuccess.tsx` - Payment success
- `components/features/payments/PaymentHistory.tsx` - Payment history
- `components/features/payments/PaymentAnalytics.tsx` - Payment analytics
- `lib/payments/` - Payment utilities and services
- `lib/payments/stripe-service.ts` - Stripe service
- `lib/payments/payment-service.ts` - Payment service
- `lib/payments/method-service.ts` - Payment method service
- `lib/payments/receipt-service.ts` - Receipt service
- `lib/payments/notification-service.ts` - Notification service
- `hooks/usePayment.ts` - Payment hook
- `stores/payment.ts` - Payment state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Payment Integration**: Stripe payment processing integration
- **Security**: PCI compliance and secure payment data handling
- **Validation**: Input validation for payment operations
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Performance**: Optimized payment processing and caching
- **Accessibility**: WCAG 2.1 AA compliance for payment interfaces
- **Compliance**: PCI DSS compliance for payment processing

### Stripe Integration

**Stripe Features:**

- Stripe payment intent creation and confirmation
- Stripe payment method management
- Stripe webhook handling for payment events
- Stripe payment validation and error handling
- Stripe payment security and fraud prevention
- Stripe payment analytics and reporting

**Stripe Implementation:**

```typescript
// Example Stripe service
interface StripeService {
  createPaymentIntent(amount: number, currency: string): Promise<PaymentIntent>;
  confirmPaymentIntent(
    paymentIntentId: string,
    paymentMethodId: string
  ): Promise<PaymentIntent>;
  createPaymentMethod(card: CardDetails): Promise<PaymentMethod>;
  attachPaymentMethod(
    paymentMethodId: string,
    customerId: string
  ): Promise<PaymentMethod>;
  handleWebhook(payload: string, signature: string): Promise<WebhookEvent>;
  getPaymentIntent(paymentIntentId: string): Promise<PaymentIntent>;
}
```

### Payment Security

**Security Features:**

- PCI compliance implementation
- Payment data encryption at rest and in transit
- Secure payment form with tokenization
- Payment fraud detection and prevention
- Payment audit logging and monitoring
- Payment security headers and HTTPS enforcement
- Payment data retention and cleanup policies

**Security Implementation:**

- Stripe Elements for secure card input
- Payment tokenization and secure storage
- Fraud detection and risk assessment
- Payment audit logging and compliance
- Security monitoring and alerting
- Payment data encryption and protection

### Failed Payment Handling

**Failed Payment Features:**

- Failed payment detection and tracking
- 7-day grace period for failed payments
- Email notifications on days 3, 6, and 7
- Failed payment retry functionality
- Failed payment analytics and insights
- Failed payment recovery options

**Failed Payment Implementation:**

- Payment failure detection and logging
- Grace period calculation and tracking
- Automated notification scheduling
- Payment retry mechanisms
- Failed payment analytics and reporting
- Recovery option management

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for payment components
- **API Testing**: Jest + Supertest for payment endpoints
- **E2E Testing**: Playwright for complete payment flows
- **Payment Testing**: Test Stripe integration and payment processing
- **Security Testing**: Test payment security and compliance
- **Test File Location**: `__tests__/payments/` directory
- **Test Scenarios**: Payment processing, payment methods, confirmation, receipts, failed payments, notifications
- **Coverage Requirements**: 80% coverage for payment logic and components

### Performance Considerations

**Payment Performance:**

- Optimized payment processing and caching
- Efficient Stripe API integration
- Payment form performance optimization
- Payment confirmation optimization
- Failed payment handling optimization
- Mobile payment interface optimization

**Data Management:**

- Payment data caching and persistence
- Payment method data management
- Receipt data optimization
- Failed payment data management
- Notification data optimization
- Analytics data processing

### State Management

[Source: architecture/components.md#state-management-architecture]
**Payment State Management:**

```typescript
interface PaymentStore {
  currentPayment: Payment | null;
  paymentMethods: PaymentMethod[];
  paymentHistory: Payment[];
  failedPayments: FailedPayment[];
  notifications: PaymentNotification[];
  isLoading: boolean;
  processPayment: (
    subscriptionId: string,
    paymentMethodId: string
  ) => Promise<void>;
  createPaymentMethod: (card: CardDetails) => Promise<void>;
  confirmPayment: (paymentIntentId: string) => Promise<void>;
  retryFailedPayment: (paymentId: string) => Promise<void>;
  loadPaymentHistory: (userId: string) => Promise<void>;
  loadPaymentMethods: (userId: string) => Promise<void>;
  sendReceipt: (paymentId: string) => Promise<void>;
  validatePaymentForm: (formData: PaymentFormData) => boolean;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
