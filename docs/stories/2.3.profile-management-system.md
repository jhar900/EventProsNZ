# Story 2.3: Profile Management System

## Status

Draft

## Story

**As a** user,  
**I want** to manage and update my profile information,  
**so that** my information remains current and accurate.

## Acceptance Criteria

1. Profile editing interface with form validation
2. Photo and document upload management
3. Service information updates for contractors
4. Contact information management
5. Privacy settings and visibility controls
6. Profile completion status tracking
7. Data validation and error handling
8. Profile preview and testing functionality
9. Immediate editing after approval
10. Service area updates (regions + "Service Nationwide" checkbox)
11. Portfolio management with multiple video platforms (YouTube, Vimeo)

## Tasks / Subtasks

- [ ] Create profile management API routes (AC: 1, 3, 4, 6, 7, 9)
  - [ ] Implement `/api/profile/me` endpoint for profile retrieval
  - [ ] Implement `/api/profile/me/update` endpoint for profile updates
  - [ ] Implement `/api/profile/me/business` endpoint for business profile updates
  - [ ] Implement `/api/profile/me/services` endpoint for service information updates
  - [ ] Implement `/api/profile/me/portfolio` endpoint for portfolio management
  - [ ] Implement `/api/profile/me/privacy` endpoint for privacy settings
  - [ ] Add proper validation and error handling for all endpoints
- [ ] Build profile management UI components (AC: 1, 2, 3, 4, 5, 8, 10, 11)
  - [ ] Create `ProfileManagement` component with tabbed interface
  - [ ] Create `PersonalInfoEditor` component for personal information
  - [ ] Create `BusinessInfoEditor` component for business information
  - [ ] Create `ServicesEditor` component for service information
  - [ ] Create `PortfolioManager` component for portfolio management
  - [ ] Create `PrivacySettings` component for visibility controls
  - [ ] Create `ProfilePreview` component for profile testing
  - [ ] Add form validation and real-time updates
- [ ] Implement file upload management (AC: 2, 11)
  - [ ] Create profile photo upload and management
  - [ ] Implement portfolio photo upload and organization
  - [ ] Add document upload for business verification
  - [ ] Create file management interface with preview
  - [ ] Add file validation and size limits
  - [ ] Implement file deletion and replacement
- [ ] Set up service information management (AC: 3, 10)
  - [ ] Create service types selection and editing
  - [ ] Implement pricing range updates
  - [ ] Add availability calendar management
  - [ ] Create service area mapping updates
  - [ ] Add "Service Nationwide" checkbox functionality
  - [ ] Implement service category management
- [ ] Implement contact information management (AC: 4)
  - [ ] Create contact information editing interface
  - [ ] Add phone number validation and formatting
  - [ ] Implement address updates with Mapbox integration
  - [ ] Add email verification for contact changes
  - [ ] Create contact information validation
- [ ] Set up privacy settings and visibility controls (AC: 5)
  - [ ] Create privacy settings interface
  - [ ] Implement profile visibility controls
  - [ ] Add contact information visibility settings
  - [ ] Create portfolio visibility controls
  - [ ] Add business information visibility settings
- [ ] Implement profile completion tracking (AC: 6)
  - [ ] Create profile completion status calculation
  - [ ] Add completion progress indicators
  - [ ] Implement completion requirements validation
  - [ ] Add completion status notifications
  - [ ] Create profile completeness analytics
- [ ] Create profile management pages and navigation (AC: 8, 9)
  - [ ] Create `/profile/edit` page with profile management
  - [ ] Create `/profile/preview` page for profile testing
  - [ ] Create `/profile/settings` page for privacy settings
  - [ ] Add profile management navigation
  - [ ] Implement profile management routing and guards
- [ ] Set up portfolio management system (AC: 11)
  - [ ] Create portfolio item creation and editing
  - [ ] Implement YouTube video link validation and embedding
  - [ ] Add Vimeo video link validation and embedding
  - [ ] Create portfolio item organization and ordering
  - [ ] Add portfolio item deletion and management
  - [ ] Implement portfolio preview and testing

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for shared profile components)
- **Story 2.2**: Contractor onboarding (for business profile and portfolio components)

The profile management system will use the existing authentication system and database schema to provide comprehensive profile editing and management capabilities.

### Data Models

[Source: architecture/data-models.md#user]
The profile management system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE

**Portfolio Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `title` TEXT NOT NULL
- `description` TEXT
- `image_url` TEXT
- `video_url` TEXT
- `video_platform` TEXT
- `event_date` DATE
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#user-management]
The profile management system will implement the following API endpoints:

**Profile Management:**

- `GET /api/profile/me`

  - Response: `{ user: User, profile: Profile, business_profile?: BusinessProfile }`

- `PUT /api/profile/me`

  - Body: `{ first_name, last_name, phone, address, bio }`
  - Response: `{ profile: Profile }`

- `PUT /api/profile/me/business`
  - Body: `{ company_name, business_address, nzbn, description, service_areas, social_links }`
  - Response: `{ business_profile: BusinessProfile }`

**Service Management:**

- `GET /api/profile/me/services`

  - Response: `{ services: Service[] }`

- `POST /api/profile/me/services`

  - Body: `{ service_type, description, price_range_min, price_range_max, availability }`
  - Response: `{ service: Service }`

- `PUT /api/profile/me/services/{id}`

  - Body: `{ service_type, description, price_range_min, price_range_max, availability }`
  - Response: `{ service: Service }`

- `DELETE /api/profile/me/services/{id}`
  - Response: `{ success: boolean }`

**Portfolio Management:**

- `GET /api/profile/me/portfolio`

  - Response: `{ portfolio: PortfolioItem[] }`

- `POST /api/profile/me/portfolio`

  - Body: `{ title, description, image_url, video_url, video_platform, event_date }`
  - Response: `{ portfolio_item: PortfolioItem }`

- `PUT /api/profile/me/portfolio/{id}`

  - Body: `{ title, description, image_url, video_url, video_platform, event_date, is_visible }`
  - Response: `{ portfolio_item: PortfolioItem }`

- `DELETE /api/profile/me/portfolio/{id}`
  - Response: `{ success: boolean }`

**Privacy Settings:**

- `GET /api/profile/me/privacy`

  - Response: `{ privacy_settings: PrivacySettings }`

- `PUT /api/profile/me/privacy`
  - Body: `{ profile_visibility, contact_visibility, portfolio_visibility, business_visibility }`
  - Response: `{ privacy_settings: PrivacySettings }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The profile management system will use the following components:

**Profile Management Components:**

- `ProfileManagement` - Main profile management interface
- `PersonalInfoEditor` - Personal information editing form
- `BusinessInfoEditor` - Business information editing form
- `ServicesEditor` - Service information management
- `PortfolioManager` - Portfolio item management
- `PrivacySettings` - Privacy and visibility controls
- `ProfilePreview` - Profile preview and testing
- `FileUploadManager` - File upload and management
- `ServiceAreaEditor` - Service area mapping editor

**Form Features:**

- React Hook Form integration with Zod validation
- Real-time validation and error display
- Auto-save functionality for profile changes
- Responsive design with Tailwind CSS
- Accessibility features (ARIA labels, keyboard navigation)

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/profile/edit/page.tsx` - Profile editing page
- `app/profile/preview/page.tsx` - Profile preview page
- `app/profile/settings/page.tsx` - Privacy settings page
- `components/features/profile/` - Profile management components
- `components/features/profile/ProfileManagement.tsx` - Main management interface
- `components/features/profile/PersonalInfoEditor.tsx` - Personal info editor
- `components/features/profile/BusinessInfoEditor.tsx` - Business info editor
- `components/features/profile/ServicesEditor.tsx` - Services editor
- `components/features/profile/PortfolioManager.tsx` - Portfolio manager
- `components/features/profile/PrivacySettings.tsx` - Privacy settings
- `components/features/profile/ProfilePreview.tsx` - Profile preview
- `lib/profile/` - Profile management utilities and services
- `lib/profile/profile-management.ts` - Profile management service
- `lib/profile/portfolio.ts` - Portfolio management service
- `lib/profile/validation.ts` - Profile validation schemas
- `hooks/useProfile.ts` - Profile management hook
- `stores/profile.ts` - Profile state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Authentication**: Supabase Auth with JWT tokens
- **File Upload**: Supabase Storage for photos and documents
- **Address Integration**: Mapbox API for address updates
- **Video Integration**: YouTube and Vimeo API for video validation
- **Validation**: Client-side with React Hook Form + Zod, server-side validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Performance**: Optimized file uploads with image compression
- **Security**: Secure file uploads with validation and sanitization

### Video Platform Integration

**Supported Platforms:**

- YouTube: URL validation and embed generation
- Vimeo: URL validation and embed generation
- Video validation: Check URL format and accessibility
- Embed generation: Create embeddable video URLs
- Thumbnail extraction: Generate video thumbnails

**Implementation:**

```typescript
// Example video validation
interface VideoValidationProps {
  url: string;
  platform: "youtube" | "vimeo";
  onValidate: (valid: boolean, embedUrl: string) => void;
}
```

### Privacy Settings

**Visibility Controls:**

- Profile visibility: Public, private, contacts only
- Contact information: Visible to all, contacts only, hidden
- Portfolio visibility: Public, private, contacts only
- Business information: Public, private, contacts only
- Service information: Public, private, contacts only

**Privacy Levels:**

- Public: Visible to all users
- Contacts only: Visible to users who have contacted them
- Private: Visible only to the user

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for profile components
- **API Testing**: Jest + Supertest for profile endpoints
- **E2E Testing**: Playwright for complete profile management flows
- **File Upload Testing**: Test photo and document upload functionality
- **Video Testing**: Test YouTube and Vimeo video validation
- **Test File Location**: `__tests__/profile/` directory
- **Test Scenarios**: Profile editing, file uploads, service management, portfolio management, privacy settings
- **Coverage Requirements**: 80% coverage for profile management logic and components

### Profile Completion Tracking

**Completion Criteria:**

- Personal information: 100% complete
- Contact information: 100% complete
- Business information: 100% complete (for contractors)
- Service information: 100% complete (for contractors)
- Portfolio: At least 3 items (for contractors)
- Profile photo: Optional but recommended

**Completion Status:**

- Incomplete: Missing required information
- Partial: Some information missing
- Complete: All required information provided
- Verified: Profile verified by admin (for contractors)

### State Management

[Source: architecture/components.md#state-management-architecture]
**Profile Management State Management:**

```typescript
interface ProfileStore {
  user: User | null;
  profile: Profile | null;
  businessProfile: BusinessProfile | null;
  services: Service[];
  portfolio: PortfolioItem[];
  privacySettings: PrivacySettings;
  completionStatus: ProfileCompletionStatus;
  isLoading: boolean;
  updateProfile: (data: Partial<Profile>) => Promise<void>;
  updateBusinessProfile: (data: Partial<BusinessProfile>) => Promise<void>;
  updateServices: (services: Service[]) => Promise<void>;
  updatePortfolio: (portfolio: PortfolioItem[]) => Promise<void>;
  updatePrivacySettings: (settings: PrivacySettings) => Promise<void>;
  refreshProfile: () => Promise<void>;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
