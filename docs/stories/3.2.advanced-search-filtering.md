# Story 3.2: Advanced Search & Filtering

## Status

Ready for Review

## Story

**As an** event manager,  
**I want** to search and filter contractors by specific criteria,  
**so that** I can find the most relevant service providers for my needs.

## Acceptance Criteria

1. Text search across contractor names, services, and descriptions
2. Service type filtering with multiple selection
3. Location-based filtering with radius options
4. Region selection (tick boxes) with multiple selection
5. Budget range filtering with price indicators
6. Average Rating filtering options
7. Response time filtering ("Responds within 24 hours" vs "Responds within 48 hours")
8. Portfolio size filtering ("Has portfolio" vs "No portfolio")
9. Search result sorting (relevance, rating, price, distance)
10. Search history, saved searches and favourites functionality
11. Real-time search as users type
12. Search debouncing (wait 300ms after user stops typing)

## Tasks / Subtasks

- [x] Create search and filtering API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 12)
  - [x] Implement `/api/contractors/search` endpoint with advanced filtering
  - [x] Implement `/api/contractors/filters` endpoint for filter options
  - [x] Implement `/api/contractors/suggestions` endpoint for search suggestions
  - [x] Implement `/api/search/history` endpoint for search history
  - [x] Implement `/api/search/saved` endpoint for saved searches
  - [x] Implement `/api/search/favorites` endpoint for contractor favorites
  - [x] Add proper search indexing and optimization
- [x] Build search and filtering UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
  - [x] Create `SearchBar` component with real-time search
  - [x] Create `FilterPanel` component with all filter options
  - [x] Create `ServiceTypeFilter` component for service filtering
  - [x] Create `LocationFilter` component for location-based filtering
  - [x] Create `RegionFilter` component for region selection
  - [x] Create `BudgetFilter` component for price range filtering
  - [x] Create `RatingFilter` component for rating filtering
  - [x] Create `ResponseTimeFilter` component for response time filtering
  - [x] Create `PortfolioFilter` component for portfolio filtering
  - [x] Create `SortControls` component for result sorting
  - [x] Add search debouncing and real-time updates
- [x] Implement text search functionality (AC: 1, 11, 12)
  - [x] Create full-text search across contractor data
  - [x] Implement search suggestions and autocomplete
  - [x] Add search highlighting and result ranking
  - [x] Create search debouncing with 300ms delay
  - [x] Add search result caching and optimization
- [x] Set up location-based filtering (AC: 3, 4)
  - [x] Integrate Mapbox for location search and radius filtering
  - [x] Create location-based contractor filtering
  - [x] Implement region selection with multiple options
  - [x] Add distance calculation and sorting
  - [x] Create location-based search suggestions
- [x] Implement advanced filtering options (AC: 2, 5, 6, 7, 8)
  - [x] Create service type filtering with multiple selection
  - [x] Add budget range filtering with price indicators
  - [x] Implement rating filtering with range options
  - [x] Create response time filtering options
  - [x] Add portfolio size filtering
  - [x] Implement filter combination logic
- [x] Set up search result sorting (AC: 9)
  - [x] Create relevance-based sorting algorithm
  - [x] Implement rating-based sorting
  - [x] Add price-based sorting
  - [x] Create distance-based sorting
  - [x] Add custom sorting options
- [x] Create search history and favorites (AC: 10)
  - [x] Implement search history tracking
  - [x] Create saved searches functionality
  - [x] Add contractor favorites system
  - [x] Create search history management
  - [x] Add favorites management interface
- [x] Create search and filtering pages (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
  - [x] Create `/contractors/search` page with advanced search
  - [x] Create `/contractors/favorites` page for saved contractors
  - [x] Create `/search/history` page for search history
  - [x] Add search page navigation and breadcrumbs
  - [x] Implement search page routing and state management
- [x] Set up search performance optimization (AC: 11, 12)
  - [x] Implement search result caching
  - [x] Add search query optimization
  - [x] Create search index management
  - [x] Add search performance monitoring
  - [x] Implement search result pagination

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for approved contractors)
- **Story 3.1**: Contractor directory display (for directory integration)

The advanced search and filtering system will use the existing contractor directory and database schema to provide comprehensive search capabilities.

### Data Models

[Source: architecture/data-models.md#user]
The search and filtering system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE
- `subscription_tier` subscription_tier DEFAULT 'essential'

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**SearchHistory Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `search_query` TEXT NOT NULL
- `filters` JSON
- `result_count` INTEGER
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**SavedSearch Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `name` TEXT NOT NULL
- `search_query` TEXT NOT NULL
- `filters` JSON
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**ContractorFavorite Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `contractor_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#contractor-endpoints]
The search and filtering system will implement the following API endpoints:

**Search and Filtering:**

- `GET /api/contractors/search`
  - Query: `{ q?, service_type?, location?, radius?, regions?, price_min?, price_max?, rating_min?, response_time?, has_portfolio?, sort?, page?, limit? }`
  - Response: `{ contractors: Contractor[], total: number, page: number, limit: number, filters: FilterOptions }`

- `GET /api/contractors/filters`
  - Response: `{ service_types: string[], regions: string[], price_ranges: PriceRange[], rating_ranges: RatingRange[] }`

- `GET /api/contractors/suggestions`
  - Query: `{ q?, limit? }`
  - Response: `{ suggestions: string[] }`

**Search History and Favorites:**

- `GET /api/search/history`
  - Query: `{ limit?, offset? }`
  - Response: `{ searches: SearchHistory[] }`

- `POST /api/search/history`
  - Body: `{ search_query, filters, result_count }`
  - Response: `{ success: boolean }`

- `GET /api/search/saved`
  - Response: `{ saved_searches: SavedSearch[] }`

- `POST /api/search/saved`
  - Body: `{ name, search_query, filters }`
  - Response: `{ saved_search: SavedSearch }`

- `GET /api/search/favorites`
  - Response: `{ favorites: ContractorFavorite[] }`

- `POST /api/search/favorites`
  - Body: `{ contractor_id }`
  - Response: `{ success: boolean }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The search and filtering system will use the following components:

**Search Components:**

- `SearchBar` - Main search input with real-time search
- `SearchSuggestions` - Search autocomplete and suggestions
- `FilterPanel` - Comprehensive filter panel
- `ServiceTypeFilter` - Service type filtering
- `LocationFilter` - Location-based filtering
- `RegionFilter` - Region selection filtering
- `BudgetFilter` - Price range filtering
- `RatingFilter` - Rating-based filtering
- `ResponseTimeFilter` - Response time filtering
- `PortfolioFilter` - Portfolio size filtering
- `SortControls` - Search result sorting
- `SearchHistory` - Search history management
- `SavedSearches` - Saved searches management
- `ContractorFavorites` - Contractor favorites management

**Form Features:**

- React Hook Form integration with Zod validation
- Real-time search with debouncing
- Filter state management and persistence
- Responsive design with Tailwind CSS
- Accessibility features (ARIA labels, keyboard navigation)

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/contractors/search/page.tsx` - Advanced search page
- `app/contractors/favorites/page.tsx` - Contractor favorites page
- `app/search/history/page.tsx` - Search history page
- `components/features/search/` - Search and filtering components
- `components/features/search/SearchBar.tsx` - Main search bar
- `components/features/search/FilterPanel.tsx` - Filter panel
- `components/features/search/ServiceTypeFilter.tsx` - Service type filter
- `components/features/search/LocationFilter.tsx` - Location filter
- `components/features/search/RegionFilter.tsx` - Region filter
- `components/features/search/BudgetFilter.tsx` - Budget filter
- `components/features/search/RatingFilter.tsx` - Rating filter
- `components/features/search/ResponseTimeFilter.tsx` - Response time filter
- `components/features/search/PortfolioFilter.tsx` - Portfolio filter
- `components/features/search/SortControls.tsx` - Sort controls
- `lib/search/` - Search utilities and services
- `lib/search/search-service.ts` - Search service
- `lib/search/filter-service.ts` - Filter service
- `lib/search/suggestion-service.ts` - Suggestion service
- `hooks/useSearch.ts` - Search hook
- `stores/search.ts` - Search state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Authentication**: Public access for search, authenticated for favorites
- **Performance**: Optimized search queries with proper indexing
- **Security**: Input validation and sanitization
- **Validation**: Client-side with React Hook Form + Zod, server-side validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Search**: Full-text search with PostgreSQL and Supabase
- **Caching**: Search result caching for performance

### Search Implementation

**Full-Text Search:**

- PostgreSQL full-text search across contractor data
- Search across names, services, descriptions, and business information
- Search ranking and relevance scoring
- Search highlighting and result snippets

**Search Debouncing:**

- 300ms delay after user stops typing
- Cancel previous search requests
- Optimize search performance
- Reduce server load

**Search Suggestions:**

- Real-time search suggestions
- Popular search terms
- Contractor name suggestions
- Service type suggestions

### Filter Implementation

**Service Type Filtering:**

- Multiple selection support
- Service category grouping
- Dynamic filter options based on available contractors

**Location-Based Filtering:**

- Mapbox integration for location search
- Radius-based filtering
- Distance calculation and sorting
- Region-based filtering with multiple selection

**Budget Range Filtering:**

- Price range input with min/max values
- Price indicator display
- Dynamic price range suggestions
- Currency formatting and display

**Rating Filtering:**

- Rating range selection
- Average rating calculation
- Rating distribution display
- Rating-based sorting

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for search components
- **API Testing**: Jest + Supertest for search endpoints
- **E2E Testing**: Playwright for complete search flows
- **Performance Testing**: Test search performance and debouncing
- **Test File Location**: `__tests__/search/` directory
- **Test Scenarios**: Search functionality, filtering, sorting, history, favorites
- **Coverage Requirements**: 80% coverage for search logic and components

### Performance Considerations

**Search Optimization:**

- Database indexing for search fields
- Search result caching
- Query optimization and pagination
- Debounced search input
- Lazy loading for search results

**Filter Performance:**

- Efficient filter combination logic
- Filter state management
- Real-time filter updates
- Filter result caching
- Optimized filter queries

### State Management

[Source: architecture/components.md#state-management-architecture]
**Search State Management:**

```typescript
interface SearchStore {
  searchQuery: string;
  filters: SearchFilters;
  sortBy: SortOption;
  results: Contractor[];
  totalResults: number;
  isLoading: boolean;
  searchHistory: SearchHistory[];
  savedSearches: SavedSearch[];
  favorites: ContractorFavorite[];
  performSearch: (query: string, filters?: SearchFilters) => Promise<void>;
  updateFilters: (filters: Partial<SearchFilters>) => void;
  setSortBy: (sortBy: SortOption) => void;
  saveSearch: (
    name: string,
    query: string,
    filters: SearchFilters
  ) => Promise<void>;
  addToFavorites: (contractorId: string) => Promise<void>;
  removeFromFavorites: (contractorId: string) => Promise<void>;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent)

### Debug Log References

- Database migration: `supabase/migrations/009_advanced_search_tables.sql`
- API routes: `app/api/contractors/search/`, `app/api/search/`
- UI components: `components/features/search/`
- Search hook: `hooks/useSearch.ts`
- Test files: `__tests__/search/`, `e2e/search-functionality.spec.ts`

### Completion Notes List

1. **Database Schema**: Created comprehensive search tables with full-text search indexes and RLS policies
2. **API Implementation**: Built 6 API endpoints with advanced filtering, suggestions, history, and favorites
3. **UI Components**: Created 8 reusable search components with proper TypeScript interfaces
4. **Search Hook**: Implemented comprehensive useSearch hook with debouncing and state management
5. **Pages**: Built 3 search-related pages with responsive design and error handling
6. **Testing**: Created comprehensive test suite with unit, integration, and E2E tests
7. **Performance**: Implemented search optimization with debouncing, caching, and pagination

### File List

**Database:**

- `supabase/migrations/009_advanced_search_tables.sql`

**API Routes:**

- `app/api/contractors/search/route.ts` (enhanced)
- `app/api/contractors/filters/route.ts`
- `app/api/contractors/suggestions/route.ts`
- `app/api/search/history/route.ts`
- `app/api/search/saved/route.ts`
- `app/api/search/favorites/route.ts`

**UI Components:**

- `components/features/search/SearchBar.tsx`
- `components/features/search/FilterPanel.tsx`
- `components/features/search/ServiceTypeFilter.tsx`
- `components/features/search/LocationFilter.tsx`
- `components/features/search/RegionFilter.tsx`
- `components/features/search/BudgetFilter.tsx`
- `components/features/search/RatingFilter.tsx`
- `components/features/search/ResponseTimeFilter.tsx`
- `components/features/search/PortfolioFilter.tsx`
- `components/features/search/SortControls.tsx`

**Hooks:**

- `hooks/useSearch.ts`

**Pages:**

- `app/contractors/search/page.tsx`
- `app/contractors/favorites/page.tsx`
- `app/search/history/page.tsx`

**Tests:**

- `__tests__/search/search-api.test.ts`
- `__tests__/search/search-history-api.test.ts`
- `__tests__/search/search-components.test.tsx`
- `__tests__/search/useSearch.test.ts`
- `e2e/search-functionality.spec.ts`

## QA Results

### Review Date: 2024-12-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - The implementation demonstrates high-quality architecture with comprehensive search functionality, proper separation of concerns, and robust error handling. The code follows React best practices with proper TypeScript usage, custom hooks for state management, and well-structured component hierarchy.

**Strengths:**

- Comprehensive database schema with proper indexing and RLS policies
- Advanced PostgreSQL full-text search with relevance scoring
- Well-architected React components with proper separation of concerns
- Robust error handling and loading states throughout
- Comprehensive test coverage including unit, integration, and E2E tests
- Proper debouncing implementation (300ms) for search performance
- Clean API design with proper parameter validation and pagination

### Refactoring Performed

**No refactoring required** - The code quality is already excellent. The implementation follows best practices and demonstrates proper architecture patterns.

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript and React best practices
- **Project Structure**: ✓ Perfect alignment with established component hierarchy and file organization
- **Testing Strategy**: ✓ Comprehensive test coverage across all layers (unit, integration, E2E)
- **All ACs Met**: ✓ All 12 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Database schema with proper indexing and RLS policies implemented
- [x] Advanced search function with full-text search and relevance scoring
- [x] Comprehensive API endpoints with proper error handling
- [x] Well-structured React components with TypeScript interfaces
- [x] Custom useSearch hook with proper state management
- [x] Search debouncing and performance optimization
- [x] Comprehensive test suite with 80%+ coverage
- [x] E2E tests covering all major user flows
- [x] Proper error handling and loading states
- [x] Responsive design with accessibility features

### Security Review

**Status: PASS** - Excellent security implementation:

- Proper RLS policies on all new tables
- Input validation and sanitization in API routes
- SQL injection protection through parameterized queries
- Proper authentication checks for user-specific data
- No sensitive data exposure in client-side code

### Performance Considerations

**Status: PASS** - Excellent performance optimization:

- Database indexes on all search-relevant fields
- Full-text search indexes for optimal query performance
- Search result caching and pagination
- Debounced search input (300ms delay)
- Efficient filter combination logic
- Proper query optimization with LIMIT/OFFSET

### Files Modified During Review

**No files modified** - Implementation quality was already excellent and required no changes.

### Gate Status

**Gate: PASS** → docs/qa/gates/3.2-advanced-search-filtering.yml
**Risk profile**: docs/qa/assessments/3.2-risk-20241219.md
**NFR assessment**: docs/qa/assessments/3.2-nfr-20241219.md

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality, and no blocking issues identified.
