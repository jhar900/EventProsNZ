# Story 1.2: Database Schema Design and Implementation

## Status

Draft

## Story

**As a** developer,
**I want** to design and implement the core database schema in Supabase,
**so that** the application has a solid data foundation for vendors, users, and basic platform functionality.

## Acceptance Criteria

1. Supabase project created and configured
2. User profiles table with vendor/organizer role distinction
3. Vendors table with basic profile information (name, description, location, services)
4. Service categories table with predefined NZ event service types
5. Reviews table for vendor ratings and feedback
6. Proper foreign key relationships established
7. Database indexes created for search performance
8. Row Level Security (RLS) policies implemented
9. Database schema documented
10. Test data seeded for development

## Tasks / Subtasks

- [ ] Create and configure Supabase project (AC: 1)
  - [ ] Create new Supabase project
  - [ ] Configure project settings and region
  - [ ] Set up environment variables for database connection
  - [ ] Test database connection from application
- [ ] Design and implement user_profiles table (AC: 2)
  - [ ] Create user_profiles table with role distinction
  - [ ] Add foreign key relationship to auth.users
  - [ ] Implement role-based constraints (organizer, vendor, admin)
  - [ ] Add profile completion tracking fields
- [ ] Design and implement vendors table (AC: 3)
  - [ ] Create vendors table with business profile fields
  - [ ] Add location fields with PostGIS support
  - [ ] Implement subscription tier tracking
  - [ ] Add business verification status fields
- [ ] Design and implement service categories system (AC: 4)
  - [ ] Create categories table with NZ event service types
  - [ ] Create vendor_categories junction table
  - [ ] Seed predefined NZ event service categories
  - [ ] Add category hierarchy support
- [ ] Design and implement reviews system (AC: 5)
  - [ ] Create reviews table with multi-dimensional ratings
  - [ ] Add review_responses table for vendor replies
  - [ ] Implement review validation constraints
  - [ ] Add review moderation fields
- [ ] Establish foreign key relationships (AC: 6)
  - [ ] Create all necessary foreign key constraints
  - [ ] Implement cascade delete rules where appropriate
  - [ ] Add referential integrity checks
  - [ ] Test relationship constraints
- [ ] Create database indexes for performance (AC: 7)
  - [ ] Add indexes for search operations (vendor name, description)
  - [ ] Create location-based indexes for geographic queries
  - [ ] Add indexes for category filtering
  - [ ] Implement full-text search indexes
- [ ] Implement Row Level Security policies (AC: 8)
  - [ ] Create RLS policies for user_profiles table
  - [ ] Implement vendor data access policies
  - [ ] Add review visibility and editing policies
  - [ ] Test RLS policy enforcement
- [ ] Document database schema (AC: 9)
  - [ ] Create comprehensive schema documentation
  - [ ] Document table relationships and constraints
  - [ ] Add field descriptions and data types
  - [ ] Include sample queries and usage examples
- [ ] Seed test data for development (AC: 10)
  - [ ] Create test user profiles (organizers and vendors)
  - [ ] Add sample vendor profiles with categories
  - [ ] Insert test reviews and ratings
  - [ ] Verify data integrity and relationships

## Dev Notes

### Previous Story Insights

This story builds on Story 1.1 (Project Setup) which established:

- Next.js 14 project with TypeScript
- Supabase client library installed and configured
- Environment variables for database connection
- Development environment ready for database work

### Database Technology

[Source: architecture/database-schema-data-models.md#database-technology]

- **Primary Database**: PostgreSQL via Supabase
- **Features**: Full-text search, JSON support, real-time subscriptions
- **Security**: Row Level Security (RLS) policies
- **Performance**: Optimized indexing for search operations

### Core Entity Relationships

[Source: architecture/database-schema-data-models.md#core-entity-relationships]

The database follows this relationship structure:

- USERS → USER_PROFILES (1:1)
- USERS → VENDORS (1:0..1) - users can optionally be vendors
- VENDORS → VENDOR_CATEGORIES → CATEGORIES (many-to-many)
- VENDORS → REVIEWS (1:many)
- USERS → REVIEWS (1:many) - users write reviews about vendors

### User Roles & Authentication

[Source: architecture/authentication-authorization.md#user-roles-permissions]

**Role Hierarchy:**

- **ADMIN**: Platform administrators with full access
- **ORGANIZER**: Event organizers who create jobs and contact vendors
- **VENDOR**: Service providers who respond to jobs and manage profiles

**Authentication Integration:**

- Uses Supabase Auth for user management
- JWT tokens for secure authentication
- Role-based access control (RBAC) implementation

### Database Schema Design

[Source: architecture/database-schema-data-models.md#core-tables-overview]

**Core Tables to Implement:**

1. **user_profiles** - Extended user information with roles
2. **vendors** - Business profiles with subscription tiers
3. **categories** - Service categories for NZ event services
4. **vendor_categories** - Many-to-many relationship table
5. **reviews** - Multi-dimensional rating system
6. **review_responses** - Vendor responses to reviews

### Key Database Features

[Source: architecture/database-schema-data-models.md#key-database-features]

**Full-Text Search:**

- PostgreSQL full-text search for vendor and job discovery
- Optimized indexes for search performance
- Location-based search with PostGIS extensions

**Real-Time Capabilities:**

- Supabase real-time subscriptions for messaging
- Live updates for notifications and status changes
- WebSocket connections for instant communication

**Security & Access Control:**

- Row Level Security (RLS) policies for data protection
- Role-based access control (RBAC)
- Encrypted sensitive data storage

### NZ Event Service Categories

Based on the Event Pros NZ marketplace focus, the categories should include:

- Wedding Services (photography, catering, venues, flowers)
- Corporate Events (AV equipment, venues, catering)
- Birthday Parties (entertainment, venues, catering)
- Conferences & Seminars (venues, AV, catering)
- Celebrations (anniversaries, graduations, etc.)

### Database Performance Requirements

[Source: architecture/database-schema-data-models.md#performance-optimization]

- Strategic indexing for search operations
- Query optimization for large datasets
- Caching strategies for frequently accessed data
- Full-text search indexes for vendor discovery

### File Locations

Based on Supabase conventions:

- Database migrations: `supabase/migrations/` directory
- Schema documentation: `docs/database/` directory
- Seed data: `supabase/seed.sql` file
- Database types: `types/database.ts` file

### Testing Standards

[Source: architecture/system-overview.md#technology-stack]

- **Testing Framework**: Jest and React Testing Library
- **Database Testing**: Use Supabase test environment
- **Test Data**: Isolated test data for each test suite
- **Coverage Requirements**: Test all database operations and constraints

### Technical Constraints

[Source: architecture/database-schema-data-models.md#security-access-control]

- All tables must have RLS policies enabled
- Foreign key constraints must be properly defined
- Indexes must be optimized for search performance
- Data validation must be implemented at database level
- All sensitive data must be encrypted

### Environment Variables Required

[Source: architecture/deployment-infrastructure.md#environment-variables]

**Database Connection:**

- NEXT_PUBLIC_SUPABASE_URL: Supabase project URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY: Supabase anonymous key
- SUPABASE_SERVICE_ROLE_KEY: Service role key for admin operations

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-12-19 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_

