# Story 7.2: Basic CRM Functionality

## Status

Draft

## Story

**As a** user,  
**I want** to track my interactions with other users,  
**so that** I can manage my business relationships effectively.

## Acceptance Criteria

1. Contact management with interaction history
2. Message tracking and conversation threads
3. Notes and tags for contacts
4. Follow-up reminders and scheduling
5. Contact search and filtering
6. Export functionality for contact data
7. Integration with inquiry system
8. Activity timeline for each contact
9. Basic profile details to be shared for contacts who have made enquiries

## Tasks / Subtasks

- [ ] Create basic CRM API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9)
  - [ ] Implement `/api/crm/contacts` endpoint for contact CRUD operations
  - [ ] Implement `/api/crm/interactions` endpoint for interaction tracking
  - [ ] Implement `/api/crm/messages` endpoint for message tracking
  - [ ] Implement `/api/crm/notes` endpoint for notes and tags
  - [ ] Implement `/api/crm/reminders` endpoint for follow-up reminders
  - [ ] Implement `/api/crm/search` endpoint for contact search and filtering
  - [ ] Implement `/api/crm/export` endpoint for contact data export
  - [ ] Implement `/api/crm/timeline` endpoint for activity timeline
  - [ ] Add proper CRM validation and error handling
  - [ ] Add CRM security and access control
- [ ] Build basic CRM UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9)
  - [ ] Create `BasicCRM` component for main CRM interface
  - [ ] Create `ContactManagement` component for contact management
  - [ ] Create `InteractionHistory` component for interaction history
  - [ ] Create `MessageTracking` component for message tracking
  - [ ] Create `NotesAndTags` component for notes and tags
  - [ ] Create `FollowUpReminders` component for follow-up reminders
  - [ ] Create `ContactSearch` component for contact search and filtering
  - [ ] Create `ContactExport` component for contact data export
  - [ ] Create `ActivityTimeline` component for activity timeline
  - [ ] Add CRM loading states and error handling
- [ ] Implement contact management (AC: 1, 8, 9)
  - [ ] Create contact management with interaction history
  - [ ] Add basic profile details sharing for contacts who have made enquiries
  - [ ] Implement activity timeline for each contact
  - [ ] Add contact validation and error handling
  - [ ] Create contact security and access control
  - [ ] Add contact performance optimization
  - [ ] Implement contact analytics and insights
  - [ ] Add contact user experience optimization
- [ ] Set up message tracking system (AC: 2, 7)
  - [ ] Create message tracking and conversation threads
  - [ ] Add integration with inquiry system
  - [ ] Implement message validation and error handling
  - [ ] Add message security and access control
  - [ ] Create message performance optimization
  - [ ] Add message analytics and insights
  - [ ] Implement message user experience optimization
  - [ ] Add message notification system
- [ ] Create notes and tags system (AC: 3, 8)
  - [ ] Create notes and tags for contacts
  - [ ] Add notes and tags validation and error handling
  - [ ] Implement notes and tags security and access control
  - [ ] Add notes and tags performance optimization
  - [ ] Create notes and tags analytics and insights
  - [ ] Add notes and tags user experience optimization
  - [ ] Implement notes and tags search and filtering
  - [ ] Add notes and tags export functionality
- [ ] Implement follow-up reminders (AC: 4, 8)
  - [ ] Create follow-up reminders and scheduling
  - [ ] Add reminder validation and error handling
  - [ ] Implement reminder security and access control
  - [ ] Add reminder performance optimization
  - [ ] Create reminder analytics and insights
  - [ ] Add reminder user experience optimization
  - [ ] Implement reminder notification system
  - [ ] Add reminder automation and scheduling
- [ ] Set up contact search and filtering (AC: 5, 8)
  - [ ] Create contact search and filtering
  - [ ] Add search validation and error handling
  - [ ] Implement search security and access control
  - [ ] Add search performance optimization
  - [ ] Create search analytics and insights
  - [ ] Add search user experience optimization
  - [ ] Implement search caching and optimization
  - [ ] Add search export functionality
- [ ] Create export functionality (AC: 6, 8)
  - [ ] Create export functionality for contact data
  - [ ] Add export validation and error handling
  - [ ] Implement export security and access control
  - [ ] Add export performance optimization
  - [ ] Create export analytics and insights
  - [ ] Add export user experience optimization
  - [ ] Implement export format support (CSV, Excel, PDF)
  - [ ] Add export scheduling and automation
- [ ] Implement activity timeline (AC: 8, 9)
  - [ ] Create activity timeline for each contact
  - [ ] Add timeline validation and error handling
  - [ ] Implement timeline security and access control
  - [ ] Add timeline performance optimization
  - [ ] Create timeline analytics and insights
  - [ ] Add timeline user experience optimization
  - [ ] Implement timeline filtering and search
  - [ ] Add timeline export functionality
- [ ] Create basic CRM pages (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9)
  - [ ] Create `/crm` page for basic CRM interface
  - [ ] Create `/crm/contacts` page for contact management
  - [ ] Create `/crm/messages` page for message tracking
  - [ ] Create `/crm/notes` page for notes and tags
  - [ ] Create `/crm/reminders` page for follow-up reminders
  - [ ] Create `/crm/search` page for contact search
  - [ ] Create `/crm/export` page for contact export
  - [ ] Create `/crm/timeline` page for activity timeline
  - [ ] Add CRM navigation and breadcrumbs
  - [ ] Implement CRM routing and state management
  - [ ] Add CRM page metadata and SEO

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)
- **Story 5.1**: Event creation wizard (for event creation integration)
- **Story 5.2**: AI-powered service recommendations (for service recommendations)
- **Story 5.3**: Budget planning & recommendations (for budget integration)
- **Story 5.4**: Intelligent contractor matching (for contractor matching)
- **Story 5.5**: Event management & status tracking (for event management)
- **Story 6.1**: Subscription management system (for subscription integration)
- **Story 6.2**: Payment processing integration (for payment integration)
- **Story 6.3**: Premium feature access (for feature access integration)
- **Story 6.4**: Trial conversion & communication (for trial integration)
- **Story 7.1**: Structured inquiry system (for inquiry integration)

The basic CRM system will use the existing inquiry system and user management to provide comprehensive relationship management functionality.

### Data Models

[Source: architecture/data-models.md#user]
The basic CRM system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**Inquiry Table:**

- `id` UUID PRIMARY KEY
- `event_manager_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `contractor_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `event_id` UUID REFERENCES events(id) ON DELETE CASCADE
- `inquiry_type` inquiry_type NOT NULL
- `subject` TEXT NOT NULL
- `message` TEXT NOT NULL
- `event_details` JSON
- `status` inquiry_status DEFAULT 'sent'
- `priority` inquiry_priority DEFAULT 'medium'
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Contact Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `contact_user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `contact_type` contact_type NOT NULL
- `relationship_status` relationship_status DEFAULT 'active'
- `last_interaction` TIMESTAMP WITH TIME ZONE
- `interaction_count` INTEGER DEFAULT 0
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**ContactNote Table (to be created):**

- `id` UUID PRIMARY KEY
- `contact_id` UUID REFERENCES contacts(id) ON DELETE CASCADE
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `note_content` TEXT NOT NULL
- `note_type` note_type DEFAULT 'general'
- `tags` TEXT[]
- `is_important` BOOLEAN DEFAULT FALSE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**ContactReminder Table (to be created):**

- `id` UUID PRIMARY KEY
- `contact_id` UUID REFERENCES contacts(id) ON DELETE CASCADE
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `reminder_type` reminder_type NOT NULL
- `reminder_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `reminder_message` TEXT
- `is_completed` BOOLEAN DEFAULT FALSE
- `completed_at` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**ContactInteraction Table (to be created):**

- `id` UUID PRIMARY KEY
- `contact_id` UUID REFERENCES contacts(id) ON DELETE CASCADE
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `interaction_type` interaction_type NOT NULL
- `interaction_data` JSON
- `interaction_notes` TEXT
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#crm-endpoints]
The basic CRM system will implement the following API endpoints:

**Contact Management:**

- `GET /api/crm/contacts`

  - Query: `{ user_id, contact_type?, relationship_status?, page?, limit? }`
  - Response: `{ contacts: Contact[], total: number, page: number, limit: number }`

- `POST /api/crm/contacts`

  - Body: `{ contact_user_id, contact_type, relationship_status? }`
  - Response: `{ contact: Contact, success: boolean }`

- `PUT /api/crm/contacts/{id}`

  - Body: `{ contact_type?, relationship_status?, last_interaction? }`
  - Response: `{ contact: Contact, success: boolean }`

- `DELETE /api/crm/contacts/{id}`
  - Response: `{ success: boolean }`

**Interaction History:**

- `GET /api/crm/interactions`

  - Query: `{ contact_id?, user_id?, interaction_type?, date_from?, date_to? }`
  - Response: `{ interactions: ContactInteraction[], total: number }`

- `POST /api/crm/interactions`
  - Body: `{ contact_id, interaction_type, interaction_data, interaction_notes? }`
  - Response: `{ interaction: ContactInteraction, success: boolean }`

**Message Tracking:**

- `GET /api/crm/messages`

  - Query: `{ contact_id?, user_id?, message_type?, date_from?, date_to? }`
  - Response: `{ messages: Message[], total: number }`

- `POST /api/crm/messages`
  - Body: `{ contact_id, message_type, message_content, message_data? }`
  - Response: `{ message: Message, success: boolean }`

**Notes and Tags:**

- `GET /api/crm/notes`

  - Query: `{ contact_id?, user_id?, note_type?, tags? }`
  - Response: `{ notes: ContactNote[], total: number }`

- `POST /api/crm/notes`

  - Body: `{ contact_id, note_content, note_type?, tags?, is_important? }`
  - Response: `{ note: ContactNote, success: boolean }`

- `PUT /api/crm/notes/{id}`
  - Body: `{ note_content?, note_type?, tags?, is_important? }`
  - Response: `{ note: ContactNote, success: boolean }`

**Follow-up Reminders:**

- `GET /api/crm/reminders`

  - Query: `{ contact_id?, user_id?, reminder_type?, is_completed? }`
  - Response: `{ reminders: ContactReminder[], total: number }`

- `POST /api/crm/reminders`

  - Body: `{ contact_id, reminder_type, reminder_date, reminder_message? }`
  - Response: `{ reminder: ContactReminder, success: boolean }`

- `PUT /api/crm/reminders/{id}`
  - Body: `{ is_completed, completed_at? }`
  - Response: `{ reminder: ContactReminder, success: boolean }`

**Contact Search:**

- `GET /api/crm/search`

  - Query: `{ user_id, query, contact_type?, relationship_status?, tags? }`
  - Response: `{ contacts: Contact[], total: number }`

- `GET /api/crm/search/suggestions`
  - Query: `{ user_id, query }`
  - Response: `{ suggestions: string[] }`

**Contact Export:**

- `GET /api/crm/export`

  - Query: `{ user_id, format?, contact_type?, date_from?, date_to? }`
  - Response: `{ export_data: Blob }`

- `POST /api/crm/export/schedule`
  - Body: `{ user_id, format, contact_type?, date_from?, date_to?, email? }`
  - Response: `{ export_job: ExportJob, success: boolean }`

**Activity Timeline:**

- `GET /api/crm/timeline`

  - Query: `{ contact_id, user_id, date_from?, date_to? }`
  - Response: `{ timeline: ActivityTimeline[], total: number }`

- `GET /api/crm/timeline/summary`
  - Query: `{ contact_id, user_id, period? }`
  - Response: `{ summary: TimelineSummary }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The basic CRM system will use the following components:

**CRM Components:**

- `BasicCRM` - Main CRM interface
- `ContactManagement` - Contact management interface
- `InteractionHistory` - Interaction history display
- `MessageTracking` - Message tracking and conversation threads
- `NotesAndTags` - Notes and tags management
- `FollowUpReminders` - Follow-up reminders and scheduling
- `ContactSearch` - Contact search and filtering
- `ContactExport` - Contact data export functionality
- `ActivityTimeline` - Activity timeline display
- `ContactCard` - Individual contact display
- `ContactList` - Contact list display
- `ContactFilters` - Contact filtering options
- `ContactAnalytics` - Contact analytics and insights
- `ContactImport` - Contact import functionality
- `ContactSync` - Contact synchronization

**CRM Features:**

- Contact management with interaction history
- Message tracking and conversation threads
- Notes and tags for contacts
- Follow-up reminders and scheduling
- Contact search and filtering
- Export functionality for contact data
- Integration with inquiry system
- Activity timeline for each contact
- Basic profile details sharing for contacts who have made enquiries

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/crm/page.tsx` - Basic CRM interface page
- `app/crm/contacts/page.tsx` - Contact management page
- `app/crm/messages/page.tsx` - Message tracking page
- `app/crm/notes/page.tsx` - Notes and tags page
- `app/crm/reminders/page.tsx` - Follow-up reminders page
- `app/crm/search/page.tsx` - Contact search page
- `app/crm/export/page.tsx` - Contact export page
- `app/crm/timeline/page.tsx` - Activity timeline page
- `components/features/crm/` - CRM components
- `components/features/crm/BasicCRM.tsx` - Main CRM interface
- `components/features/crm/ContactManagement.tsx` - Contact management
- `components/features/crm/InteractionHistory.tsx` - Interaction history
- `components/features/crm/MessageTracking.tsx` - Message tracking
- `components/features/crm/NotesAndTags.tsx` - Notes and tags
- `components/features/crm/FollowUpReminders.tsx` - Follow-up reminders
- `components/features/crm/ContactSearch.tsx` - Contact search
- `components/features/crm/ContactExport.tsx` - Contact export
- `components/features/crm/ActivityTimeline.tsx` - Activity timeline
- `components/features/crm/ContactCard.tsx` - Contact card
- `components/features/crm/ContactList.tsx` - Contact list
- `components/features/crm/ContactFilters.tsx` - Contact filters
- `components/features/crm/ContactAnalytics.tsx` - Contact analytics
- `components/features/crm/ContactImport.tsx` - Contact import
- `components/features/crm/ContactSync.tsx` - Contact sync
- `lib/crm/` - CRM utilities and services
- `lib/crm/contact-service.ts` - Contact service
- `lib/crm/interaction-service.ts` - Interaction service
- `lib/crm/message-service.ts` - Message service
- `lib/crm/note-service.ts` - Note service
- `lib/crm/reminder-service.ts` - Reminder service
- `lib/crm/export-service.ts` - Export service
- `lib/crm/timeline-service.ts` - Timeline service
- `hooks/useCRM.ts` - CRM hook
- `stores/crm.ts` - CRM state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Form Library**: React Hook Form with Zod validation
- **UI Library**: shadcn/ui with Tailwind CSS
- **State Management**: Zustand for CRM state
- **Validation**: Zod schemas for CRM data validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Security**: Secure CRM data handling and validation
- **Performance**: Optimized CRM operations and caching
- **Accessibility**: WCAG 2.1 AA compliance for CRM interfaces

### Contact Management

**Contact Features:**

- Contact management with interaction history
- Basic profile details sharing for contacts who have made enquiries
- Activity timeline for each contact
- Contact validation and error handling
- Contact security and access control

**Contact Implementation:**

```typescript
// Example contact service
interface ContactService {
  createContact(contactData: ContactData): Promise<Contact>;
  getContacts(userId: string, filters?: ContactFilters): Promise<Contact[]>;
  updateContact(contactId: string, updates: ContactUpdate): Promise<Contact>;
  deleteContact(contactId: string): Promise<void>;
  getContactTimeline(contactId: string): Promise<ActivityTimeline[]>;
  searchContacts(userId: string, query: string): Promise<Contact[]>;
  exportContacts(userId: string, format: string): Promise<Blob>;
}
```

### Message Tracking

**Message Features:**

- Message tracking and conversation threads
- Integration with inquiry system
- Message validation and error handling
- Message security and access control

**Message Implementation:**

- Message thread management
- Conversation history tracking
- Message search and filtering
- Message analytics and insights

### Notes and Tags

**Notes Features:**

- Notes and tags for contacts
- Note validation and error handling
- Note security and access control
- Note search and filtering

**Notes Implementation:**

- Note creation and management
- Tag system and categorization
- Note search and filtering
- Note analytics and insights

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for CRM components
- **API Testing**: Jest + Supertest for CRM endpoints
- **E2E Testing**: Playwright for complete CRM flows
- **Contact Testing**: Test contact management and interactions
- **Message Testing**: Test message tracking and conversations
- **Test File Location**: `__tests__/crm/` directory
- **Test Scenarios**: Contact management, interactions, messages, notes, reminders, search, export, timeline
- **Coverage Requirements**: 80% coverage for CRM logic and components

### Performance Considerations

**CRM Performance:**

- Optimized contact management and caching
- Efficient message tracking and storage
- Notes and tags performance optimization
- Reminder system optimization
- Search and filtering optimization
- Export functionality optimization

**Data Management:**

- Contact data caching and persistence
- Interaction data management
- Message data optimization
- Note data management
- Reminder data optimization
- Timeline data processing

### State Management

[Source: architecture/components.md#state-management-architecture]
**CRM State Management:**

```typescript
interface CRMStore {
  contacts: Contact[];
  currentContact: Contact | null;
  interactions: ContactInteraction[];
  messages: Message[];
  notes: ContactNote[];
  reminders: ContactReminder[];
  timeline: ActivityTimeline[];
  filters: ContactFilters;
  isLoading: boolean;
  loadContacts: (filters?: ContactFilters) => Promise<void>;
  createContact: (contactData: ContactData) => Promise<void>;
  updateContact: (contactId: string, updates: ContactUpdate) => Promise<void>;
  deleteContact: (contactId: string) => Promise<void>;
  loadInteractions: (contactId: string) => Promise<void>;
  createInteraction: (interactionData: InteractionData) => Promise<void>;
  loadMessages: (contactId: string) => Promise<void>;
  createMessage: (messageData: MessageData) => Promise<void>;
  loadNotes: (contactId: string) => Promise<void>;
  createNote: (noteData: NoteData) => Promise<void>;
  loadReminders: (contactId: string) => Promise<void>;
  createReminder: (reminderData: ReminderData) => Promise<void>;
  loadTimeline: (contactId: string) => Promise<void>;
  searchContacts: (query: string) => Promise<void>;
  exportContacts: (format: string) => Promise<Blob>;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
