# Story 4.2: Map Clustering & Interaction

## Status

Draft

## Story

**As an** event manager,  
**I want** to interact with contractor pins on the map,  
**so that** I can explore different areas and view contractor details.

## Acceptance Criteria

1. Pin clustering when zoomed out with count indicators
2. Pin expansion when zooming in
3. Hover effects with contractor preview cards
4. Click functionality to view full contractor profiles
5. Pin filtering based on search criteria
6. Map legend and service type indicators (basic and toggleable)
7. Smooth animations and transitions
8. Touch-friendly interactions for mobile
9. Collapsible map with smooth slide animation
10. Full-screen map option on mobile

## Tasks / Subtasks

- [ ] Implement pin clustering system (AC: 1, 2, 7)
  - [ ] Create pin clustering algorithm for large datasets
  - [ ] Add cluster count indicators and styling
  - [ ] Implement cluster expansion on zoom in
  - [ ] Add cluster collapse on zoom out
  - [ ] Create smooth clustering animations
  - [ ] Add cluster performance optimization
- [ ] Build pin interaction components (AC: 3, 4, 8)
  - [ ] Create `PinCluster` component for clustered pins
  - [ ] Create `ContractorPin` component for individual pins
  - [ ] Create `PinTooltip` component for hover previews
  - [ ] Create `PinPopup` component for click interactions
  - [ ] Add touch-friendly pin interactions
  - [ ] Implement pin selection and highlighting
- [ ] Set up map filtering and search integration (AC: 5, 6)
  - [ ] Create pin filtering based on search criteria
  - [ ] Add service type filtering for pins
  - [ ] Implement map legend with service type indicators
  - [ ] Add toggleable legend and filter options
  - [ ] Create filter state management
  - [ ] Add filter performance optimization
- [ ] Implement map animations and transitions (AC: 7, 9, 10)
  - [ ] Create smooth zoom and pan animations
  - [ ] Add pin clustering transition animations
  - [ ] Implement collapsible map slide animation
  - [ ] Add full-screen map toggle for mobile
  - [ ] Create map state transition management
  - [ ] Add animation performance optimization
- [ ] Create mobile-optimized interactions (AC: 8, 10)
  - [ ] Add touch gesture handling for pins
  - [ ] Implement mobile-friendly pin interactions
  - [ ] Create mobile map controls and navigation
  - [ ] Add mobile full-screen map functionality
  - [ ] Implement mobile map state management
  - [ ] Add mobile performance optimization
- [ ] Set up contractor profile integration (AC: 4)
  - [ ] Create pin click to profile navigation
  - [ ] Add contractor profile preview in tooltips
  - [ ] Implement profile data loading for pins
  - [ ] Add profile integration with map state
  - [ ] Create profile navigation from map
  - [ ] Add profile data caching for performance
- [ ] Create map legend and controls (AC: 6)
  - [ ] Create `MapLegend` component with service types
  - [ ] Add toggleable legend visibility
  - [ ] Implement service type color coding
  - [ ] Add legend filtering functionality
  - [ ] Create legend responsive design
  - [ ] Add legend accessibility features
- [ ] Implement map state management (AC: 1, 2, 5, 7, 9, 10)
  - [ ] Create map state store for interactions
  - [ ] Add pin selection state management
  - [ ] Implement filter state persistence
  - [ ] Add map viewport state management
  - [ ] Create map animation state tracking
  - [ ] Add map performance state monitoring

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for map foundation)

The map clustering and interaction system will use the existing map implementation and contractor data to provide enhanced user interactions.

### Data Models

[Source: architecture/data-models.md#user]
The map clustering system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE
- `subscription_tier` subscription_tier DEFAULT 'essential'

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**MapInteraction Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `interaction_type` TEXT NOT NULL
- `contractor_id` UUID REFERENCES users(id)
- `map_bounds` JSON
- `zoom_level` INTEGER
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#map-endpoints]
The map clustering system will implement the following API endpoints:

**Map Clustering:**

- `GET /api/map/clusters`

  - Query: `{ bounds?, zoom?, service_type? }`
  - Response: `{ clusters: MapCluster[], pins: MapPin[] }`

- `GET /api/map/pins/{clusterId}`

  - Response: `{ pins: MapPin[] }`

- `GET /api/map/contractors/{id}/preview`
  - Response: `{ contractor: ContractorPreview }`

**Map Interactions:**

- `POST /api/map/interactions`

  - Body: `{ interaction_type, contractor_id, map_bounds, zoom_level }`
  - Response: `{ success: boolean }`

- `GET /api/map/interactions/analytics`
  - Query: `{ period?, date_from?, date_to? }`
  - Response: `{ interactions: MapInteractionAnalytics[] }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The map clustering system will use the following components:

**Clustering Components:**

- `PinCluster` - Clustered pin groups with count indicators
- `ContractorPin` - Individual contractor location pins
- `PinTooltip` - Hover tooltips with contractor previews
- `PinPopup` - Click popups with contractor details
- `MapLegend` - Service type legend and indicators
- `MapControls` - Map interaction controls
- `ClusterManager` - Pin clustering logic and management
- `PinFilter` - Pin filtering based on search criteria
- `MapAnimations` - Smooth animations and transitions
- `MobileMapControls` - Mobile-optimized map controls

**Interaction Features:**

- Pin clustering with count indicators
- Hover effects with contractor previews
- Click functionality for profile navigation
- Touch-friendly mobile interactions
- Smooth animations and transitions
- Filtering and search integration

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `components/features/map/clustering/` - Map clustering components
- `components/features/map/clustering/PinCluster.tsx` - Pin clustering
- `components/features/map/clustering/ContractorPin.tsx` - Individual pins
- `components/features/map/clustering/PinTooltip.tsx` - Pin tooltips
- `components/features/map/clustering/PinPopup.tsx` - Pin popups
- `components/features/map/clustering/ClusterManager.tsx` - Clustering logic
- `components/features/map/clustering/PinFilter.tsx` - Pin filtering
- `components/features/map/clustering/MapLegend.tsx` - Map legend
- `components/features/map/clustering/MapAnimations.tsx` - Animations
- `components/features/map/clustering/MobileMapControls.tsx` - Mobile controls
- `lib/map/clustering/` - Clustering utilities and services
- `lib/map/clustering/cluster-service.ts` - Clustering service
- `lib/map/clustering/pin-service.ts` - Pin management service
- `lib/map/clustering/animation-service.ts` - Animation service
- `hooks/useMapClustering.ts` - Clustering hook
- `stores/map-clustering.ts` - Clustering state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Map Library**: Mapbox GL JS with clustering support
- **Performance**: Optimized clustering algorithms and rendering
- **Security**: Secure map interaction tracking
- **Validation**: Input validation for map interactions
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Mobile**: Mobile-optimized interactions and performance
- **Accessibility**: WCAG 2.1 AA compliance for map interactions

### Clustering Algorithm

**Clustering Features:**

- Distance-based clustering for contractor pins
- Dynamic cluster sizing based on zoom level
- Cluster count indicators and styling
- Smooth cluster expansion and collapse
- Performance optimization for large datasets

**Clustering Implementation:**

```typescript
// Example clustering configuration
interface ClusteringConfig {
  clusterRadius: number;
  clusterMaxZoom: number;
  clusterMinPoints: number;
  clusterColor: string;
  clusterTextColor: string;
  clusterTextSize: number;
}
```

### Pin Interactions

**Hover Effects:**

- Contractor preview cards on hover
- Smooth tooltip animations
- Performance-optimized hover detection
- Mobile-friendly hover alternatives

**Click Functionality:**

- Full contractor profile navigation
- Pin selection and highlighting
- Click analytics and tracking
- Touch-friendly click detection

### Mobile Optimization

**Mobile Features:**

- Touch gesture handling for pins
- Mobile-friendly pin interactions
- Full-screen map toggle
- Collapsible map with slide animation
- Mobile performance optimization

**Touch Interactions:**

- Pin tap to select
- Pin long-press for context menu
- Swipe gestures for map navigation
- Touch-friendly cluster interactions

### Animation System

**Animation Features:**

- Smooth zoom and pan transitions
- Pin clustering animations
- Map state transition animations
- Collapsible map slide animations
- Performance-optimized animations

**Animation Implementation:**

- CSS transitions for smooth effects
- JavaScript animations for complex interactions
- RequestAnimationFrame for performance
- Animation state management
- Mobile animation optimization

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for clustering components
- **API Testing**: Jest + Supertest for clustering endpoints
- **E2E Testing**: Playwright for complete map interaction flows
- **Performance Testing**: Test clustering performance with large datasets
- **Mobile Testing**: Test mobile map interactions and responsiveness
- **Test File Location**: `__tests__/map/clustering/` directory
- **Test Scenarios**: Pin clustering, interactions, animations, mobile responsiveness, filtering
- **Coverage Requirements**: 80% coverage for clustering logic and components

### Performance Considerations

**Clustering Performance:**

- Efficient clustering algorithms
- Viewport-based clustering
- Cluster data caching
- Memory management for large datasets
- Animation performance optimization

**Interaction Performance:**

- Optimized hover detection
- Efficient click handling
- Smooth animation rendering
- Mobile performance optimization
- Memory leak prevention

### State Management

[Source: architecture/components.md#state-management-architecture]
**Map Clustering State Management:**

```typescript
interface MapClusteringStore {
  clusters: MapCluster[];
  pins: MapPin[];
  selectedPin: string | null;
  hoveredPin: string | null;
  filters: PinFilters;
  legendVisible: boolean;
  isAnimating: boolean;
  loadClusters: (bounds: MapBounds, zoom: number) => Promise<void>;
  selectPin: (pinId: string) => void;
  hoverPin: (pinId: string | null) => void;
  setFilters: (filters: PinFilters) => void;
  toggleLegend: () => void;
  startAnimation: () => void;
  endAnimation: () => void;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
