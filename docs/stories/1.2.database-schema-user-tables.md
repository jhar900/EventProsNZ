# Story 1.2: Database Schema & User Tables

## Status

Draft

## Story

**As a** developer,  
**I want** to create the core database schema with user tables and role management,  
**so that** the platform can store and manage different user types securely.

## Acceptance Criteria

1. PostgreSQL database schema created with users, profiles, and business_profiles tables
2. Role-based access control implemented (event_manager, contractor, admin)
3. User authentication tables configured with Supabase Auth
4. Database relationships and constraints properly defined
5. Basic data validation rules implemented
6. Database migrations system established
7. Test data seeding scripts created for development

## Tasks / Subtasks

- [ ] Review and validate existing database schema (AC: 1, 4)
  - [ ] Analyze existing migration file `001_initial_schema_with_performance.sql`
  - [ ] Verify schema aligns with data models from architecture
  - [ ] Check for any missing tables or relationships
  - [ ] Validate constraint definitions and data types
- [ ] Implement role-based access control (AC: 2)
  - [ ] Verify `user_role` enum is properly defined
  - [ ] Ensure RLS policies are correctly implemented
  - [ ] Test role-based permissions for different user types
  - [ ] Validate admin, event_manager, and contractor access patterns
- [ ] Configure Supabase Auth integration (AC: 3)
  - [ ] Verify `users` table references `auth.users(id)`
  - [ ] Ensure proper foreign key relationships
  - [ ] Test authentication flow with database schema
  - [ ] Validate user creation and profile linking
- [ ] Enhance database relationships and constraints (AC: 4)
  - [ ] Review all foreign key relationships
  - [ ] Verify cascade delete behaviors
  - [ ] Check unique constraints and indexes
  - [ ] Validate data integrity constraints
- [ ] Implement data validation rules (AC: 5)
  - [ ] Add CHECK constraints for data validation
  - [ ] Implement email format validation
  - [ ] Add phone number format validation
  - [ ] Validate business registration numbers (NZBN)
- [ ] Set up database migrations system (AC: 6)
  - [ ] Configure Supabase migration workflow
  - [ ] Create migration versioning system
  - [ ] Set up rollback procedures
  - [ ] Document migration best practices
- [ ] Create test data seeding scripts (AC: 7)
  - [ ] Create seed data for users (all roles)
  - [ ] Create sample profiles and business profiles
  - [ ] Add test events and services data
  - [ ] Create sample enquiries and testimonials
  - [ ] Document seeding procedures

## Dev Notes

### Previous Story Insights

This story builds on Story 1.1 (Project Setup & Infrastructure) which established the Next.js project with Supabase integration. The database schema will be implemented using the existing Supabase project and migration system.

### Data Models

[Source: architecture/data-models.md#user]
The database schema implements the following core data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `bio` TEXT
- `avatar_url` TEXT
- `location` TEXT
- `timezone` TEXT DEFAULT 'Pacific/Auckland'

**BusinessProfile Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `description` TEXT
- `website` TEXT
- `location` TEXT
- `service_categories` TEXT[]
- `average_rating` DECIMAL(3,2) DEFAULT 0
- `review_count` INTEGER DEFAULT 0
- `is_verified` BOOLEAN DEFAULT FALSE
- `subscription_tier` subscription_tier DEFAULT 'essential'

### Database Specifications

[Source: architecture/tech-stack.md]

- **Database**: PostgreSQL 15+ with ACID compliance
- **Extensions**: uuid-ossp, pgcrypto, pg_stat_statements, btree_gin
- **Authentication**: Supabase Auth integration
- **Row Level Security**: Enabled on all tables
- **Performance**: Comprehensive indexing strategy

### API Specifications

[Source: architecture/api-specification.md#rest-api-specification]
The database schema supports the following API endpoints:

- `/auth/register` - User registration with role assignment
- `/auth/login` - User authentication
- `/users/me` - User profile management
- `/contractors` - Business profile queries
- `/events` - Event management
- `/enquiries` - Communication system
- `/jobs` - Job board functionality

### File Locations

[Source: existing migration file]
Based on the existing project structure:

- `supabase/migrations/001_initial_schema_with_performance.sql` - Main schema migration
- `supabase/migrations/` - Future migration files
- `supabase/seed.sql` - Test data seeding (to be created)
- `lib/database/` - Database utilities and connection management
- `lib/types/` - TypeScript type definitions for database models

### Technical Constraints

[Source: architecture/tech-stack.md + existing schema]

- **Database**: PostgreSQL 15+ with full ACID compliance
- **Authentication**: Supabase Auth with JWT tokens
- **Security**: Row Level Security (RLS) enabled on all tables
- **Performance**: Comprehensive indexing including GIN indexes for full-text search
- **Data Types**: UUID primary keys, proper timestamp handling with timezone
- **Constraints**: CHECK constraints for data validation, foreign key constraints for referential integrity
- **Extensions**: uuid-ossp for UUID generation, pgcrypto for encryption, pg_stat_statements for monitoring

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Database Testing**: Jest + Supertest for API testing with database integration
- **Migration Testing**: Test migration rollback and forward compatibility
- **Data Validation Testing**: Test all CHECK constraints and validation rules
- **RLS Testing**: Test Row Level Security policies for different user roles
- **Performance Testing**: Test query performance with indexes
- **Test File Location**: `__tests__/database/` directory
- **Test Data**: Use seeded test data for consistent testing
- **Coverage Requirements**: 80% coverage for database operations and constraints

### Database Schema Details

[Source: existing migration file analysis]
**Key Features:**

- **Custom Types**: user_role, event_status, job_status, subscription_tier, enquiry_status
- **Performance Indexes**: Comprehensive indexing strategy including composite indexes
- **Full-Text Search**: GIN indexes for search functionality on events and business profiles
- **Triggers**: Automatic updated_at timestamp updates, business profile rating calculations
- **RLS Policies**: Granular access control based on user roles and ownership
- **Data Validation**: CHECK constraints for data integrity (budget ranges, rating values, etc.)

**Security Features:**

- Row Level Security enabled on all tables
- Granular policies for different user types
- Proper foreign key relationships with cascade deletes
- Data validation through CHECK constraints
- Secure authentication integration with Supabase Auth

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
