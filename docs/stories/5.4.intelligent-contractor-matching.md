# Story 5.4: Intelligent Contractor Matching

## Status

Draft

## Story

**As an** event manager,  
**I want** to receive contractor recommendations based on my event requirements,  
**so that** I can quickly find the most suitable service providers.

## Acceptance Criteria

1. Event requirement analysis and matching
2. Contractor compatibility scoring
3. Availability checking against event dates
4. Budget compatibility filtering
5. Location and service area matching
6. Past performance and review integration
7. Response time and reliability factors
8. All matching contractors shown with premium contractors first
9. Paginated results for performance
10. Recommendation ranking and prioritization
11. Integration with inquiry system

## Tasks / Subtasks

- [ ] Create contractor matching API routes (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Implement `/api/matching/contractors` endpoint for contractor matching
  - [ ] Implement `/api/matching/compatibility` endpoint for compatibility scoring
  - [ ] Implement `/api/matching/availability` endpoint for availability checking
  - [ ] Implement `/api/matching/budget` endpoint for budget compatibility
  - [ ] Implement `/api/matching/location` endpoint for location matching
  - [ ] Implement `/api/matching/performance` endpoint for performance integration
  - [ ] Implement `/api/matching/ranking` endpoint for recommendation ranking
  - [ ] Implement `/api/matching/inquiry` endpoint for inquiry integration
  - [ ] Add proper matching algorithm and error handling
  - [ ] Add matching result caching and performance optimization
- [ ] Build contractor matching UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `ContractorMatching` component for main matching interface
  - [ ] Create `EventRequirementAnalysis` component for requirement analysis
  - [ ] Create `CompatibilityScoring` component for compatibility display
  - [ ] Create `AvailabilityChecker` component for availability checking
  - [ ] Create `BudgetCompatibility` component for budget filtering
  - [ ] Create `LocationMatching` component for location matching
  - [ ] Create `PerformanceIntegration` component for performance display
  - [ ] Create `ContractorRanking` component for recommendation ranking
  - [ ] Create `MatchingResults` component for results display
  - [ ] Create `InquiryIntegration` component for inquiry system
  - [ ] Add matching loading states and error handling
- [ ] Implement event requirement analysis (AC: 1, 2, 6, 7, 10)
  - [ ] Create event requirement analysis algorithm
  - [ ] Add contractor compatibility scoring
  - [ ] Implement past performance and review integration
  - [ ] Add response time and reliability factors
  - [ ] Create requirement analysis validation
  - [ ] Add requirement analysis caching
  - [ ] Implement requirement analysis performance optimization
  - [ ] Add requirement analysis analytics and insights
- [ ] Set up contractor compatibility scoring (AC: 2, 6, 7, 10)
  - [ ] Create contractor compatibility scoring algorithm
  - [ ] Add service type compatibility matching
  - [ ] Implement experience level compatibility
  - [ ] Add pricing compatibility scoring
  - [ ] Create compatibility score validation
  - [ ] Add compatibility score caching
  - [ ] Implement compatibility score analytics
  - [ ] Add compatibility score performance optimization
- [ ] Create availability checking system (AC: 3, 8, 9, 10)
  - [ ] Create availability checking algorithm
  - [ ] Add event date availability validation
  - [ ] Implement contractor availability integration
  - [ ] Add availability conflict detection
  - [ ] Create availability checking validation
  - [ ] Add availability checking caching
  - [ ] Implement availability checking performance optimization
  - [ ] Add availability checking analytics
- [ ] Implement budget compatibility filtering (AC: 4, 8, 9, 10)
  - [ ] Create budget compatibility filtering algorithm
  - [ ] Add contractor pricing integration
  - [ ] Implement budget range matching
  - [ ] Add budget compatibility scoring
  - [ ] Create budget compatibility validation
  - [ ] Add budget compatibility caching
  - [ ] Implement budget compatibility performance optimization
  - [ ] Add budget compatibility analytics
- [ ] Set up location and service area matching (AC: 5, 8, 9, 10)
  - [ ] Create location matching algorithm
  - [ ] Add service area coverage validation
  - [ ] Implement proximity-based matching
  - [ ] Add location compatibility scoring
  - [ ] Create location matching validation
  - [ ] Add location matching caching
  - [ ] Implement location matching performance optimization
  - [ ] Add location matching analytics
- [ ] Create performance and review integration (AC: 6, 7, 10)
  - [ ] Create performance data integration
  - [ ] Add review score integration
  - [ ] Implement response time tracking
  - [ ] Add reliability factor calculation
  - [ ] Create performance validation
  - [ ] Add performance caching
  - [ ] Implement performance analytics
  - [ ] Add performance performance optimization
- [ ] Implement recommendation ranking and prioritization (AC: 8, 9, 10)
  - [ ] Create recommendation ranking algorithm
  - [ ] Add premium contractor prioritization
  - [ ] Implement pagination for performance
  - [ ] Add ranking score calculation
  - [ ] Create ranking validation
  - [ ] Add ranking caching
  - [ ] Implement ranking performance optimization
  - [ ] Add ranking analytics
- [ ] Create contractor matching pages (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [ ] Create `/events/create/matching` page for contractor matching
  - [ ] Create `/matching/contractors` page for matching results
  - [ ] Create `/matching/analytics` page for matching analytics
  - [ ] Add contractor matching navigation and breadcrumbs
  - [ ] Implement contractor matching routing and state management
  - [ ] Add contractor matching page metadata and SEO
  - [ ] Create contractor matching sharing and collaboration

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)
- **Story 5.1**: Event creation wizard (for event creation integration)
- **Story 5.2**: AI-powered service recommendations (for service recommendations)
- **Story 5.3**: Budget planning & recommendations (for budget integration)

The intelligent contractor matching system will use the existing contractor data, event requirements, and analytics to provide intelligent contractor recommendations.

### Data Models

[Source: architecture/data-models.md#user]
The contractor matching system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE
- `subscription_tier` subscription_tier DEFAULT 'essential'

**Service Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `is_visible` BOOLEAN DEFAULT TRUE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Event Table:**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `event_type` TEXT NOT NULL
- `title` TEXT NOT NULL
- `description` TEXT
- `event_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `duration_hours` INTEGER
- `attendee_count` INTEGER
- `location` JSON
- `budget_total` DECIMAL(10,2)
- `status` event_status DEFAULT 'draft'
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**ContractorMatch Table (to be created):**

- `id` UUID PRIMARY KEY
- `event_id` UUID REFERENCES events(id) ON DELETE CASCADE
- `contractor_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `compatibility_score` DECIMAL(3,2) NOT NULL
- `availability_score` DECIMAL(3,2) NOT NULL
- `budget_score` DECIMAL(3,2) NOT NULL
- `location_score` DECIMAL(3,2) NOT NULL
- `performance_score` DECIMAL(3,2) NOT NULL
- `overall_score` DECIMAL(3,2) NOT NULL
- `is_premium` BOOLEAN DEFAULT FALSE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**MatchingAnalytics Table (to be created):**

- `id` UUID PRIMARY KEY
- `event_id` UUID REFERENCES events(id) ON DELETE CASCADE
- `matching_algorithm` TEXT NOT NULL
- `total_contractors` INTEGER NOT NULL
- `matching_contractors` INTEGER NOT NULL
- `premium_contractors` INTEGER NOT NULL
- `average_score` DECIMAL(3,2) NOT NULL
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#matching-endpoints]
The contractor matching system will implement the following API endpoints:

**Contractor Matching:**

- `GET /api/matching/contractors`

  - Query: `{ event_id, page?, limit?, sort? }`
  - Response: `{ matches: ContractorMatch[], total: number, page: number, limit: number }`

- `POST /api/matching/contractors/feedback`
  - Body: `{ match_id, feedback_type, rating, comments? }`
  - Response: `{ success: boolean, updated_match: ContractorMatch }`

**Compatibility Scoring:**

- `GET /api/matching/compatibility`

  - Query: `{ event_id, contractor_id }`
  - Response: `{ compatibility: CompatibilityScore, breakdown: ScoreBreakdown }`

- `POST /api/matching/compatibility/calculate`
  - Body: `{ event_requirements, contractor_profile }`
  - Response: `{ compatibility: CompatibilityScore, breakdown: ScoreBreakdown }`

**Availability Checking:**

- `GET /api/matching/availability`

  - Query: `{ contractor_id, event_date, duration? }`
  - Response: `{ available: boolean, conflicts: AvailabilityConflict[] }`

- `POST /api/matching/availability/check`
  - Body: `{ contractor_ids: string[], event_date, duration }`
  - Response: `{ availability: ContractorAvailability[] }`

**Budget Compatibility:**

- `GET /api/matching/budget`

  - Query: `{ event_id, contractor_id }`
  - Response: `{ budget_compatibility: BudgetCompatibility, score: number }`

- `POST /api/matching/budget/calculate`
  - Body: `{ event_budget, contractor_pricing }`
  - Response: `{ budget_compatibility: BudgetCompatibility, score: number }`

**Location Matching:**

- `GET /api/matching/location`

  - Query: `{ event_location, contractor_id }`
  - Response: `{ location_match: LocationMatch, score: number }`

- `POST /api/matching/location/calculate`
  - Body: `{ event_location, contractor_service_areas }`
  - Response: `{ location_match: LocationMatch, score: number }`

**Performance Integration:**

- `GET /api/matching/performance`

  - Query: `{ contractor_id }`
  - Response: `{ performance: ContractorPerformance, score: number }`

- `POST /api/matching/performance/calculate`
  - Body: `{ contractor_id, performance_metrics }`
  - Response: `{ performance: ContractorPerformance, score: number }`

**Recommendation Ranking:**

- `GET /api/matching/ranking`

  - Query: `{ event_id, algorithm? }`
  - Response: `{ ranking: ContractorRanking[], algorithm: string }`

- `POST /api/matching/ranking/calculate`
  - Body: `{ matches: ContractorMatch[], algorithm: string }`
  - Response: `{ ranking: ContractorRanking[], algorithm: string }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The contractor matching system will use the following components:

**Matching Components:**

- `ContractorMatching` - Main contractor matching interface
- `EventRequirementAnalysis` - Event requirement analysis
- `CompatibilityScoring` - Compatibility scoring display
- `AvailabilityChecker` - Availability checking
- `BudgetCompatibility` - Budget compatibility filtering
- `LocationMatching` - Location and service area matching
- `PerformanceIntegration` - Performance and review integration
- `ContractorRanking` - Recommendation ranking and prioritization
- `MatchingResults` - Matching results display
- `InquiryIntegration` - Inquiry system integration
- `MatchingAnalytics` - Matching analytics and insights
- `ScoreBreakdown` - Score breakdown visualization
- `ContractorCard` - Individual contractor display
- `MatchingFilters` - Matching filters and options
- `MatchingPagination` - Pagination for results

**Matching Features:**

- Event requirement analysis and matching
- Contractor compatibility scoring
- Availability checking against event dates
- Budget compatibility filtering
- Location and service area matching
- Past performance and review integration
- Response time and reliability factors
- Premium contractor prioritization
- Paginated results for performance
- Recommendation ranking and prioritization
- Integration with inquiry system

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/events/create/matching/page.tsx` - Contractor matching page
- `app/matching/contractors/page.tsx` - Matching results page
- `app/matching/analytics/page.tsx` - Matching analytics page
- `components/features/matching/` - Contractor matching components
- `components/features/matching/ContractorMatching.tsx` - Main matching interface
- `components/features/matching/EventRequirementAnalysis.tsx` - Requirement analysis
- `components/features/matching/CompatibilityScoring.tsx` - Compatibility scoring
- `components/features/matching/AvailabilityChecker.tsx` - Availability checking
- `components/features/matching/BudgetCompatibility.tsx` - Budget compatibility
- `components/features/matching/LocationMatching.tsx` - Location matching
- `components/features/matching/PerformanceIntegration.tsx` - Performance integration
- `components/features/matching/ContractorRanking.tsx` - Recommendation ranking
- `components/features/matching/MatchingResults.tsx` - Results display
- `components/features/matching/InquiryIntegration.tsx` - Inquiry integration
- `components/features/matching/MatchingAnalytics.tsx` - Matching analytics
- `components/features/matching/ScoreBreakdown.tsx` - Score breakdown
- `components/features/matching/ContractorCard.tsx` - Contractor card
- `components/features/matching/MatchingFilters.tsx` - Matching filters
- `components/features/matching/MatchingPagination.tsx` - Pagination
- `lib/matching/` - Matching utilities and services
- `lib/matching/matching-service.ts` - Matching service
- `lib/matching/compatibility-service.ts` - Compatibility service
- `lib/matching/availability-service.ts` - Availability service
- `lib/matching/budget-service.ts` - Budget service
- `lib/matching/location-service.ts` - Location service
- `lib/matching/performance-service.ts` - Performance service
- `lib/matching/ranking-service.ts` - Ranking service
- `hooks/useContractorMatching.ts` - Contractor matching hook
- `stores/contractor-matching.ts` - Contractor matching state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Matching Algorithm**: Intelligent matching with multiple scoring factors
- **Performance**: Optimized matching calculations and caching
- **Security**: Secure matching data handling and privacy
- **Validation**: Input validation for matching parameters
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Scalability**: Efficient matching algorithm scaling
- **Accessibility**: WCAG 2.1 AA compliance for matching interfaces

### Matching Algorithm

**Matching Features:**

- Event requirement analysis and matching
- Contractor compatibility scoring
- Availability checking against event dates
- Budget compatibility filtering
- Location and service area matching
- Past performance and review integration
- Response time and reliability factors
- Premium contractor prioritization
- Recommendation ranking and prioritization

**Matching Implementation:**

```typescript
// Example matching service
interface ContractorMatchingService {
  findMatches(
    eventId: string,
    filters?: MatchingFilters
  ): Promise<ContractorMatch[]>;
  calculateCompatibility(
    eventRequirements: EventRequirements,
    contractorProfile: ContractorProfile
  ): Promise<CompatibilityScore>;
  checkAvailability(
    contractorId: string,
    eventDate: Date,
    duration: number
  ): Promise<AvailabilityResult>;
  calculateBudgetCompatibility(
    eventBudget: number,
    contractorPricing: ContractorPricing
  ): Promise<BudgetCompatibility>;
  calculateLocationMatch(
    eventLocation: Location,
    contractorServiceAreas: ServiceArea[]
  ): Promise<LocationMatch>;
  calculatePerformanceScore(contractorId: string): Promise<PerformanceScore>;
  rankContractors(
    matches: ContractorMatch[],
    algorithm: string
  ): Promise<ContractorRanking[]>;
}
```

### Compatibility Scoring

**Scoring Features:**

- Service type compatibility matching
- Experience level compatibility
- Pricing compatibility scoring
- Location compatibility scoring
- Performance compatibility scoring
- Availability compatibility scoring
- Overall compatibility calculation

**Scoring Implementation:**

- Multi-factor scoring algorithm
- Weighted scoring system
- Score breakdown and visualization
- Score validation and optimization
- Score caching and performance
- Score analytics and insights

### Availability Checking

**Availability Features:**

- Event date availability validation
- Contractor availability integration
- Availability conflict detection
- Availability scoring and ranking
- Availability caching and optimization
- Availability analytics and insights

**Availability Implementation:**

- Real-time availability checking
- Availability conflict detection
- Availability scoring algorithm
- Availability caching system
- Availability performance optimization
- Availability analytics and reporting

### Performance Integration

**Performance Features:**

- Past performance data integration
- Review score integration
- Response time tracking
- Reliability factor calculation
- Performance scoring and ranking
- Performance analytics and insights

**Performance Implementation:**

- Performance data collection
- Performance scoring algorithm
- Performance trend analysis
- Performance caching and optimization
- Performance analytics and reporting
- Performance monitoring and improvement

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for matching components
- **API Testing**: Jest + Supertest for matching endpoints
- **E2E Testing**: Playwright for complete matching flows
- **Algorithm Testing**: Test matching algorithm accuracy and performance
- **Performance Testing**: Test matching performance with large datasets
- **Test File Location**: `__tests__/matching/` directory
- **Test Scenarios**: Contractor matching, compatibility scoring, availability checking, budget filtering, location matching, performance integration, ranking
- **Coverage Requirements**: 80% coverage for matching logic and components

### Performance Considerations

**Matching Performance:**

- Optimized matching algorithm calculations
- Efficient compatibility scoring
- Availability checking optimization
- Budget compatibility performance
- Location matching optimization
- Performance integration optimization
- Ranking algorithm optimization
- Matching result caching

**Data Management:**

- Matching data caching and persistence
- Compatibility score caching
- Availability data management
- Budget compatibility caching
- Location matching data optimization
- Performance data management
- Ranking data optimization
- Matching analytics data processing

### State Management

[Source: architecture/components.md#state-management-architecture]
**Contractor Matching State Management:**

```typescript
interface ContractorMatchingStore {
  matches: ContractorMatch[];
  compatibility: CompatibilityScore[];
  availability: AvailabilityResult[];
  budgetCompatibility: BudgetCompatibility[];
  locationMatches: LocationMatch[];
  performance: PerformanceScore[];
  ranking: ContractorRanking[];
  filters: MatchingFilters;
  pagination: PaginationState;
  isLoading: boolean;
  findMatches: (eventId: string, filters?: MatchingFilters) => Promise<void>;
  calculateCompatibility: (
    eventId: string,
    contractorId: string
  ) => Promise<void>;
  checkAvailability: (contractorId: string, eventDate: Date) => Promise<void>;
  calculateBudgetCompatibility: (
    eventId: string,
    contractorId: string
  ) => Promise<void>;
  calculateLocationMatch: (
    eventId: string,
    contractorId: string
  ) => Promise<void>;
  calculatePerformanceScore: (contractorId: string) => Promise<void>;
  rankContractors: (algorithm: string) => Promise<void>;
  applyFilters: (filters: MatchingFilters) => void;
  setPagination: (pagination: PaginationState) => void;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
