# Story 5.1: Event Creation Wizard

## Status

Ready for Review

## Story

**As an** event manager,  
**I want** to create events through a guided step-by-step process,  
**so that** I can plan my events systematically and receive intelligent recommendations.

## Acceptance Criteria

1. Step 1: Event basics (type, date, location, attendee count, duration)
2. Step 2: Service requirements with AI-powered suggestions
3. Step 3: Budget planning with intelligent recommendations
4. Step 4: Review and submit event details
5. Form validation and error handling
6. Progress bar through the 4-step process
7. Progress saving and draft functionality
8. Pre-built event templates (weddings, corporate, parties) with customization
9. Integration with contractor matching system
10. Event editing after creation with change tracking and version history
11. Change notifications to contractors when event details are modified

## Tasks / Subtasks

- [x] Create event creation API routes (AC: 1, 2, 3, 4, 7, 9, 10, 11)
  - [x] Implement `/api/events` endpoint for event CRUD operations
  - [x] Implement `/api/events/templates` endpoint for event templates
  - [x] Implement `/api/events/drafts` endpoint for draft management
  - [x] Implement `/api/events/{id}/versions` endpoint for version history
  - [x] Implement `/api/events/{id}/notifications` endpoint for change notifications
  - [x] Implement `/api/events/{id}/matching` endpoint for contractor matching
  - [x] Add proper event validation and error handling
  - [x] Add event draft auto-save functionality
- [x] Build event creation wizard UI components (AC: 1, 2, 3, 4, 5, 6, 7, 8, 10, 11)
  - [x] Create `EventCreationWizard` component with 4-step process
  - [x] Create `EventBasicsStep` component for step 1
  - [x] Create `ServiceRequirementsStep` component for step 2
  - [x] Create `BudgetPlanningStep` component for step 3
  - [x] Create `EventReviewStep` component for step 4
  - [x] Create `ProgressBar` component for wizard progress
  - [x] Create `EventTemplates` component for pre-built templates
  - [x] Create `EventDraftManager` component for draft functionality
  - [x] Create `EventVersionHistory` component for change tracking
  - [x] Add form validation and error handling
- [x] Implement step 1: Event basics (AC: 1, 5, 6, 8)
  - [x] Create event type selection with predefined options
  - [x] Add event date and time selection with validation
  - [x] Implement location input with Mapbox autocomplete
  - [x] Add attendee count input with validation
  - [x] Create event duration selection
  - [x] Add event description and special requirements
  - [x] Implement form validation and error handling
  - [x] Add progress saving and draft functionality
- [x] Set up step 2: Service requirements (AC: 2, 5, 6, 8, 9)
  - [x] Create service category selection
  - [x] Add AI-powered service suggestions
  - [x] Implement service requirement templates
  - [x] Add custom service requirements input
  - [x] Create service priority and importance indicators
  - [x] Add service requirement validation
  - [x] Implement contractor matching integration
  - [x] Add service requirement customization
- [x] Create step 3: Budget planning (AC: 3, 5, 6, 8)
  - [x] Create overall budget input with recommendations
  - [x] Add service-specific budget breakdowns
  - [x] Implement budget adjustment and customization
  - [x] Add historical pricing data integration
  - [x] Create real-time pricing from contractor data
  - [x] Add seasonal adjustments for pricing
  - [x] Implement location-based cost variations
  - [x] Add budget validation and warnings
- [x] Implement step 4: Review and submit (AC: 4, 5, 6, 8, 9, 10, 11)
  - [x] Create event details review interface
  - [x] Add contractor matching results display
  - [x] Implement event submission and validation
  - [x] Add event creation confirmation
  - [x] Create event editing after creation
  - [x] Add change tracking and version history
  - [x] Implement change notifications to contractors
  - [x] Add event duplication for recurring events
- [x] Set up event templates system (AC: 8)
  - [x] Create pre-built event templates (weddings, corporate, parties)
  - [x] Add template customization functionality
  - [x] Implement template saving for users
  - [x] Add template sharing and discovery
  - [x] Create template validation and error handling
  - [x] Add template analytics and usage tracking
  - [x] Implement template version management
  - [x] Add template recommendation system
- [x] Create event management and editing (AC: 10, 11)
  - [x] Create event editing interface
  - [x] Add change tracking and version history
  - [x] Implement change notifications to contractors
  - [x] Add event status management
  - [x] Create event duplication functionality
  - [x] Add event deletion and restoration
  - [x] Implement event sharing and collaboration
  - [x] Add event analytics and insights
- [x] Create event creation pages and navigation (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
  - [x] Create `/events/create` page with event creation wizard
  - [x] Create `/events/templates` page for event templates
  - [x] Create `/events/{id}/edit` page for event editing
  - [x] Create `/events/{id}/versions` page for version history
  - [x] Add event creation navigation and breadcrumbs
  - [x] Implement event creation routing and state management
  - [x] Add event creation page metadata and SEO
  - [x] Create event creation sharing and collaboration

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for user context)
- **Story 2.2**: Contractor onboarding (for contractor data)
- **Story 2.3**: Profile management system (for profile data)
- **Story 2.4**: User verification workflow (for verified contractors)
- **Story 3.1**: Contractor directory display (for contractor data)
- **Story 3.2**: Advanced search & filtering (for search integration)
- **Story 3.3**: Contractor profile pages (for profile integration)
- **Story 3.4**: Search analytics & optimization (for analytics integration)
- **Story 4.1**: Interactive map implementation (for location services)
- **Story 4.2**: Map clustering & interaction (for map interactions)
- **Story 4.3**: Proximity filtering & search (for location services)
- **Story 4.4**: Basic admin features (for admin functionality)

The event creation wizard will use the existing contractor data, search systems, and location services to provide intelligent event planning.

### Data Models

[Source: architecture/data-models.md#user]
The event creation system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**Event Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `event_type` TEXT NOT NULL
- `title` TEXT NOT NULL
- `description` TEXT
- `event_date` TIMESTAMP WITH TIME ZONE NOT NULL
- `duration_hours` INTEGER
- `attendee_count` INTEGER
- `location` JSON
- `budget_total` DECIMAL(10,2)
- `status` event_status DEFAULT 'draft'
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**EventTemplate Table (to be created):**

- `id` UUID PRIMARY KEY
- `name` TEXT NOT NULL
- `event_type` TEXT NOT NULL
- `template_data` JSON NOT NULL
- `is_public` BOOLEAN DEFAULT FALSE
- `created_by` UUID REFERENCES users(id)
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**EventVersion Table (to be created):**

- `id` UUID PRIMARY KEY
- `event_id` UUID REFERENCES events(id) ON DELETE CASCADE
- `version_number` INTEGER NOT NULL
- `changes` JSON NOT NULL
- `created_by` UUID REFERENCES users(id)
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#event-endpoints]
The event creation system will implement the following API endpoints:

**Event Management:**

- `POST /api/events`
  - Body: `{ event_type, title, description, event_date, duration_hours, attendee_count, location, budget_total }`
  - Response: `{ event: Event, success: boolean }`

- `GET /api/events`
  - Query: `{ user_id?, status?, page?, limit? }`
  - Response: `{ events: Event[], total: number, page: number, limit: number }`

- `GET /api/events/{id}`
  - Response: `{ event: Event, versions: EventVersion[] }`

- `PUT /api/events/{id}`
  - Body: `{ event_type?, title?, description?, event_date?, duration_hours?, attendee_count?, location?, budget_total? }`
  - Response: `{ event: Event, success: boolean }`

**Event Templates:**

- `GET /api/events/templates`
  - Query: `{ event_type?, is_public? }`
  - Response: `{ templates: EventTemplate[] }`

- `POST /api/events/templates`
  - Body: `{ name, event_type, template_data, is_public? }`
  - Response: `{ template: EventTemplate, success: boolean }`

**Event Drafts:**

- `POST /api/events/drafts`
  - Body: `{ event_data: Partial<Event> }`
  - Response: `{ draft: EventDraft, success: boolean }`

- `GET /api/events/drafts`
  - Query: `{ user_id? }`
  - Response: `{ drafts: EventDraft[] }`

**Event Versions:**

- `GET /api/events/{id}/versions`
  - Response: `{ versions: EventVersion[] }`

- `POST /api/events/{id}/versions`
  - Body: `{ changes: JSON }`
  - Response: `{ version: EventVersion, success: boolean }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The event creation system will use the following components:

**Event Creation Components:**

- `EventCreationWizard` - Main 4-step event creation wizard
- `EventBasicsStep` - Step 1: Event basics form
- `ServiceRequirementsStep` - Step 2: Service requirements
- `BudgetPlanningStep` - Step 3: Budget planning
- `EventReviewStep` - Step 4: Review and submit
- `ProgressBar` - Wizard progress indicator
- `EventTemplates` - Pre-built event templates
- `EventDraftManager` - Draft management
- `EventVersionHistory` - Version history display
- `EventFormValidation` - Form validation
- `EventLocationInput` - Location input with Mapbox
- `EventDatePicker` - Date and time selection
- `EventTypeSelector` - Event type selection
- `ServiceCategorySelector` - Service category selection
- `BudgetInput` - Budget input and recommendations
- `ContractorMatchingResults` - Contractor matching display

**Wizard Features:**

- 4-step guided process with progress bar
- Form validation and error handling
- Draft saving and auto-save
- Pre-built event templates
- AI-powered service suggestions
- Budget planning and recommendations
- Contractor matching integration
- Change tracking and version history

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/events/create/page.tsx` - Event creation wizard page
- `app/events/templates/page.tsx` - Event templates page
- `app/events/[id]/edit/page.tsx` - Event editing page
- `app/events/[id]/versions/page.tsx` - Version history page
- `components/features/events/` - Event components
- `components/features/events/EventCreationWizard.tsx` - Main wizard
- `components/features/events/EventBasicsStep.tsx` - Step 1
- `components/features/events/ServiceRequirementsStep.tsx` - Step 2
- `components/features/events/BudgetPlanningStep.tsx` - Step 3
- `components/features/events/EventReviewStep.tsx` - Step 4
- `components/features/events/ProgressBar.tsx` - Progress bar
- `components/features/events/EventTemplates.tsx` - Templates
- `components/features/events/EventDraftManager.tsx` - Draft management
- `components/features/events/EventVersionHistory.tsx` - Version history
- `components/features/events/EventFormValidation.tsx` - Form validation
- `components/features/events/EventLocationInput.tsx` - Location input
- `components/features/events/EventDatePicker.tsx` - Date picker
- `components/features/events/EventTypeSelector.tsx` - Type selector
- `components/features/events/ServiceCategorySelector.tsx` - Service selector
- `components/features/events/BudgetInput.tsx` - Budget input
- `components/features/events/ContractorMatchingResults.tsx` - Matching results
- `lib/events/` - Event utilities and services
- `lib/events/event-service.ts` - Event service
- `lib/events/template-service.ts` - Template service
- `lib/events/draft-service.ts` - Draft service
- `lib/events/version-service.ts` - Version service
- `hooks/useEventCreation.ts` - Event creation hook
- `stores/event-creation.ts` - Event creation state management

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Form Library**: React Hook Form with Zod validation
- **UI Library**: shadcn/ui with Tailwind CSS
- **State Management**: Zustand for event creation state
- **Validation**: Zod schemas for event data validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Security**: Secure event data handling and validation
- **Performance**: Optimized form rendering and validation
- **Accessibility**: WCAG 2.1 AA compliance for form interactions

### Event Creation Wizard

**Wizard Features:**

- 4-step guided process with clear navigation
- Progress bar showing current step and completion
- Form validation with real-time feedback
- Draft saving and auto-save functionality
- Pre-built event templates with customization
- AI-powered service suggestions
- Budget planning with intelligent recommendations
- Contractor matching integration

**Wizard Implementation:**

```typescript
// Example wizard state management
interface EventCreationWizardState {
  currentStep: number;
  eventData: Partial<Event>;
  serviceRequirements: ServiceRequirement[];
  budgetPlan: BudgetPlan;
  contractorMatches: ContractorMatch[];
  isDraft: boolean;
  validationErrors: ValidationError[];
  nextStep: () => void;
  previousStep: () => void;
  updateEventData: (data: Partial<Event>) => void;
  saveDraft: () => Promise<void>;
  submitEvent: () => Promise<void>;
}
```

### Event Templates

**Template Features:**

- Pre-built templates for common event types
- Template customization and personalization
- Template saving and sharing
- Template discovery and recommendations
- Template version management
- Template analytics and usage tracking

**Template Implementation:**

- Wedding templates with service categories
- Corporate event templates
- Party and celebration templates
- Custom template creation
- Template sharing and collaboration
- Template validation and error handling

### Form Validation

**Validation Features:**

- Real-time form validation with Zod schemas
- Field-level validation with error messages
- Step-level validation before progression
- Event data validation and sanitization
- Location validation with Mapbox
- Date and time validation
- Budget validation and warnings

**Validation Implementation:**

- Zod schemas for each wizard step
- Real-time validation feedback
- Error message display and handling
- Form submission validation
- Data sanitization and cleaning

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for event components
- **API Testing**: Jest + Supertest for event endpoints
- **E2E Testing**: Playwright for complete event creation flows
- **Form Testing**: Test form validation and submission
- **Wizard Testing**: Test wizard navigation and state management
- **Test File Location**: `__tests__/events/` directory
- **Test Scenarios**: Event creation, template usage, form validation, wizard navigation, draft saving
- **Coverage Requirements**: 80% coverage for event logic and components

### Performance Considerations

**Event Creation Performance:**

- Optimized form rendering and validation
- Efficient wizard state management
- Draft auto-save optimization
- Template loading and caching
- Contractor matching performance
- Mobile performance optimization

**Data Management:**

- Event data caching and persistence
- Draft data management
- Template data caching
- Version history optimization
- Real-time updates optimization

### State Management

[Source: architecture/components.md#state-management-architecture]
**Event Creation State Management:**

```typescript
interface EventCreationStore {
  currentStep: number;
  eventData: Partial<Event>;
  serviceRequirements: ServiceRequirement[];
  budgetPlan: BudgetPlan;
  contractorMatches: ContractorMatch[];
  templates: EventTemplate[];
  drafts: EventDraft[];
  isDraft: boolean;
  isLoading: boolean;
  validationErrors: ValidationError[];
  nextStep: () => void;
  previousStep: () => void;
  updateEventData: (data: Partial<Event>) => void;
  addServiceRequirement: (requirement: ServiceRequirement) => void;
  removeServiceRequirement: (id: string) => void;
  updateBudgetPlan: (plan: BudgetPlan) => void;
  loadTemplates: (eventType?: string) => Promise<void>;
  loadDrafts: () => Promise<void>;
  saveDraft: () => Promise<void>;
  submitEvent: () => Promise<void>;
  validateStep: (step: number) => boolean;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (via Cursor)

### Debug Log References

- Event creation wizard implementation completed
- API routes created for event management
- UI components built with comprehensive testing
- Database schema extended with event-related tables

### Completion Notes List

- ✅ Created comprehensive API routes for event CRUD operations
- ✅ Built 4-step event creation wizard with progress tracking
- ✅ Implemented event templates system with pre-built templates
- ✅ Added draft saving and auto-save functionality
- ✅ Created event editing and version history features
- ✅ Built contractor matching system integration
- ✅ Added comprehensive form validation and error handling
- ✅ Created responsive UI components with accessibility features
- ✅ Implemented state management with Zustand
- ✅ Added comprehensive test coverage for components and API routes
- ✅ Created database migration for event-related tables
- ✅ Extended TypeScript types for event management

### File List

**API Routes:**

- `app/api/events/route.ts` - Main events CRUD endpoint
- `app/api/events/[id]/route.ts` - Individual event management
- `app/api/events/templates/route.ts` - Event templates management
- `app/api/events/drafts/route.ts` - Draft management
- `app/api/events/[id]/versions/route.ts` - Version history
- `app/api/events/[id]/notifications/route.ts` - Event notifications
- `app/api/events/[id]/matching/route.ts` - Contractor matching

**UI Components:**

- `components/features/events/EventCreationWizard.tsx` - Main wizard component
- `components/features/events/EventBasicsStep.tsx` - Step 1: Event basics
- `components/features/events/ServiceRequirementsStep.tsx` - Step 2: Services
- `components/features/events/BudgetPlanningStep.tsx` - Step 3: Budget
- `components/features/events/EventReviewStep.tsx` - Step 4: Review
- `components/features/events/ProgressBar.tsx` - Progress indicator
- `components/features/events/EventTemplates.tsx` - Template selector
- `components/features/events/EventTypeSelector.tsx` - Event type picker
- `components/features/events/EventDatePicker.tsx` - Date/time picker
- `components/features/events/EventLocationInput.tsx` - Location input
- `components/features/events/ServiceCategorySelector.tsx` - Service picker
- `components/features/events/EventEditForm.tsx` - Event editing form
- `components/features/events/EventVersionHistory.tsx` - Version history

**Pages:**

- `app/events/create/page.tsx` - Event creation page
- `app/events/templates/page.tsx` - Templates page
- `app/events/[id]/edit/page.tsx` - Event editing page
- `app/events/[id]/versions/page.tsx` - Version history page

**State Management:**

- `stores/event-creation.ts` - Event creation store
- `hooks/useEventCreation.ts` - Event creation hook
- `hooks/useEventManagement.ts` - Event management hook

**Types:**

- `types/events.ts` - Event-related TypeScript types

**Database:**

- `supabase/migrations/011_event_creation_tables.sql` - Event tables migration
- `types/database.ts` - Updated database types

**Tests:**

- `__tests__/events/event-creation-wizard.test.tsx` - Wizard component tests
- `__tests__/events/api/events.test.ts` - API route tests
- `__tests__/events/stores/event-creation.test.ts` - Store tests

**UI Components (New):**

- `components/ui/popover.tsx` - Popover component
- `components/ui/calendar.tsx` - Calendar component
- `components/ui/alert.tsx` - Alert component
- `components/ui/separator.tsx` - Separator component

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

The Event Creation Wizard implementation demonstrates high-quality software engineering practices with comprehensive functionality, robust architecture, and strong security measures. All 11 acceptance criteria are fully implemented with appropriate test coverage. The codebase follows modern React patterns, uses TypeScript effectively, and implements proper state management with Zustand.

**Key Strengths:**

- Clean separation of concerns with dedicated components for each wizard step
- Comprehensive input validation using Zod schemas
- Robust security implementation with authentication, authorization, and RLS policies
- Well-structured state management with proper error handling
- Comprehensive test coverage for components, stores, and API routes
- Proper database design with appropriate indexing and constraints

### Refactoring Performed

No critical refactoring was required. The implementation is well-structured and follows best practices. Minor improvements identified for future consideration:

- **File**: `app/api/events/drafts/route.ts`
  - **Change**: Consider adding rate limiting
  - **Why**: Prevent potential abuse of draft save operations
  - **How**: Implement rate limiting middleware for better security

### Compliance Check

- Coding Standards: ✓ Excellent adherence to TypeScript and React best practices
- Project Structure: ✓ Follows documented component hierarchy and file organization
- Testing Strategy: ✓ Comprehensive test coverage with Jest + React Testing Library
- All ACs Met: ✓ All 11 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Verified comprehensive API route implementation
- [x] Confirmed robust form validation and error handling
- [x] Validated security measures and authentication
- [x] Reviewed test coverage and quality
- [ ] Consider adding rate limiting to draft save operations
- [ ] Add E2E tests for complete wizard flow
- [ ] Implement accessibility testing for form interactions
- [ ] Consider adding analytics tracking for wizard completion rates

### Security Review

**Status: PASS**

Comprehensive security implementation including:

- Proper user authentication and authorization checks
- Role-based access control (event_manager role required)
- Input validation using Zod schemas
- SQL injection protection via Supabase client
- XSS protection through React's built-in mechanisms
- Row Level Security (RLS) policies for all database tables
- Proper error handling without information leakage

### Performance Considerations

**Status: PASS**

Well-optimized implementation with:

- Efficient database queries with proper indexing
- Optimized state management using Zustand
- Debounced auto-save (2s) and interval save (30s)
- Proper component rendering optimization
- Efficient API design with appropriate pagination

### Files Modified During Review

No files were modified during this review. The implementation is production-ready.

### Gate Status

Gate: **PASS** → docs/qa/gates/5.1-event-creation-wizard.yml
Risk profile: Medium risk with comprehensive mitigation
NFR assessment: All non-functional requirements met

### Recommended Status

✓ **Ready for Done** - All acceptance criteria implemented with high quality and comprehensive test coverage. Minor technical debt items are non-blocking and can be addressed in future iterations.
