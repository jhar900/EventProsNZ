# Story 2.2: Contractor Onboarding

## Status

Draft

## Story

**As a** contractor,  
**I want** to create a comprehensive business profile,  
**so that** event managers can discover and contact me for services.

## Acceptance Criteria

1. Step 1: Personal information collection (name, email, phone, location with Mapbox autocomplete)
2. Step 2: Business information (company name, business address with Mapbox autocomplete, business registration (NZBN - optional), description, service areas, social media links)
3. Step 3: Services and pricing (service types, pricing ranges, availability)
4. Step 4: Portfolio upload (past events, YouTube video link, photos, testimonials)
5. Profile completion tracking and status updates
6. Explanation of profile approval process + tour of dashboard
7. Business verification workflow
8. Service area mapping and coverage definition
9. Manual approval process with admin email notification

## Tasks / Subtasks

- [ ] Create contractor onboarding API routes (AC: 1, 2, 3, 4, 5, 7, 9)
  - [ ] Implement `/api/onboarding/contractor/step1` endpoint for personal information
  - [ ] Implement `/api/onboarding/contractor/step2` endpoint for business information
  - [ ] Implement `/api/onboarding/contractor/step3` endpoint for services and pricing
  - [ ] Implement `/api/onboarding/contractor/step4` endpoint for portfolio upload
  - [ ] Implement `/api/onboarding/contractor/complete` endpoint for profile completion
  - [ ] Implement `/api/onboarding/contractor/submit` endpoint for admin approval
  - [ ] Add proper validation and error handling for each step
- [ ] Build contractor onboarding UI components (AC: 1, 2, 3, 4, 6, 8)
  - [ ] Create `ContractorOnboardingWizard` component with step navigation
  - [ ] Create `PersonalInfoForm` component for Step 1
  - [ ] Create `BusinessInfoForm` component for Step 2
  - [ ] Create `ServicesPricingForm` component for Step 3
  - [ ] Create `PortfolioUploadForm` component for Step 4
  - [ ] Create `ServiceAreaMapping` component for coverage definition
  - [ ] Create `ApprovalProcessExplanation` component for Step 6
  - [ ] Add form validation and progress tracking
- [ ] Integrate Mapbox for address and service area mapping (AC: 1, 2, 8)
  - [ ] Set up Mapbox client configuration for contractors
  - [ ] Create `AddressAutocomplete` component for business address
  - [ ] Create `ServiceAreaSelector` component for coverage mapping
  - [ ] Implement service area validation and visualization
  - [ ] Add location search and selection functionality
- [ ] Implement portfolio upload system (AC: 4)
  - [ ] Create portfolio photo upload API endpoints
  - [ ] Implement YouTube video link validation and embedding
  - [ ] Create testimonial upload and management system
  - [ ] Add portfolio item organization and ordering
  - [ ] Implement file validation and size limits for photos
- [ ] Set up services and pricing management (AC: 3)
  - [ ] Create service types selection interface
  - [ ] Implement pricing range input and validation
  - [ ] Add availability calendar integration
  - [ ] Create service category management
  - [ ] Add pricing display and formatting
- [ ] Implement business verification workflow (AC: 7, 9)
  - [ ] Create business verification status tracking
  - [ ] Implement admin notification system for new contractors
  - [ ] Add verification criteria validation
  - [ ] Create verification status display and updates
  - [ ] Add manual approval process integration
- [ ] Create contractor onboarding pages and navigation (AC: 6)
  - [ ] Create `/onboarding/contractor` page with wizard
  - [ ] Create `/onboarding/contractor/submitted` approval pending page
  - [ ] Create `/onboarding/contractor/tutorial` tutorial page
  - [ ] Add onboarding navigation and progress indicators
  - [ ] Implement contractor-specific onboarding flow routing
- [ ] Set up profile completion tracking (AC: 5)
  - [ ] Create profile completion status management
  - [ ] Implement completion progress indicators
  - [ ] Add profile completeness validation
  - [ ] Create completion status notifications
  - [ ] Add profile completion analytics
- [ ] Implement social media links management (AC: 2)
  - [ ] Create social media links input interface
  - [ ] Add social media platform validation
  - [ ] Implement link preview and verification
  - [ ] Add social media link management
  - [ ] Create social media integration display

## Dev Notes

### Previous Story Insights

This story builds on:

- **Story 1.1**: Project setup with Next.js and Supabase integration
- **Story 1.2**: Database schema with user tables and role management
- **Story 1.3**: Authentication system with role-based access
- **Story 1.4**: Basic user management with admin functionality
- **Story 1.5**: Basic UI framework and navigation
- **Story 2.1**: Event manager onboarding (for shared components and patterns)

The contractor onboarding will use the existing authentication system and database schema to create comprehensive business profiles with service information and portfolio management.

### Data Models

[Source: architecture/data-models.md#user]
The contractor onboarding system will work with the following data models:

**User Table:**

- `id` UUID (references auth.users)
- `email` TEXT UNIQUE NOT NULL
- `role` user_role ENUM ('event_manager', 'contractor', 'admin')
- `is_verified` BOOLEAN DEFAULT FALSE
- `last_login` TIMESTAMP WITH TIME ZONE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
- `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Profile Table:**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `first_name` TEXT NOT NULL
- `last_name` TEXT NOT NULL
- `phone` TEXT
- `address` TEXT
- `profile_photo_url` TEXT
- `bio` TEXT
- `preferences` JSON

**BusinessProfile Table (required for contractors):**

- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `company_name` TEXT NOT NULL
- `business_address` TEXT
- `nzbn` TEXT
- `description` TEXT
- `service_areas` TEXT[]
- `social_links` JSON
- `is_verified` BOOLEAN DEFAULT FALSE
- `verification_date` TIMESTAMP WITH TIME ZONE

**Portfolio Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `title` TEXT NOT NULL
- `description` TEXT
- `image_url` TEXT
- `video_url` TEXT
- `event_date` DATE
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

**Service Table (to be created):**

- `id` UUID PRIMARY KEY
- `user_id` UUID REFERENCES users(id) ON DELETE CASCADE
- `service_type` TEXT NOT NULL
- `description` TEXT
- `price_range_min` DECIMAL(10,2)
- `price_range_max` DECIMAL(10,2)
- `availability` TEXT
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

### API Specifications

[Source: architecture/api-specification.md#user-management]
The contractor onboarding system will implement the following API endpoints:

**Onboarding Steps:**

- `POST /api/onboarding/contractor/step1`

  - Body: `{ first_name, last_name, phone, address }`
  - Response: `{ success: boolean, profile: Profile }`

- `POST /api/onboarding/contractor/step2`

  - Body: `{ company_name, business_address, nzbn, description, service_areas, social_links }`
  - Response: `{ success: boolean, business_profile: BusinessProfile }`

- `POST /api/onboarding/contractor/step3`

  - Body: `{ services: Service[], pricing_ranges: PricingRange[] }`
  - Response: `{ success: boolean, services: Service[] }`

- `POST /api/onboarding/contractor/step4`

  - Body: `{ portfolio_items: PortfolioItem[] }`
  - Response: `{ success: boolean, portfolio: PortfolioItem[] }`

- `POST /api/onboarding/contractor/submit`
  - Response: `{ success: boolean, status: 'pending_approval' }`

**Portfolio Management:**

- `POST /api/upload/portfolio-photo`

  - Body: `{ file: File }`
  - Response: `{ url: string, filename: string }`

- `POST /api/portfolio/validate-video`
  - Body: `{ video_url: string }`
  - Response: `{ valid: boolean, embed_url: string }`

### Component Specifications

[Source: architecture/components.md#feature-specific-components]
The contractor onboarding system will use the following components:

**Onboarding Components:**

- `ContractorOnboardingWizard` - Multi-step contractor onboarding flow
- `PersonalInfoForm` - Personal information collection form
- `BusinessInfoForm` - Business information form
- `ServicesPricingForm` - Services and pricing form
- `PortfolioUploadForm` - Portfolio upload and management
- `ServiceAreaMapping` - Service area selection and mapping
- `ApprovalProcessExplanation` - Approval process explanation and tutorial
- `AddressAutocomplete` - Mapbox-integrated address input
- `ProgressIndicator` - Onboarding progress tracking

**Portfolio Components:**

- `PortfolioUpload` - Portfolio item upload interface
- `VideoLinkValidator` - YouTube video link validation
- `TestimonialUpload` - Testimonial upload and management
- `PortfolioPreview` - Portfolio item preview and organization

**Form Features:**

- React Hook Form integration with Zod validation
- Real-time validation and error display
- Step-by-step navigation with progress saving
- Responsive design with Tailwind CSS
- Accessibility features (ARIA labels, keyboard navigation)

### File Locations

[Source: architecture/components.md#component-hierarchy]
Based on the project structure guide:

- `app/onboarding/contractor/page.tsx` - Contractor onboarding page
- `app/onboarding/contractor/submitted/page.tsx` - Approval pending page
- `app/onboarding/contractor/tutorial/page.tsx` - Contractor tutorial page
- `components/features/onboarding/contractor/` - Contractor onboarding components
- `components/features/onboarding/contractor/ContractorOnboardingWizard.tsx` - Main wizard
- `components/features/onboarding/contractor/BusinessInfoForm.tsx` - Business info form
- `components/features/onboarding/contractor/ServicesPricingForm.tsx` - Services form
- `components/features/onboarding/contractor/PortfolioUploadForm.tsx` - Portfolio form
- `components/features/onboarding/contractor/ServiceAreaMapping.tsx` - Service area mapping
- `components/features/portfolio/` - Portfolio management components
- `lib/onboarding/contractor.ts` - Contractor onboarding service
- `lib/onboarding/portfolio.ts` - Portfolio management service
- `lib/onboarding/validation.ts` - Onboarding validation schemas
- `hooks/useContractorOnboarding.ts` - Contractor onboarding hook
- `stores/contractor-onboarding.ts` - Contractor onboarding state

### Technical Constraints

[Source: architecture/tech-stack.md + architecture/security.md]

- **Authentication**: Supabase Auth with JWT tokens
- **File Upload**: Supabase Storage for portfolio photos
- **Address Integration**: Mapbox API for address and service area mapping
- **Video Integration**: YouTube API for video validation and embedding
- **Validation**: Client-side with React Hook Form + Zod, server-side validation
- **Error Handling**: Comprehensive error types and user-friendly messages
- **Performance**: Optimized file uploads with image compression
- **Security**: Secure file uploads with validation and sanitization

### Mapbox Integration

[Source: architecture/maps/mapbox-config.ts]
**Mapbox Features:**

- Address autocomplete for business addresses
- Service area mapping and visualization
- Location search and selection
- Address validation and formatting
- Geocoding and reverse geocoding
- Service coverage area definition

**Implementation:**

```typescript
// Example service area mapping
interface ServiceAreaMappingProps {
  serviceAreas: string[];
  onChange: (areas: string[]) => void;
  coverageType: "regions" | "nationwide";
}
```

### Portfolio Management

**Portfolio Features:**

- Photo upload with image optimization
- YouTube video link validation and embedding
- Testimonial upload and management
- Portfolio item organization and ordering
- Event date tracking and display
- Portfolio preview and management

**File Upload Specifications:**

- Supported formats: JPG, PNG, WebP
- Maximum file size: 5MB per image
- Image optimization: Automatic compression and resizing
- Video validation: YouTube URL validation and embed generation

### Testing

[Source: architecture/testing.md#testing-strategy]
**Testing Standards:**

- **Component Testing**: Jest + React Testing Library for onboarding components
- **API Testing**: Jest + Supertest for onboarding endpoints
- **E2E Testing**: Playwright for complete onboarding flows
- **File Upload Testing**: Test portfolio photo upload and validation
- **Video Testing**: Test YouTube video link validation
- **Test File Location**: `__tests__/onboarding/contractor/` directory
- **Test Scenarios**: Step-by-step onboarding, form validation, file uploads, service area mapping
- **Coverage Requirements**: 80% coverage for contractor onboarding logic and components

### Onboarding Flow

**Step-by-Step Process:**

1. **Personal Information**: Name, email, phone, location with Mapbox autocomplete
2. **Business Information**: Company name, address, NZBN, description, service areas, social links
3. **Services and Pricing**: Service types, pricing ranges, availability
4. **Portfolio Upload**: Past events, YouTube videos, photos, testimonials
5. **Submission**: Profile submission for admin approval
6. **Approval Process**: Explanation and dashboard tour
7. **Verification**: Business verification workflow

**Business Logic:**

- Contractors require manual approval by admin
- Business information is mandatory for contractors
- Service area mapping with nationwide option
- Portfolio upload with multiple media types
- Admin email notification for new contractor submissions

### State Management

[Source: architecture/components.md#state-management-architecture]
**Contractor Onboarding State Management:**

```typescript
interface ContractorOnboardingStore {
  currentStep: number;
  totalSteps: number;
  profileData: Partial<Profile>;
  businessProfileData: Partial<BusinessProfile>;
  servicesData: Service[];
  portfolioData: PortfolioItem[];
  isSubmitted: boolean;
  approvalStatus: "pending" | "approved" | "rejected";
  setCurrentStep: (step: number) => void;
  updateProfileData: (data: Partial<Profile>) => void;
  updateBusinessProfileData: (data: Partial<BusinessProfile>) => void;
  updateServicesData: (services: Service[]) => void;
  updatePortfolioData: (portfolio: PortfolioItem[]) => void;
  submitForApproval: () => Promise<void>;
  resetOnboarding: () => void;
}
```

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-09-22 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
